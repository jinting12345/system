<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ± (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        h2 { margin: 0; color: #2c3e50; font-size: 1.2em; }
        .role-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; vertical-align: middle; }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e4e6eb; cursor: pointer; border-radius: 8px; font-weight: bold; color: #65676b; white-space: nowrap; transition: 0.2s; font-size: 0.95em; }
        .tab-btn.active { background: #1a73e8; color: white; box-shadow: 0 2px 4px rgba(26,115,232,0.3); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Controls (æœå°‹å€) */
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-input, .category-select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; /* é˜²æ­¢ iOS æ”¾å¤§ */ }
        .search-input { flex: 2; min-width: 200px; }
        .category-select { flex: 1; min-width: 140px; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; width: 100%; margin-top: 5px; }
        .action-btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9em; transition: 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        
        .btn-in { background: #34c759; } 
        .btn-out { background: #ff3b30; } 
        .btn-import { background: #007aff; } 
        .btn-export { background: #5856d6; } 
        .btn-stocktake { background: #ff9500; } 
        .btn-detail { background: #007aff; width: 100%; margin-top: 5px; } /* æ‰‹æ©Ÿç‰ˆè©³æƒ…æŒ‰éˆ•æ»¿ç‰ˆ */

        .admin-only { display: none; }

        /* RWD è¡¨æ ¼è½‰å¡ç‰‡ (æ ¸å¿ƒé­”æ³•) */
        table { width: 100%; border-collapse: collapse; }
        
        @media (max-width: 768px) {
            /* éš±è—åŸæœ¬çš„è¡¨é ­ */
            thead { display: none; }
            
            /* å°‡æ¯ä¸€åˆ—è®Šæˆå¡ç‰‡ */
            tr { display: block; background: white; border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; }
            
            /* æ¯å€‹å„²å­˜æ ¼è®Šä¸€è¡Œ */
            td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; text-align: right; }
            td:last-child { border-bottom: none; padding-bottom: 0; flex-direction: column; gap: 10px; }
            
            /* åˆ©ç”¨ data-label å±¬æ€§é¡¯ç¤ºæ¬„ä½åç¨± */
            td::before { content: attr(data-label); font-weight: bold; color: #888; text-align: left; margin-right: 15px; font-size: 0.9em; }
            
            /* ç‰¹åˆ¥æ¨£å¼èª¿æ•´ */
            .qty-cell { font-size: 1.4em !important; }
            .action-btn { width: 100%; padding: 12px; }
            
            /* èª¿æ•´æ§åˆ¶å€ */
            .controls { flex-direction: column; }
            .search-input, .category-select { width: 100%; }
        }

        @media (min-width: 769px) {
            /* é›»è…¦ç‰ˆç¶­æŒè¡¨æ ¼æ¨£å¼ */
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
            th { background: #f8f9fa; color: #555; font-weight: bold; white-space: nowrap; }
            tr:hover { background-color: #f8f9fa; }
            .btn-group { width: auto; }
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; color: white; font-weight: bold; display: inline-block; }
        .bg-ok { background: #34c759; }
        .bg-warn { background: #ff9500; }
        .bg-danger { background: #ff3b30; }
        .bg-urgent { background: #ff3b30; animation: pulse 2s infinite; }
        .bg-cat { background: #8e8e93; font-size: 0.85em; }

        .date-cell { font-family: Consolas, monospace; color: #555; }
        .qty-cell { font-size: 1.1em; color: #007aff; font-weight: 800; }
        .qty-zero { color: #ccc; font-weight: normal; }

        /* Modal å„ªåŒ– */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: flex-end; /* æ‰‹æ©Ÿç‰ˆå¾ä¸‹æ–¹æ»‘å‡º */ z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        
        @media (min-width: 769px) {
            .modal { align-items: center; }
            .modal-content { border-radius: 12px; width: 90%; }
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* è©³ç´°æ¸…å–® */
        .batch-list { list-style: none; padding: 0; margin-top: 15px; }
        .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 8px; background: #fafafa; }
        .batch-info { display: flex; flex-direction: column; gap: 4px; }
        .batch-actions { display: flex; gap: 8px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        
        .modal-footer { display: flex; gap: 10px; margin-top: 25px; }
        .modal-footer button { flex: 1; padding: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-top">
            <h2>ğŸ“¦ åº«å­˜ç®¡ç† <span id="roleLabel"></span></h2>
            <a href="menu.html" class="back-btn">â¬… é¸å–®</a>
        </div>
        <div style="font-size:13px; color:#888;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š åº«å­˜åˆ—è¡¨</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ é€²å‡ºç´€éŒ„</button>
    </div>

    <div id="stock" class="tab-content active">
        <div class="controls">
            <select id="categoryFilter" class="category-select" onchange="renderTable()">
                <option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>
            </select>

            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="renderTable()">
            
            <div class="btn-group">
                <input type="file" id="excel_input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelImport(this)">
                <button class="action-btn btn-import admin-only" onclick="document.getElementById('excel_input').click()">ğŸ“‚ åŒ¯å…¥</button>
                <button class="action-btn btn-in admin-only" style="background:#007bff;" onclick="openNewItemModal()">â• æ–°å¢</button>
                <button class="action-btn btn-stocktake" onclick="downloadBlankForm()">ğŸ“„ ç›¤é»è¡¨</button>
                <button class="action-btn btn-export" onclick="exportStock()">ğŸ“¥ ç¸½è¡¨</button>
            </div>
        </div>
        
        <table id="stockTable">
            <thead>
                <tr>
                    <th width="15%">åˆ†é¡</th>
                    <th width="25%">å“å</th>
                    <th width="10%">ç¸½åº«å­˜</th>
                    <th width="8%">å–®ä½</th>
                    <th width="20%">æœ€è¿‘æ•ˆæœŸ</th>
                    <th width="12%">ç‹€æ…‹</th>
                    <th width="10%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="stockBody"></tbody>
        </table>
    </div>

    <div id="logs" class="tab-content">
        <div class="controls" style="flex-direction: row; justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">ç•°å‹•ç´€éŒ„</h3>
            <button class="action-btn btn-export" style="width: auto;" onclick="exportLogs()">ğŸ“¥ ä¸‹è¼‰</button>
        </div>
        <table id="logTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th> <th>å‹•ä½œ</th> <th>å“å</th> <th>é‡</th> <th>æ•ˆæœŸ</th> <th>äºº</th> <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="detailTitle" style="margin-top:0; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">å“é …è©³æƒ…</h3>
        
        <div style="max-height: 40vh; overflow-y: auto;">
            <ul id="batchList" class="batch-list"></ul>
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <h4 style="margin:0 0 10px 0;">â• æ–°æ•ˆæœŸå…¥åº«</h4>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <input type="date" id="newBatchDate" style="flex: 2; padding: 10px;">
                <input type="number" id="newBatchQty" placeholder="æ•¸é‡" style="flex: 1; padding: 10px; min-width: 60px;">
                <button class="action-btn btn-in" style="flex: 1;" onclick="addNewBatch()">å…¥åº«</button>
            </div>
        </div>

        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('detailModal')">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="actionModal" class="modal">
    <div class="modal-content">
        <h3 id="actionTitle" style="margin-top:0;">åŸ·è¡Œå‹•ä½œ</h3>
        
        <div class="form-group">
            <label>å“å</label>
            <input type="text" id="actName" disabled style="background:#f5f5f5; border-color: transparent;">
        </div>
        <div class="form-group">
            <label>æ•ˆæœŸ</label>
            <input type="text" id="actDate" disabled style="background:#f5f5f5; border-color: transparent;">
        </div>
        <div class="form-group">
            <label>æ•¸é‡</label>
            <input type="number" id="actQty" placeholder="è«‹è¼¸å…¥æ•¸é‡" inputmode="numeric">
        </div>
        <div class="form-group">
            <label>å‚™è¨»</label>
            <input type="text" id="actNote" placeholder="ä¾‹å¦‚: ç—…æˆ¿é ˜ç”¨">
        </div>

        <input type="hidden" id="actId">
        <input type="hidden" id="actType">
        <input type="hidden" id="actCurrentQty">

        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('actionModal')">å–æ¶ˆ</button>
            <button class="action-btn" id="confirmBtn" onclick="submitAction()">ç¢ºèª</button>
        </div>
    </div>
</div>

<div id="newItemModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">âœ¨ æ–°å¢å“é …</h3>
        <div class="form-group"><label>åˆ†é¡</label><input type="text" id="newCat" placeholder="ä¾‹: ç³–å°¿ç—…é…æ–¹"></div>
        <div class="form-group"><label>å“å</label><input type="text" id="newItemName" placeholder="ç”¢å“åç¨±"></div>
        <div class="form-group"><label>å–®ä½</label><input type="text" id="newUnit" placeholder="ä¾‹: ç½"></div>
        <div class="form-group"><label>æ•ˆæœŸ</label><input type="date" id="newItemDate"></div>
        <div class="form-group"><label>æ•¸é‡</label><input type="number" id="newItemQty" inputmode="numeric"></div>

        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('newItemModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-in" onclick="submitNewItem()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
</div>

<script>
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    let rawInventory = [];
    let groupedInventory = [];
    let currentUser = '';
    let isAdmin = false;
    let currentDetailItemName = '';

    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;

        await checkUserRole();
        loadInventory();
        loadLogs();
    })();

    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUser).single();
        const roleLabel = document.getElementById('roleLabel');
        if (data && data.role === 'admin') {
            isAdmin = true;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            roleLabel.innerHTML = '<span class="role-badge" style="background:#ff3b30;">Admin</span>';
        } else {
            isAdmin = false;
            roleLabel.innerHTML = '<span class="role-badge" style="background:#34c759;">User</span>';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>';
        
        const { data, error } = await supabase.from('inventory').select('*').order('expiry_date', { ascending: true });
        if(error) { alert("è®€å–å¤±æ•—"); return; }
        
        rawInventory = data || [];
        groupData(rawInventory);
        updateCategoryFilter();
        renderTable();
    }

    function groupData(data) {
        const groups = {};
        data.forEach(item => {
            const name = item.name;
            if (!groups[name]) {
                groups[name] = { name: name, category: item.category, unit: item.unit, totalQty: 0, batches: [] };
            }
            groups[name].totalQty += item.quantity;
            groups[name].batches.push(item);
        });
        groupedInventory = Object.values(groups).sort((a, b) => {
            const catA = a.category || 'zzz';
            const catB = b.category || 'zzz';
            return catA.localeCompare(catB) || a.name.localeCompare(b.name);
        });
    }

    function updateCategoryFilter() {
        const select = document.getElementById('categoryFilter');
        const currentVal = select.value;
        const categories = [...new Set(groupedInventory.map(i => i.category || 'æœªåˆ†é¡'))].sort();
        select.innerHTML = '<option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>';
        categories.forEach(cat => select.innerHTML += `<option value="${cat}">${cat}</option>`);
        select.value = currentVal;
    }

    function renderTable() {
        const tbody = document.getElementById('stockBody');
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filterCat = document.getElementById('categoryFilter').value;
        const today = new Date();

        tbody.innerHTML = '';
        const filtered = groupedInventory.filter(group => {
            const matchText = group.name.toLowerCase().includes(searchText);
            const matchCat = filterCat === 'ALL' || group.category === filterCat;
            return matchText && matchCat;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">æŸ¥ç„¡è³‡æ–™</td></tr>';
            return;
        }

        filtered.forEach(group => {
            const validBatches = group.batches.filter(b => b.expiry_date);
            const nearestBatch = validBatches.length > 0 ? validBatches[0] : null;
            
            let dateDisplay = 'ç„¡æ•ˆæœŸ';
            let statusBadge = '<span class="badge bg-ok">æ­£å¸¸</span>';
            
            if (nearestBatch) {
                dateDisplay = nearestBatch.expiry_date;
                const diffDays = Math.ceil((new Date(nearestBatch.expiry_date) - today) / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) statusBadge = '<span class="badge bg-danger">å·²éæœŸ</span>';
                else if (diffDays <= 30) statusBadge = '<span class="badge bg-urgent">ğŸš¨ 30å¤©</span>';
                else if (diffDays <= 90) statusBadge = '<span class="badge bg-warn">3å€‹æœˆ</span>';
            }

            const tr = document.createElement('tr');
            const qtyClass = group.totalQty === 0 ? 'qty-zero' : 'qty-cell';
            
            // æ‰‹æ©Ÿç‰ˆä½¿ç”¨ data-label é¡¯ç¤ºæ¨™é¡Œ
            tr.innerHTML = `
                <td data-label="åˆ†é¡"><span class="badge bg-cat">${group.category || 'æœªåˆ†é¡'}</span></td>
                <td data-label="å“å" style="font-weight:bold; font-size:1.1em;">${group.name}</td>
                <td data-label="ç¸½åº«å­˜" class="${qtyClass}">${group.totalQty}</td>
                <td data-label="å–®ä½">${group.unit || 'ç½'}</td>
                <td data-label="æœ€è¿‘æ•ˆæœŸ" class="date-cell">${dateDisplay}</td>
                <td data-label="ç‹€æ…‹">${statusBadge}</td>
                <td data-label="æ“ä½œ">
                    <button class="action-btn btn-detail" onclick="openDetailModal('${group.name}')">è©³æƒ… / é ˜è£œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function openDetailModal(itemName) {
        const group = groupedInventory.find(g => g.name === itemName);
        if (!group) return;

        currentDetailItemName = itemName;
        document.getElementById('detailTitle').innerText = `${itemName}`;
        const list = document.getElementById('batchList');
        list.innerHTML = '';

        const sortedBatches = group.batches.sort((a, b) => {
            if (!a.expiry_date) return 1;
            if (!b.expiry_date) return -1;
            return new Date(a.expiry_date) - new Date(b.expiry_date);
        });

        sortedBatches.forEach(batch => {
            const dateStr = batch.expiry_date || 'ç„¡æ•ˆæœŸ';
            const days = batch.expiry_date ? (new Date(batch.expiry_date) - new Date()) / (1000 * 60 * 60 * 24) : 999;
            let icon = days < 0 ? 'ğŸ’€' : (days < 30 ? 'ğŸš¨' : 'ğŸ“…');
            
            const li = document.createElement('li');
            li.className = 'batch-item';
            if(batch.quantity === 0) li.style.opacity = '0.6';
            
            li.innerHTML = `
                <div class="batch-info">
                    <div style="font-weight:bold; color:#555;">${icon} ${dateStr}</div>
                    <div>æ•¸é‡ï¼š<strong style="font-size:1.2em; color:#007aff;">${batch.quantity}</strong> ${group.unit}</div>
                </div>
                <div class="batch-actions">
                    <button class="action-btn btn-in" style="padding:8px 12px;" onclick="openSingleAction('IN', '${batch.id}', '${batch.quantity}', '${dateStr}')">è£œ</button>
                    <button class="action-btn btn-out" style="padding:8px 12px;" onclick="openSingleAction('OUT', '${batch.id}', '${batch.quantity}', '${dateStr}')">é ˜</button>
                </div>
            `;
            list.appendChild(li);
        });
        document.getElementById('detailModal').style.display = 'flex';
    }

    async function addNewBatch() {
        const date = document.getElementById('newBatchDate').value;
        const qty = parseInt(document.getElementById('newBatchQty').value);
        if (!qty || qty <= 0) return alert("è«‹è¼¸å…¥æ•¸é‡");
        const group = groupedInventory.find(g => g.name === currentDetailItemName);
        
        if(!confirm(`ç¢ºèªæ–°å¢æ•ˆæœŸ ${date||'ç„¡'} çš„ ${currentDetailItemName}ï¼Ÿ`)) return;

        try {
            const { error } = await supabase.from('inventory').insert([{
                name: group.name, category: group.category, unit: group.unit, expiry_date: date || null, quantity: qty
            }]);
            if (error) throw error;
            await logAction('æ–°æ‰¹è™Ÿ', group.name, qty, qty, date, 'æ‰‹å‹•æ–°å¢');
            alert("âœ… æ–°å¢æˆåŠŸ");
            await loadInventory();
            openDetailModal(currentDetailItemName);
            document.getElementById('newBatchQty').value = '';
        } catch(e) { alert(e.message); }
    }

    function openSingleAction(type, id, currentQty, dateStr) {
        document.getElementById('actionModal').style.display = 'flex';
        document.getElementById('actId').value = id;
        document.getElementById('actType').value = type;
        document.getElementById('actCurrentQty').value = currentQty;
        document.getElementById('actDate').value = dateStr;
        document.getElementById('actName').value = currentDetailItemName;
        document.getElementById('actQty').value = '';
        document.getElementById('actNote').value = '';

        const title = document.getElementById('actionTitle');
        const btn = document.getElementById('confirmBtn');
        if (type === 'IN') { title.innerText = "â• è£œè²¨"; btn.className = "action-btn btn-in"; btn.innerText = "ç¢ºèªå…¥åº«"; } 
        else { title.innerText = "â– é ˜ç”¨"; btn.className = "action-btn btn-out"; btn.innerText = "ç¢ºèªé ˜ç”¨"; }
    }

    async function submitAction() {
        const id = document.getElementById('actId').value;
        const type = document.getElementById('actType').value;
        const inputQty = parseInt(document.getElementById('actQty').value);
        const currentQty = parseInt(document.getElementById('actCurrentQty').value);
        const note = document.getElementById('actNote').value;
        const name = document.getElementById('actName').value;
        const date = document.getElementById('actDate').value;

        if (!inputQty || inputQty <= 0) return alert("æ•¸é‡éŒ¯èª¤");
        let newQty = currentQty;
        if (type === 'IN') newQty += inputQty;
        else {
            if (currentQty < inputQty) return alert("åº«å­˜ä¸è¶³");
            newQty -= inputQty;
        }

        try {
            const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id);
            if (error) throw error;
            await logAction(type === 'IN' ? 'è£œè²¨' : 'é ˜ç”¨', name, inputQty, newQty, date, note);
            alert("âœ… æˆåŠŸ");
            closeModal('actionModal');
            await loadInventory();
            if (document.getElementById('detailModal').style.display !== 'none') openDetailModal(currentDetailItemName);
            loadLogs();
        } catch(e) { alert(e.message); }
    }

    function openNewItemModal() { document.getElementById('newItemModal').style.display = 'flex'; }
    
    async function submitNewItem() {
        const name = document.getElementById('newItemName').value.trim();
        const cat = document.getElementById('newCat').value.trim();
        const unit = document.getElementById('newUnit').value.trim();
        const date = document.getElementById('newItemDate').value;
        const qty = parseInt(document.getElementById('newItemQty').value);
        if(!name) return alert("å“åå¿…å¡«");

        try {
            const { error } = await supabase.from('inventory').insert([{
                name: name, category: cat || 'æœªåˆ†é¡', unit: unit || 'ç½', expiry_date: date || null, quantity: qty || 0
            }]);
            if(error) throw error;
            await logAction('å»ºæª”', name, qty, qty, date, 'æ–°å¢å“é …');
            alert("âœ… æˆåŠŸ");
            closeModal('newItemModal');
            loadInventory();
        } catch(e) { alert(e.message); }
    }

    async function logAction(action, name, change, final, expiry, note) {
        await supabase.from('inventory_logs').insert([{
            product_name: name, action_type: action, change_qty: change, final_qty: final, operator: currentUser, note: `æ•ˆæœŸ:${expiry||'-'} ${note}`
        }]);
    }

    async function handleExcelImport(input) {
        const file = input.files[0];
        if (!file) return;
        if (!confirm("âš ï¸ åŒ¯å…¥å°‡è‡ªå‹•æ¯”å°ã€Œå“å+æ•ˆæœŸã€æ›´æ–°åº«å­˜ï¼Œç¢ºå®šï¼Ÿ")) { input.value = ''; return; }
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let count = 0;
                for (let row of jsonData) {
                    let name = row['å“å'], qty = row['æ•¸é‡']||row['åº«å­˜'], expiry = formatExcelDate(row['æœ‰æ•ˆæ—¥æœŸ']), cat = row['åˆ†é¡'], unit = row['å–®ä½'];
                    if(!name || qty==null) continue;
                    let q = supabase.from('inventory').select('id').eq('name', name);
                    if(expiry) q = q.eq('expiry_date', expiry); else q = q.is('expiry_date', null);
                    const { data: ex } = await q;
                    if(ex && ex.length > 0) await supabase.from('inventory').update({ quantity: qty, category: cat, unit: unit }).eq('id', ex[0].id);
                    else await supabase.from('inventory').insert([{ name, quantity: qty, category: cat||'æœªåˆ†é¡', unit: unit||'ç½', expiry_date: expiry }]);
                    count++;
                }
                alert(`âœ… è™•ç† ${count} ç­†`); input.value = ''; loadInventory();
            } catch (err) { alert("åŒ¯å…¥å¤±æ•—: " + err.message); }
        };
        reader.readAsArrayBuffer(file);
    }

    function formatExcelDate(d) {
        if (!d) return null;
        if (typeof d === 'string') return d.trim();
        const date = new Date(Math.round((d - 25569) * 86400 * 1000));
        return date.toISOString().split('T')[0];
    }

    function downloadBlankForm() {
        if(groupedInventory.length === 0) return alert("ç„¡è³‡æ–™");
        const exportData = rawInventory.map(i => ({ "åˆ†é¡": i.category, "å“å": i.name, "åº«å­˜": "", "å–®ä½": i.unit, "æœ‰æ•ˆæ—¥æœŸ": i.expiry_date||"" }));
        exportData.sort((a,b) => a['åˆ†é¡'].localeCompare(b['åˆ†é¡']) || a['å“å'].localeCompare(b['å“å']));
        const ws = XLSX.utils.json_to_sheet(exportData);
        ws['!cols'] = [{wch:15}, {wch:25}, {wch:10}, {wch:8}, {wch:15}];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»å–®");
        XLSX.writeFile(wb, `ç©ºç™½ç›¤é»è¡¨.xlsx`);
    }

    function exportStock() {
        const exportData = rawInventory.map(i => ({ "åˆ†é¡": i.category, "å“å": i.name, "åº«å­˜": i.quantity, "å–®ä½": i.unit, "æ•ˆæœŸ": i.expiry_date||"ç„¡" }));
        exportData.sort((a,b) => a['åˆ†é¡'].localeCompare(b['åˆ†é¡']) || a['å“å'].localeCompare(b['å“å']));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜");
        XLSX.writeFile(wb, `åº«å­˜ç¸½è¡¨.xlsx`);
    }

    async function exportLogs() {
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', {ascending:false}).limit(1000);
        if(!data || data.length === 0) return alert("ç„¡ç´€éŒ„");
        const exportData = data.map(l => ({ "æ™‚é–“": new Date(l.created_at).toLocaleString(), "å‹•ä½œ": l.action_type, "å“å": l.product_name, "ç•°å‹•": l.change_qty, "å‚™è¨»": l.note, "äººå“¡": l.operator }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç´€éŒ„");
        XLSX.writeFile(wb, `ç´€éŒ„.xlsx`);
    }

    async function loadLogs() {
        const tbody = document.getElementById('logBody');
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', { ascending: false }).limit(50);
        if(!data) return;
        tbody.innerHTML = '';
        data.forEach(log => {
            const dateStr = new Date(log.created_at).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            const color = log.action_type.includes('å…¥') || log.action_type.includes('å¢') || log.action_type.includes('è£œ') ? '#34c759' : '#ff3b30';
            // æ‰‹æ©Ÿç‰ˆæ—¥èªŒä¹Ÿç”¨ data-label
            tbody.innerHTML += `<tr>
                <td data-label="æ™‚é–“">${dateStr}</td>
                <td data-label="å‹•ä½œ" style="color:${color};font-weight:bold;">${log.action_type}</td>
                <td data-label="å“å">${log.product_name}</td>
                <td data-label="ç•°å‹•">${log.change_qty}</td>
                <td data-label="æ•ˆæœŸ">${log.note.split('/')[0]||'-'}</td>
                <td data-label="äººå“¡">${log.operator.split('@')[0]}</td>
                <td data-label="å‚™è¨»" style="font-size:0.9em;color:#666;">${log.note.split('/')[1]||''}</td>
            </tr>`;
        });
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>

</body>
</html>
