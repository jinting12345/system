<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ± (è‡¨åºŠé ˜ç”¨ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; padding-bottom: 80px; } /* åº•éƒ¨ç•™ç™½çµ¦æ‡¸æµ®æŒ‰éˆ• */
        
        /* Header */
        .header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        h2 { margin: 0; color: #2c3e50; font-size: 1.2em; }
        .role-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; vertical-align: middle; }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #e4e6eb; cursor: pointer; border-radius: 8px; font-weight: bold; color: #65676b; white-space: nowrap; transition: 0.2s; }
        .tab-btn.active { background: #1a73e8; color: white; box-shadow: 0 2px 4px rgba(26,115,232,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Controls */
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-input, .category-select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .search-input { flex: 2; min-width: 150px; }
        .category-select { flex: 1; min-width: 120px; }

        /* Buttons */
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; width: 100%; margin-top: 5px; }
        .action-btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9em; transition: 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        
        .btn-in { background: #34c759; } 
        .btn-out { background: #ff3b30; } 
        .btn-import { background: #007aff; } 
        .btn-export { background: #5856d6; } 
        .btn-stocktake { background: #ff9500; } 
        .btn-detail { background: #007aff; color: white; padding: 6px 12px; font-size: 0.85em; border-radius: 6px; }

        /* ğŸ”¥ æ‡¸æµ®çµå¸³æŒ‰éˆ• (è³¼ç‰©è»Š) */
        .fab-checkout {
            position: fixed; bottom: 20px; right: 20px;
            background: #ff3b30; color: white;
            padding: 15px 25px; border-radius: 50px;
            font-weight: bold; font-size: 1.1em;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
            cursor: pointer; z-index: 900;
            display: none; /* æœ‰å‹¾é¸æ‰é¡¯ç¤º */
            align-items: center; gap: 10px;
            transition: transform 0.2s;
        }
        .fab-checkout:active { transform: scale(0.95); }

        .admin-only { display: none; }

        /* Table RWD */
        table { width: 100%; border-collapse: collapse; }
        .checkbox-cell { width: 40px; text-align: center; }
        .checkbox-cell input { width: 20px; height: 20px; cursor: pointer; }

        @media (max-width: 768px) {
            thead { display: none; }
            tr { display: block; background: white; border-radius: 12px; margin-bottom: 15px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; padding-left: 50px; /* ç•™çµ¦ checkbox */ }
            
            /* Checkbox åœ¨æ‰‹æ©Ÿç‰ˆçš„ä½ç½® */
            td.checkbox-cell { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); border: none; }
            
            td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; text-align: right; }
            td:last-child { border-bottom: none; flex-direction: column; gap: 10px; }
            td::before { content: attr(data-label); font-weight: bold; color: #888; text-align: left; margin-right: 15px; font-size: 0.9em; }
            
            .qty-cell { font-size: 1.4em !important; }
            .btn-detail { width: 100%; padding: 12px; }
        }

        @media (min-width: 769px) {
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
            th { background: #f8f9fa; color: #555; font-weight: bold; white-space: nowrap; }
            tr:hover { background-color: #f8f9fa; }
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; color: white; font-weight: bold; }
        .bg-ok { background: #34c759; }
        .bg-warn { background: #ff9500; }
        .bg-danger { background: #ff3b30; }
        .bg-urgent { background: #ff3b30; animation: pulse 2s infinite; }
        .bg-cat { background: #8e8e93; font-size: 0.85em; }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.6;} 100% {opacity:1;} }

        .date-cell { font-family: Consolas, monospace; color: #555; }
        .qty-cell { font-size: 1.1em; color: #007aff; font-weight: 800; }
        .qty-zero { color: #ccc; font-weight: normal; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @media (min-width: 769px) { .modal { align-items: center; } .modal-content { border-radius: 12px; width: 90%; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        .modal-footer { display: flex; gap: 10px; margin-top: 25px; }
        .modal-footer button { flex: 1; padding: 12px; }

        /* æ‰¹æ¬¡é ˜ç”¨æ¸…å–® */
        .checkout-list { list-style: none; padding: 0; margin-bottom: 20px; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; }
        .checkout-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .checkout-item input { width: 60px; padding: 5px; text-align: center; font-weight: bold; color: #ff3b30; }
        
        /* è©³æƒ…é æ¨£å¼ */
        .batch-list { list-style: none; padding: 0; margin-top: 10px; }
        .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 0.95em; }
        .batch-actions button { padding: 5px 10px; font-size: 0.85em; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-top">
            <h2>ğŸ“¦ åº«å­˜ç®¡ç† <span id="roleLabel"></span></h2>
            <a href="menu.html" class="back-btn">â¬… é¸å–®</a>
        </div>
        <div style="font-size:13px; color:#888;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š ç¸½åº«å­˜åˆ—è¡¨</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ é€²å‡ºç´€éŒ„</button>
    </div>

    <div id="stock" class="tab-content active">
        <div class="controls">
            <select id="categoryFilter" class="category-select" onchange="renderTable()">
                <option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>
            </select>
            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="renderTable()">
            
            <div class="btn-group">
                <input type="file" id="excel_input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelImport(this)">
                <button class="action-btn btn-import admin-only" onclick="document.getElementById('excel_input').click()">ğŸ“‚ åŒ¯å…¥</button>
                <button class="action-btn btn-in admin-only" style="background:#007bff;" onclick="openNewItemModal()">â• æ–°å¢</button>
                <button class="action-btn btn-stocktake" onclick="downloadBlankForm()">ğŸ“„ ç›¤é»è¡¨</button>
                <button class="action-btn btn-export" onclick="exportStock()">ğŸ“¥ ç¸½è¡¨</button>
            </div>
        </div>
        
        <table id="stockTable">
            <thead>
                <tr>
                    <th width="40">é¸</th>
                    <th width="15%">åˆ†é¡</th>
                    <th width="25%">å“å</th>
                    <th width="10%">ç¸½åº«å­˜</th>
                    <th width="8%">å–®ä½</th>
                    <th width="20%">æœ€è¿‘æ•ˆæœŸ</th>
                    <th width="12%">ç‹€æ…‹</th>
                    <th width="10%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="stockBody"></tbody>
        </table>
    </div>

    <div id="logs" class="tab-content">
        <div class="controls" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0;">æœ€è¿‘ 50 ç­†ç•°å‹•</h3>
            <button class="action-btn btn-export" style="width: auto;" onclick="exportLogs()">ğŸ“¥ ä¸‹è¼‰</button>
        </div>
        <table id="logTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th> <th>å‹•ä½œ</th> <th>å“å</th> <th>é‡</th> <th>æ•ˆæœŸ</th> <th>äºº</th> <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<div id="fabCheckout" class="fab-checkout" onclick="openBatchCheckoutModal()">
    <i class="fas fa-shopping-cart"></i> ä¸€éµé ˜ç”¨ (<span id="selectedCount">0</span>)
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="detailTitle" style="margin-top:0; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;"></h3>
        <div style="max-height: 35vh; overflow-y: auto;">
            <ul id="batchList" class="batch-list"></ul>
        </div>

        <div style="margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <h4 style="margin:0 0 10px 0; color:#28a745;">â• å…¥åº«è£œè²¨ (å¯æ”¹æ—¥æœŸ)</h4>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <input type="date" id="newBatchDate" style="flex: 2; padding: 10px;">
                <input type="number" id="newBatchQty" placeholder="æ•¸é‡" style="flex: 1; padding: 10px; min-width: 60px;">
                <button class="action-btn btn-in" style="flex: 1;" onclick="addNewBatch()">å…¥åº«</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('detailModal')">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="batchCheckoutModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#ff3b30;">ğŸ›’ æ‰¹æ¬¡é ˜ç”¨ç¢ºèª</h3>
        
        <div class="form-group">
            <label>1. ç¢ºèªé ˜ç”¨æ•¸é‡ (è‡ªå‹•æ‰£é™¤æœ€æ—©æ•ˆæœŸ)</label>
            <ul id="checkoutList" class="checkout-list"></ul>
        </div>

        <div class="form-group">
            <label>2. é ˜ç”¨äºº / ç¶“æ‰‹äºº <span style="color:red;">*</span></label>
            <input type="text" id="batchRecipient" placeholder="è«‹è¼¸å…¥å§“å">
        </div>
        <div class="form-group">
            <label>3. ç—…æ­·è™Ÿ / ç”¨é€” <span style="color:red;">*</span></label>
            <input type="text" id="batchNote" placeholder="ä¾‹å¦‚: 123456 (ç‹å°æ˜)">
        </div>

        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('batchCheckoutModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-out" onclick="submitBatchCheckout()">ç¢ºèªé ˜å‡º</button>
        </div>
    </div>
</div>

<div id="newItemModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">âœ¨ æ–°å¢å“é …</h3>
        <div class="form-group"><label>åˆ†é¡</label><input type="text" id="newCat" placeholder="ä¾‹: ç³–å°¿ç—…é…æ–¹"></div>
        <div class="form-group"><label>å“å</label><input type="text" id="newItemName" placeholder="ç”¢å“åç¨±"></div>
        <div class="form-group"><label>å–®ä½</label><input type="text" id="newUnit" placeholder="ä¾‹: ç½"></div>
        <div class="form-group"><label>æ•ˆæœŸ</label><input type="date" id="newItemDate"></div>
        <div class="form-group"><label>æ•¸é‡</label><input type="number" id="newItemQty"></div>
        <div class="modal-footer">
            <button class="action-btn" style="background:#e4e6eb; color:#333;" onclick="closeModal('newItemModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-in" onclick="submitNewItem()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
</div>

<script>
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    let rawInventory = [];
    let groupedInventory = [];
    let currentUser = '';
    let isAdmin = false;
    let currentDetailItemName = '';
    let selectedItems = new Set(); // å­˜æ”¾å‹¾é¸çš„å“å

    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;
        await checkUserRole();
        loadInventory();
        loadLogs();
        
        // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('newBatchDate').value = today;
        document.getElementById('newItemDate').value = today;
    })();

    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUser).single();
        const roleLabel = document.getElementById('roleLabel');
        if (data && data.role === 'admin') {
            isAdmin = true;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            roleLabel.innerHTML = '<span class="role-badge" style="background:#ff3b30;">Admin</span>';
        } else {
            isAdmin = false;
            roleLabel.innerHTML = '<span class="role-badge" style="background:#34c759;">User</span>';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>';
        
        const { data, error } = await supabase.from('inventory').select('*').order('expiry_date', { ascending: true });
        if(error) { alert("è®€å–å¤±æ•—"); return; }
        
        rawInventory = data || [];
        groupData(rawInventory);
        updateCategoryFilter();
        renderTable();
    }

    function groupData(data) {
        const groups = {};
        data.forEach(item => {
            const name = item.name;
            if (!groups[name]) {
                groups[name] = { name: name, category: item.category, unit: item.unit, totalQty: 0, batches: [] };
            }
            groups[name].totalQty += item.quantity;
            groups[name].batches.push(item);
        });
        groupedInventory = Object.values(groups).sort((a, b) => {
            const catA = a.category || 'zzz';
            const catB = b.category || 'zzz';
            return catA.localeCompare(catB) || a.name.localeCompare(b.name);
        });
    }

    function updateCategoryFilter() {
        const select = document.getElementById('categoryFilter');
        const currentVal = select.value;
        const categories = [...new Set(groupedInventory.map(i => i.category || 'æœªåˆ†é¡'))].sort();
        select.innerHTML = '<option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>';
        categories.forEach(cat => select.innerHTML += `<option value="${cat}">${cat}</option>`);
        select.value = currentVal;
    }

    function renderTable() {
        const tbody = document.getElementById('stockBody');
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filterCat = document.getElementById('categoryFilter').value;
        const today = new Date();

        tbody.innerHTML = '';
        const filtered = groupedInventory.filter(group => {
            const matchText = group.name.toLowerCase().includes(searchText);
            const matchCat = filterCat === 'ALL' || group.category === filterCat;
            return matchText && matchCat;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">æŸ¥ç„¡è³‡æ–™</td></tr>';
            return;
        }

        filtered.forEach(group => {
            const validBatches = group.batches.filter(b => b.expiry_date);
            const nearestBatch = validBatches.length > 0 ? validBatches[0] : null;
            
            let dateDisplay = 'ç„¡æ•ˆæœŸ';
            let statusBadge = '<span class="badge bg-ok">æ­£å¸¸</span>';
            
            if (nearestBatch) {
                dateDisplay = nearestBatch.expiry_date;
                const diffDays = Math.ceil((new Date(nearestBatch.expiry_date) - today) / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) statusBadge = '<span class="badge bg-danger">å·²éæœŸ</span>';
                else if (diffDays <= 30) statusBadge = '<span class="badge bg-urgent">ğŸš¨ 30å¤©</span>';
                else if (diffDays <= 90) statusBadge = '<span class="badge bg-warn">3å€‹æœˆ</span>';
            }

            const tr = document.createElement('tr');
            const qtyClass = group.totalQty === 0 ? 'qty-zero' : 'qty-cell';
            const isChecked = selectedItems.has(group.name) ? 'checked' : '';
            
            // Checkbox é‚è¼¯
            const checkboxHtml = `<input type="checkbox" class="item-check" value="${group.name}" ${isChecked} onchange="toggleSelection('${group.name}', this)">`;

            tr.innerHTML = `
                <td class="checkbox-cell">${checkboxHtml}</td>
                <td data-label="åˆ†é¡"><span class="badge bg-cat">${group.category || 'æœªåˆ†é¡'}</span></td>
                <td data-label="å“å" style="font-weight:bold; font-size:1.1em;">${group.name}</td>
                <td data-label="ç¸½åº«å­˜" class="${qtyClass}">${group.totalQty}</td>
                <td data-label="å–®ä½">${group.unit || 'ç½'}</td>
                <td data-label="æœ€è¿‘æ•ˆæœŸ" class="date-cell">${dateDisplay}</td>
                <td data-label="ç‹€æ…‹">${statusBadge}</td>
                <td data-label="æ“ä½œ">
                    <button class="action-btn btn-detail" onclick="openDetailModal('${group.name}')">è©³æƒ…/å…¥åº«</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        updateFab();
    }

    // ===========================================
    // ğŸ›’ è³¼ç‰©è»Š & é ˜ç”¨é‚è¼¯ (å…ˆé€²å…ˆå‡º)
    // ===========================================
    function toggleSelection(name, checkbox) {
        if (checkbox.checked) selectedItems.add(name);
        else selectedItems.delete(name);
        updateFab();
    }

    function updateFab() {
        const fab = document.getElementById('fabCheckout');
        const countSpan = document.getElementById('selectedCount');
        if (selectedItems.size > 0) {
            fab.style.display = 'flex';
            countSpan.innerText = selectedItems.size;
        } else {
            fab.style.display = 'none';
        }
    }

    function openBatchCheckoutModal() {
        const list = document.getElementById('checkoutList');
        list.innerHTML = '';
        
        selectedItems.forEach(name => {
            const group = groupedInventory.find(g => g.name === name);
            if (!group) return;
            const li = document.createElement('li');
            li.className = 'checkout-item';
            li.innerHTML = `
                <span>${name} <span style="font-size:0.8em; color:#666;">(åº«å­˜: ${group.totalQty} ${group.unit})</span></span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="number" class="batch-out-qty" data-name="${name}" value="1" min="1" max="${group.totalQty}">
                    <span>${group.unit}</span>
                </div>
            `;
            list.appendChild(li);
        });

        document.getElementById('batchRecipient').value = '';
        document.getElementById('batchNote').value = '';
        document.getElementById('batchCheckoutModal').style.display = 'flex';
    }

    async function submitBatchCheckout() {
        const recipient = document.getElementById('batchRecipient').value.trim();
        const note = document.getElementById('batchNote').value.trim();
        if (!recipient || !note) return alert("è«‹å¡«å¯«é ˜ç”¨äººèˆ‡ç”¨é€” (ç—…æ­·è™Ÿ)");

        const inputs = document.querySelectorAll('.batch-out-qty');
        let transactions = [];

        // 1. æº–å‚™äº¤æ˜“è³‡æ–™ (è¨ˆç®—å…ˆé€²å…ˆå‡º)
        for (let input of inputs) {
            const name = input.dataset.name;
            const qtyNeeded = parseInt(input.value);
            if (qtyNeeded <= 0) continue;

            const group = groupedInventory.find(g => g.name === name);
            if (qtyNeeded > group.totalQty) return alert(`${name} åº«å­˜ä¸è¶³ï¼`);

            // ä¾ç…§æ•ˆæœŸæ’åº (NULL è¦–ç‚ºæœ€é )
            const sortedBatches = group.batches.sort((a, b) => {
                if (!a.expiry_date) return 1; 
                if (!b.expiry_date) return -1;
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });

            let remaining = qtyNeeded;
            for (let batch of sortedBatches) {
                if (remaining <= 0) break;
                if (batch.quantity <= 0) continue;

                let deduct = Math.min(batch.quantity, remaining);
                transactions.push({
                    id: batch.id,
                    newQty: batch.quantity - deduct,
                    change: deduct,
                    name: name,
                    expiry: batch.expiry_date || 'ç„¡'
                });
                remaining -= deduct;
            }
        }

        if (transactions.length === 0) return alert("ç„¡æœ‰æ•ˆé ˜ç”¨æ•¸é‡");
        if (!confirm("ç¢ºå®šè¦åŸ·è¡Œé ˜ç”¨å—ï¼Ÿ")) return;

        // 2. åŸ·è¡Œæ‰£åº«å­˜
        try {
            for (let t of transactions) {
                const { error } = await supabase.from('inventory').update({ quantity: t.newQty }).eq('id', t.id);
                if (error) throw error;
                
                // å¯«å…¥ç´€éŒ„ (åŒ…å«é ˜ç”¨äººèˆ‡ç”¨é€”)
                await logAction('é ˜ç”¨', t.name, t.change, t.newQty, t.expiry, `é ˜ç”¨:${recipient}, ç”¨é€”:${note}`);
            }
            
            alert("âœ… é ˜ç”¨æˆåŠŸ");
            selectedItems.clear();
            closeModal('batchCheckoutModal');
            loadInventory();
            loadLogs();
        } catch(e) {
            alert("äº¤æ˜“å¤±æ•—ï¼š" + e.message);
        }
    }

    // ===========================================
    // ğŸ“¦ å…¥åº«èˆ‡è©³æƒ…
    // ===========================================
    function openDetailModal(itemName) {
        const group = groupedInventory.find(g => g.name === itemName);
        if (!group) return;
        currentDetailItemName = itemName;
        document.getElementById('detailTitle').innerText = `${itemName}`;
        const list = document.getElementById('batchList');
        list.innerHTML = '';

        const sortedBatches = group.batches.sort((a, b) => {
            if (!a.expiry_date) return 1;
            if (!b.expiry_date) return -1;
            return new Date(a.expiry_date) - new Date(b.expiry_date);
        });

        sortedBatches.forEach(batch => {
            const dateStr = batch.expiry_date || 'ç„¡æ•ˆæœŸ';
            const days = batch.expiry_date ? (new Date(batch.expiry_date) - new Date()) / (1000 * 60 * 60 * 24) : 999;
            let icon = days < 0 ? 'ğŸ’€' : (days < 30 ? 'ğŸš¨' : 'ğŸ“…');
            
            const li = document.createElement('li');
            li.className = 'batch-item';
            if(batch.quantity === 0) li.style.opacity = '0.6';
            
            li.innerHTML = `
                <div class="batch-info">
                    <div style="font-weight:bold; color:#555;">${icon} ${dateStr}</div>
                    <div>æ•¸é‡ï¼š<strong style="font-size:1.2em; color:#007aff;">${batch.quantity}</strong> ${group.unit}</div>
                </div>
            `;
            list.appendChild(li);
        });
        document.getElementById('detailModal').style.display = 'flex';
    }

    async function addNewBatch() {
        const date = document.getElementById('newBatchDate').value;
        const qty = parseInt(document.getElementById('newBatchQty').value);
        if (!qty || qty <= 0) return alert("è«‹è¼¸å…¥æ•¸é‡");
        const group = groupedInventory.find(g => g.name === currentDetailItemName);
        
        if(!confirm(`ç¢ºèªæ–°å¢æ•ˆæœŸ ${date||'ç„¡'} çš„ ${currentDetailItemName}ï¼Ÿ`)) return;

        try {
            const { error } = await supabase.from('inventory').insert([{
                name: group.name, category: group.category, unit: group.unit, expiry_date: date || null, quantity: qty
            }]);
            if (error) throw error;
            await logAction('å…¥åº«', group.name, qty, qty, date, 'æ‰‹å‹•è£œè²¨');
            alert("âœ… å…¥åº«æˆåŠŸ");
            await loadInventory();
            openDetailModal(currentDetailItemName);
            document.getElementById('newBatchQty').value = '';
        } catch(e) { alert(e.message); }
    }

    function openNewItemModal() { document.getElementById('newItemModal').style.display = 'flex'; }
    
    async function submitNewItem() {
        const name = document.getElementById('newItemName').value.trim();
        const cat = document.getElementById('newCat').value.trim();
        const unit = document.getElementById('newUnit').value.trim();
        const date = document.getElementById('newItemDate').value;
        const qty = parseInt(document.getElementById('newItemQty').value);
        if(!name) return alert("å“åå¿…å¡«");

        try {
            const { error } = await supabase.from('inventory').insert([{
                name: name, category: cat || 'æœªåˆ†é¡', unit: unit || 'ç½', expiry_date: date || null, quantity: qty || 0
            }]);
            if(error) throw error;
            await logAction('å»ºæª”', name, qty, qty, date, 'æ–°å¢å“é …');
            alert("âœ… æˆåŠŸ");
            closeModal('newItemModal');
            loadInventory();
        } catch(e) { alert(e.message); }
    }

    async function logAction(action, name, change, final, expiry, note) {
        await supabase.from('inventory_logs').insert([{
            product_name: name, action_type: action, change_qty: change, final_qty: final, operator: currentUser, note: `æ•ˆæœŸ:${expiry||'-'} ${note}`
        }]);
    }

    // åŒ¯å…¥èˆ‡ä¸‹è¼‰ç›¸é—œ (ä¿æŒä¸è®Š)
    async function handleExcelImport(input) {
        const file = input.files[0];
        if (!file) return;
        if (!confirm("âš ï¸ åŒ¯å…¥å°‡è‡ªå‹•æ¯”å°ã€Œå“å+æ•ˆæœŸã€æ›´æ–°åº«å­˜ï¼Œç¢ºå®šï¼Ÿ")) { input.value = ''; return; }
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let count = 0;
                for (let row of jsonData) {
                    let name = row['å“å'], qty = row['æ•¸é‡']||row['åº«å­˜'], expiry = formatExcelDate(row['æœ‰æ•ˆæ—¥æœŸ']), cat = row['åˆ†é¡'], unit = row['å–®ä½'];
                    if(!name || qty==null) continue;
                    let q = supabase.from('inventory').select('id').eq('name', name);
                    if(expiry) q = q.eq('expiry_date', expiry); else q = q.is('expiry_date', null);
                    const { data: ex } = await q;
                    if(ex && ex.length > 0) await supabase.from('inventory').update({ quantity: qty, category: cat, unit: unit }).eq('id', ex[0].id);
                    else await supabase.from('inventory').insert([{ name, quantity: qty, category: cat||'æœªåˆ†é¡', unit: unit||'ç½', expiry_date: expiry }]);
                    count++;
                }
                alert(`âœ… è™•ç† ${count} ç­†`); input.value = ''; loadInventory();
            } catch (err) { alert("åŒ¯å…¥å¤±æ•—: " + err.message); }
        };
        reader.readAsArrayBuffer(file);
    }
    function formatExcelDate(d) {
        if (!d) return null; if (typeof d === 'string') return d.trim();
        const date = new Date(Math.round((d - 25569) * 86400 * 1000));
        return date.toISOString().split('T')[0];
    }
    function downloadBlankForm() {
        if(groupedInventory.length === 0) return alert("ç„¡è³‡æ–™");
        const exportData = rawInventory.map(i => ({ "åˆ†é¡": i.category, "å“å": i.name, "åº«å­˜": "", "å–®ä½": i.unit, "æœ‰æ•ˆæ—¥æœŸ": i.expiry_date||"" }));
        exportData.sort((a,b) => a['åˆ†é¡'].localeCompare(b['åˆ†é¡']) || a['å“å'].localeCompare(b['å“å']));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»å–®"); XLSX.writeFile(wb, `ç©ºç™½ç›¤é»è¡¨.xlsx`);
    }
    function exportStock() {
        const exportData = rawInventory.map(i => ({ "åˆ†é¡": i.category, "å“å": i.name, "åº«å­˜": i.quantity, "å–®ä½": i.unit, "æ•ˆæœŸ": i.expiry_date||"ç„¡" }));
        exportData.sort((a,b) => a['åˆ†é¡'].localeCompare(b['åˆ†é¡']) || a['å“å'].localeCompare(b['å“å']));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜"); XLSX.writeFile(wb, `åº«å­˜ç¸½è¡¨.xlsx`);
    }
    async function exportLogs() {
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', {ascending:false}).limit(1000);
        if(!data || data.length === 0) return alert("ç„¡ç´€éŒ„");
        const exportData = data.map(l => ({ "æ™‚é–“": new Date(l.created_at).toLocaleString(), "å‹•ä½œ": l.action_type, "å“å": l.product_name, "ç•°å‹•": l.change_qty, "å‚™è¨»": l.note, "äººå“¡": l.operator }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ç´€éŒ„"); XLSX.writeFile(wb, `ç´€éŒ„.xlsx`);
    }
    async function loadLogs() {
        const tbody = document.getElementById('logBody');
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', { ascending: false }).limit(50);
        if(!data) return;
        tbody.innerHTML = '';
        data.forEach(log => {
            const dateStr = new Date(log.created_at).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            const color = log.action_type.includes('å…¥') || log.action_type.includes('å¢') || log.action_type.includes('è£œ') ? '#34c759' : '#ff3b30';
            tbody.innerHTML += `<tr><td data-label="æ™‚é–“">${dateStr}</td><td data-label="å‹•ä½œ" style="color:${color};font-weight:bold;">${log.action_type}</td><td data-label="å“å">${log.product_name}</td><td data-label="ç•°å‹•">${log.change_qty}</td><td data-label="æ•ˆæœŸ">${log.note.split('/')[0].replace('æ•ˆæœŸ:','')||'-'}</td><td data-label="äººå“¡">${log.operator.split('@')[0]}</td><td data-label="å‚™è¨»" style="font-size:0.9em;color:#666;">${log.note.split('/')[1]||''}</td></tr>`;
        });
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
