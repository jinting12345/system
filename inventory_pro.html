<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* åŸºç¤è¨­å®š */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 5px; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1100px; margin: 0 auto; padding-bottom: 120px; }
        
        /* é é¦– Header */
        .header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; gap: 5px; }
        h2 { margin: 0; color: #2c3e50; font-size: 1.2em; }
        
        /* åˆ†é æ¨™ç±¤ Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; background: #e4e6eb; padding: 3px; border-radius: 8px; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: transparent; cursor: pointer; border-radius: 6px; font-weight: bold; color: #65676b; transition: 0.2s; font-size: 0.95em; }
        .tab-btn.active { background: white; color: #1a73e8; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* æ§åˆ¶åˆ— Controls */
        .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-input { flex: 2; min-width: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .category-select { flex: 1; min-width: 90px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 5px; flex-wrap: wrap; width: 100%; margin-top: 5px; }
        .action-btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; gap: 4px; font-size: 0.85em; }
        .btn-in { background: #34c759; } 
        .btn-out { background: #ff3b30; } 
        .btn-import { background: #007aff; } 
        .btn-export { background: #5856d6; } 
        .btn-stocktake { background: #ff9500; } 
        .btn-lock { background: #6c757d; color: white; }
        .btn-lock.editing { background: #dc3545; }
        .admin-only { display: none; }

        /* é›»è…¦ç‰ˆè¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: bold; white-space: nowrap; font-size: 0.9em; }
        .qty-cell { font-size: 1.1em; color: #007aff; font-weight: 800; }
        .checkbox-cell { width: 30px; text-align: center; }
        .checkbox-cell input { width: 20px; height: 20px; }

        /* ç‹€æ…‹æ¨™ç±¤ Badge */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: white; font-weight: bold; display: inline-block; text-align: center; }
        .bg-green { background: #28a745; }
        .bg-blue { background: #17a2b8; } 
        .bg-yellow { background: #ffc107; color: #333; }
        .bg-red { background: #dc3545; }
        .bg-cat { background: #8e8e93; color: white; margin-right: 4px; }

        /* ğŸ”¥ æ‰‹æ©Ÿç‰ˆï¼šç·Šæ¹Šæ¸…å–®æ¨¡å¼ (Mobile Compact List) ğŸ”¥ */
        @media (max-width: 768px) {
            thead { display: none; }
            tr { display: flex; flex-wrap: nowrap; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; background: white; }
            td { border: none; padding: 0; display: block; }
            
            /* æ‰‹æ©Ÿç‰ˆå„å€å¡Šå¯¬åº¦é…ç½® */
            .checkbox-cell { width: 30px; display: flex !important; justify-content: center; }
            .sort-cell { width: 30px; font-weight: bold; color: #888; font-size: 1.1em; text-align: center; display: block !important; }
            .main-content-cell { flex: 1; padding-left: 5px; padding-right: 5px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
            
            /* å…§å®¹æ’ç‰ˆ */
            .row-top { display: flex; align-items: center; margin-bottom: 2px; }
            .row-bottom { display: flex; align-items: center; font-size: 0.85em; color: #666; gap: 8px; }
            .name-text { font-weight: bold; font-size: 15px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            
            /* æ“ä½œèˆ‡éš±è— */
            .action-cell { width: auto; text-align: right; }
            .btn-detail { padding: 6px 10px; font-size: 13px; }
            .desktop-only-cell { display: none !important; }
        }
        @media (min-width: 769px) { .mobile-wrapper { display: none; } }

        /* æ‹–æ›³æŠŠæ‰‹ */
        .drag-handle { cursor: grab; color: #aaa; padding: 5px; display: none; }
        .is-editing .drag-handle { display: inline-block; }

        /* æ‡¸æµ®æŒ‰éˆ• FAB */
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 900; display: none; flex-direction: column; gap: 15px; align-items: flex-end; }
        .fab-main { background: linear-gradient(135deg, #007aff, #005ecb); color: white; padding: 12px 20px; border-radius: 50px; font-weight: bold; font-size: 1em; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4); cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .fab-clear { background: #ff3b30; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); cursor: pointer; font-size: 1.1em; }

        /* Modal å½ˆçª—æ¨£å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: flex-end; z-index: 1000; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 15px 15px 0 0; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        @media (min-width: 769px) { .modal { align-items: center; } .modal-content { border-radius: 12px; width: 90%; } }
        
        .checkout-list { list-style: none; padding: 0; margin-bottom: 15px; max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .checkout-item { padding: 10px; border-bottom: 1px solid #eee; background: white; }
        .checkout-item-top { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 15px; }
        .checkout-item-bottom { display: flex; gap: 5px; align-items: center; }
        .batch-select { flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; }
        .batch-qty-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 14px; }
        
        .search-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 15px; }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-top">
            <h2>ğŸ“¦ åº«å­˜ç®¡ç† <span id="roleLabel"></span></h2>
            <a href="menu.html" class="back-btn">â¬… é¸å–®</a>
        </div>
        <div style="font-size:12px; color:#888;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š ç¸½åº«å­˜</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ ç´€éŒ„</button>
    </div>

    <div id="stock" class="tab-content active">
        <div class="controls">
            <select id="categoryFilter" class="category-select" onchange="renderTable()">
                <option value="ALL">å…¨éƒ¨åˆ†é¡</option>
            </select>
            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="renderTable()">
            
            <div class="btn-group">
                <button id="editToggleBtn" class="action-btn btn-lock admin-only" onclick="toggleEditMode()">ğŸ”’ ç·¨è¼¯</button>
                <input type="file" id="excel_input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelImport(this)">
                <button class="action-btn btn-import admin-only" onclick="document.getElementById('excel_input').click()">ğŸ“‚ åŒ¯å…¥</button>
                <button class="action-btn btn-in admin-only" style="background:#007bff;" onclick="openNewItemModal()">â• æ–°å¢</button>
                <button class="action-btn btn-stocktake" onclick="downloadBlankForm()">ğŸ“„ ç›¤é»</button>
                <button class="action-btn btn-export" onclick="exportStock()">ğŸ“¥ å ±è¡¨</button>
            </div>
        </div>
        
        <table id="stockTable">
            <thead>
                <tr>
                    <th width="40">é¸</th>
                    <th width="50">æ’åº</th>
                    <th width="80">åˆ†é¡</th>
                    <th width="">å“å</th>
                    <th width="60">åº«å­˜</th>
                    <th width="90">æ•ˆæœŸ</th>
                    <th width="60">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="stockBody"></tbody>
        </table>
    </div>

    <div id="logs" class="tab-content">
        <div class="controls" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0; font-size: 1.1em;">ç•°å‹•ç´€éŒ„</h3>
            <button class="action-btn btn-export" style="width: auto;" onclick="exportLogs()">ğŸ“¥ ä¸‹è¼‰</button>
        </div>
        <table id="logTable">
            <thead>
                <tr><th>æ™‚é–“</th> <th>å‹•ä½œ</th> <th>å“å</th> <th>é‡</th> <th>äººå“¡</th></tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<div id="fabContainer" class="fab-container">
    <div class="fab-clear" onclick="clearSelection()" title="å–æ¶ˆ"><i class="fas fa-trash-alt"></i></div>
    <div class="fab-main" onclick="openBatchCheckoutModal()"><i class="fas fa-shopping-cart"></i> é ˜ç”¨ (<span id="selectedCount">0</span>)</div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="detailTitle" style="margin-top:0; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;"></h3>
        <div style="max-height: 30vh; overflow-y: auto;"><ul id="batchList" class="checkout-list"></ul></div>
        <div style="margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <h4 style="margin:0 0 10px 0; color:#28a745;">â• å…¥åº«è£œè²¨</h4>
            <div style="display: flex; gap: 8px;">
                <input type="date" id="newBatchDate" style="flex: 2;">
                <input type="number" id="newBatchQty" placeholder="æ•¸é‡" style="flex: 1;">
            </div>
            <button class="action-btn btn-in" style="width:100%; margin-top:10px;" onclick="addNewBatch()">ç¢ºèªå…¥åº«</button>
        </div>
        <div style="margin-top:20px; text-align:right;">
            <button class="action-btn" style="background:#eee; color:#333;" onclick="closeModal('detailModal')">é—œé–‰</button>
        </div>
    </div>
</div>

<div id="batchCheckoutModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#007aff;">ğŸ›’ é ˜ç”¨ç¢ºèª</h3>
        <div class="form-group" style="position:relative;">
            <label>åŠ é¸å…¶ä»–å“é …</label>
            <input type="text" id="itemSearchInput" placeholder="è¼¸å…¥é—œéµå­—..." onkeyup="searchItemToAdd()">
            <div id="searchResults" class="search-dropdown"></div>
        </div>
        <div class="form-group"><label>å·²é¸æ¸…å–® (å¯æŒ‡å®šæ•ˆæœŸ)</label><ul id="checkoutList" class="checkout-list"></ul></div>
        <div class="form-group"><label>é ˜ç”¨äºº</label><input type="text" id="batchRecipient"></div>
        <div class="form-group"><label>ç”¨é€”/ç—…æ­·è™Ÿ</label><input type="text" id="batchNote"></div>
        <div class="modal-footer" style="display:flex; gap:10px;">
            <button class="action-btn" style="background:#eee; color:#333; flex:1;" onclick="closeModal('batchCheckoutModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-out" style="flex:2;" onclick="submitBatchCheckout()">ç¢ºèªé ˜å‡º</button>
        </div>
    </div>
</div>

<div id="newItemModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">æ–°å¢å“é …</h3>
        <div class="form-group"><label>åˆ†é¡</label><input type="text" id="newCat"></div>
        <div class="form-group"><label>å“å</label><input type="text" id="newItemName"></div>
        <div class="form-group"><label>å–®ä½</label><input type="text" id="newUnit" placeholder="ç½"></div>
        <div class="form-group"><label>æ•ˆæœŸ</label><input type="date" id="newItemDate"></div>
        <div class="form-group"><label>æ•¸é‡</label><input type="number" id="newItemQty"></div>
        <div class="modal-footer">
            <button class="action-btn" style="background:#eee; color:#333;" onclick="closeModal('newItemModal')">å–æ¶ˆ</button>
            <button class="action-btn btn-in" onclick="submitNewItem()">æ–°å¢</button>
        </div>
    </div>
</div>

<script>
    // å­—ä¸²æ¸…ç†èˆ‡ Supabase åˆå§‹åŒ–
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    // å…¨åŸŸè®Šæ•¸
    let rawInventory = [];
    let groupedInventory = [];
    let currentUser = '';
    let isAdmin = false;
    let currentDetailItemName = '';
    let selectedItems = new Set();
    let isEditMode = false;
    let sortableInstance = null;

    // åˆå§‹åŒ–
    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;
        await checkUserRole();
        loadInventory();
        loadLogs();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('newBatchDate').value = today;
        document.getElementById('newItemDate').value = today;
    })();

    // æª¢æŸ¥æ¬Šé™
    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUser).single();
        isAdmin = (data && data.role === 'admin');
        if (isAdmin) {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            document.getElementById('roleLabel').innerHTML = '<span class="badge bg-red">Admin</span>';
        } else {
            document.getElementById('roleLabel').innerHTML = '<span class="badge bg-green">User</span>';
        }
    }

    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // ç·¨è¼¯æ¨¡å¼ (æ‹–æ›³æ’åº)
    function toggleEditMode() {
        isEditMode = !isEditMode;
        const btn = document.getElementById('editToggleBtn');
        const tbody = document.getElementById('stockBody');
        
        if (isEditMode) {
            btn.innerHTML = 'ğŸ”“ å®Œæˆ';
            btn.classList.add('editing');
            tbody.classList.add('is-editing');
            sortableInstance = Sortable.create(tbody, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: updateOrderAfterDrag
            });
        } else {
            btn.innerHTML = 'ğŸ”’ ç·¨è¼¯';
            btn.classList.remove('editing');
            tbody.classList.remove('is-editing');
            if (sortableInstance) sortableInstance.destroy();
        }
    }

    async function updateOrderAfterDrag() {
        const rows = document.querySelectorAll('#stockBody tr');
        let updates = [];
        rows.forEach((row, index) => {
            const name = row.dataset.name;
            const newOrder = index + 1;
            const group = groupedInventory.find(g => g.name === name);
            if(group && group.sortOrder !== newOrder) {
                group.sortOrder = newOrder;
                updates.push(name);
            }
        });
        for (let i = 0; i < updates.length; i++) {
            const group = groupedInventory.find(g => g.name === updates[i]);
            await supabase.from('inventory').update({ sort_order: group.sortOrder }).eq('name', updates[i]);
        }
    }

    // è®€å–åº«å­˜è³‡æ–™
    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</td></tr>';
        const { data, error } = await supabase.from('inventory').select('*').order('expiry_date', { ascending: true });
        if(error) { alert("è®€å–å¤±æ•—"); return; }
        rawInventory = data || [];
        groupData(rawInventory);
        updateCategoryFilter();
        renderTable();
    }

    // è³‡æ–™åˆ†çµ„ (åŒå“ååˆä½µ)
    function groupData(data) {
        const groups = {};
        data.forEach(item => {
            const name = item.name;
            if (!groups[name]) {
                groups[name] = { 
                    name: name, category: item.category, unit: item.unit, 
                    totalQty: 0, batches: [], sortOrder: item.sort_order || 999 
                };
            }
            groups[name].totalQty += item.quantity;
            groups[name].batches.push(item);
        });
        groupedInventory = Object.values(groups).sort((a, b) => (a.sortOrder - b.sortOrder));
    }

    function updateCategoryFilter() {
        const select = document.getElementById('categoryFilter');
        const currentVal = select.value;
        const categories = [...new Set(groupedInventory.map(i => i.category || 'æœªåˆ†é¡'))].sort();
        select.innerHTML = '<option value="ALL">å…¨éƒ¨åˆ†é¡</option>';
        categories.forEach(cat => select.innerHTML += `<option value="${cat}">${cat}</option>`);
        select.value = currentVal;
    }

    // æ¸²æŸ“è¡¨æ ¼ (æ”¯æ´æ‰‹æ©Ÿç·Šæ¹Šç‰ˆ)
    function renderTable() {
        const tbody = document.getElementById('stockBody');
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const filterCat = document.getElementById('categoryFilter').value;
        const today = new Date();

        tbody.innerHTML = '';
        const filtered = groupedInventory.filter(group => {
            const matchText = group.name.toLowerCase().includes(searchText);
            const matchCat = filterCat === 'ALL' || group.category === filterCat;
            return matchText && matchCat;
        });

        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">æŸ¥ç„¡è³‡æ–™</td></tr>'; return; }

        filtered.forEach(group => {
            const validBatches = group.batches.filter(b => b.expiry_date);
            const nearestBatch = validBatches.length > 0 ? validBatches[0] : null;
            let statusText = 'ç„¡æ•ˆæœŸ';
            let statusClass = 'bg-green';
            
            if (nearestBatch) {
                const dateStr = nearestBatch.expiry_date;
                const diffDays = Math.ceil((new Date(dateStr) - today) / (1000 * 60 * 60 * 24)); 
                if (diffDays < 0) { statusText = 'å·²éæœŸ'; statusClass = 'bg-red'; }
                else if (diffDays <= 30) { statusText = `å‰©${diffDays}å¤©`; statusClass = 'bg-yellow'; }
                else if (diffDays <= 60) { statusText = dateStr; statusClass = 'bg-blue'; }
                else { statusText = dateStr; statusClass = 'bg-green'; }
            } else { statusClass = 'bg-cat'; }

            const tr = document.createElement('tr');
            tr.dataset.name = group.name;
            const isChecked = selectedItems.has(group.name) ? 'checked' : '';
            
            tr.innerHTML = `
                <td class="checkbox-cell"><input type="checkbox" class="item-check" value="${group.name}" ${isChecked} onchange="toggleSelection('${group.name}', this)"></td>
                <td class="sort-cell"><i class="fas fa-bars drag-handle"></i><span>${group.sortOrder}</span></td>
                
                <td class="desktop-only-cell"><span class="badge bg-cat">${group.category}</span></td>
                <td class="desktop-only-cell" style="font-weight:bold;">${group.name}</td>
                <td class="desktop-only-cell qty-cell">${group.totalQty}</td>
                <td class="desktop-only-cell"><span class="badge ${statusClass}">${statusText}</span></td>
                
                <td class="main-content-cell mobile-wrapper">
                    <div class="row-top">
                        <span class="badge bg-cat" style="font-size:10px; padding:2px 4px;">${group.category}</span>
                        <span class="name-text">${group.name}</span>
                    </div>
                    <div class="row-bottom">
                         <span>åº«å­˜: <strong style="color:#007aff;">${group.totalQty}</strong></span>
                         <span class="badge ${statusClass}" style="transform:scale(0.9);">${statusText}</span>
                    </div>
                </td>
                
                <td class="action-cell">
                    <button class="action-btn btn-detail" onclick="openDetailModal('${group.name}')">è©³æƒ…</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        updateFab();
    }

    function toggleSelection(name, checkbox) {
        if (checkbox.checked) selectedItems.add(name); else selectedItems.delete(name);
        updateFab();
    }
    function clearSelection() {
        selectedItems.clear();
        document.querySelectorAll('.item-check').forEach(cb => cb.checked = false);
        updateFab();
    }
    function updateFab() {
        const container = document.getElementById('fabContainer');
        container.style.display = selectedItems.size > 0 ? 'flex' : 'none';
        document.getElementById('selectedCount').innerText = selectedItems.size;
    }

    // é ˜ç”¨é¸å–®é‚è¼¯
    function openBatchCheckoutModal() {
        renderCheckoutList();
        document.getElementById('itemSearchInput').value = '';
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('batchRecipient').value = '';
        document.getElementById('batchNote').value = '';
        document.getElementById('batchCheckoutModal').style.display = 'flex';
    }

    function renderCheckoutList() {
        const list = document.getElementById('checkoutList');
        list.innerHTML = '';
        selectedItems.forEach(name => {
            const group = groupedInventory.find(g => g.name === name);
            if (!group) return;
            const sortedBatches = group.batches.sort((a, b) => {
                if (!a.expiry_date) return 1; if (!b.expiry_date) return -1;
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });
            let optionsHtml = '';
            sortedBatches.forEach(b => {
                if (b.quantity > 0) {
                    const dateDisplay = b.expiry_date || 'ç„¡æ•ˆæœŸ';
                    optionsHtml += `<option value="${b.id}" data-max="${b.quantity}">æ•ˆæœŸ:${dateDisplay} (åº«å­˜:${b.quantity})</option>`;
                }
            });
            const li = document.createElement('li');
            li.className = 'checkout-item';
            li.innerHTML = `
                <div class="checkout-item-top"><span>${name}</span><i class="fas fa-times" style="color:#ff3b30; cursor:pointer;" onclick="removeFromCart('${name}')"></i></div>
                <div class="checkout-item-bottom"><select class="batch-select" id="select-${name}" onchange="updateMaxQty('${name}')">${optionsHtml}</select><input type="number" class="batch-qty-input" id="qty-${name}" value="1" min="1"></div>
            `;
            list.appendChild(li);
            setTimeout(() => updateMaxQty(name), 0);
        });
    }

    function updateMaxQty(name) {
        const select = document.getElementById(`select-${name}`);
        const input = document.getElementById(`qty-${name}`);
        if(select.selectedIndex === -1) { input.value = 0; input.max = 0; return; }
        const max = select.options[select.selectedIndex].dataset.max;
        input.max = max;
        if(parseInt(input.value) > parseInt(max)) input.value = max;
    }

    function removeFromCart(name) {
        selectedItems.delete(name);
        renderCheckoutList();
        const cb = document.querySelector(`.item-check[value="${name}"]`);
        if(cb) cb.checked = false;
        updateFab();
    }

    function searchItemToAdd() {
        const text = document.getElementById('itemSearchInput').value.toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        resultsDiv.innerHTML = '';
        if(!text) { resultsDiv.style.display = 'none'; return; }
        const matches = groupedInventory.filter(g => g.name.toLowerCase().includes(text));
        if (matches.length > 0) {
            resultsDiv.style.display = 'block';
            matches.forEach(g => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `${g.name} (ç¸½åº«å­˜: ${g.totalQty})`;
                div.onclick = () => { selectedItems.add(g.name); renderCheckoutList(); resultsDiv.style.display = 'none'; document.getElementById('itemSearchInput').value = ''; };
                resultsDiv.appendChild(div);
            });
        }
    }

    async function submitBatchCheckout() {
        const recipient = document.getElementById('batchRecipient').value.trim();
        const note = document.getElementById('batchNote').value.trim();
        if (!recipient) return alert("è«‹å¡«å¯«é ˜ç”¨äºº");
        let transactions = [];
        const items = document.querySelectorAll('.checkout-item');
        for (let item of items) {
            const select = item.querySelector('.batch-select');
            const input = item.querySelector('.batch-qty-input');
            if(!select.value) continue; 
            const batchId = select.value;
            const qty = parseInt(input.value);
            const batchName = item.querySelector('.checkout-item-top span').innerText;
            const expiryText = select.options[select.selectedIndex].text;
            const currentStock = parseInt(select.options[select.selectedIndex].dataset.max);
            if (qty > currentStock) return alert(`${batchName} åº«å­˜ä¸è¶³ (å‰©é¤˜ ${currentStock})`);
            transactions.push({ id: batchId, name: batchName, deduct: qty, newQty: currentStock - qty, expiryDisplay: expiryText });
        }
        if (transactions.length === 0) return alert("ç„¡æœ‰æ•ˆé ˜ç”¨é …ç›®");
        if (!confirm("ç¢ºå®šé ˜å‡ºï¼Ÿ")) return;
        try {
            for (let t of transactions) {
                const { error } = await supabase.from('inventory').update({ quantity: t.newQty }).eq('id', t.id);
                if(error) throw error;
                // é ˜ç”¨è¨˜éŒ„å¯«å…¥ï¼šé ˜ç”¨äºº
                await logAction('é ˜ç”¨', t.name, t.deduct, t.newQty, t.expiryDisplay.split(' ')[0], `ç”¨é€”:${note}`, recipient);
            }
            alert("âœ… é ˜ç”¨æˆåŠŸ"); clearSelection(); closeModal('batchCheckoutModal'); loadInventory();
        } catch(e) { alert("éŒ¯èª¤: " + e.message); }
    }

    function openDetailModal(name) {
        const group = groupedInventory.find(g => g.name === name);
        if(!group) return;
        currentDetailItemName = name;
        document.getElementById('detailTitle').innerText = name;
        const list = document.getElementById('batchList');
        list.innerHTML = '';
        group.batches.sort((a,b) => new Date(a.expiry_date||'9999-12-31') - new Date(b.expiry_date||'9999-12-31')).forEach(b => {
            const li = document.createElement('li');
            li.style.padding = '10px'; li.style.borderBottom = '1px solid #eee';
            li.innerHTML = `ğŸ“… ${b.expiry_date||'ç„¡æ•ˆæœŸ'} <span style="float:right; font-weight:bold; color:#007aff;">${b.quantity} ${group.unit}</span>`;
            list.appendChild(li);
        });
        document.getElementById('detailModal').style.display = 'flex';
    }

    async function addNewBatch() {
        const date = document.getElementById('newBatchDate').value;
        const qty = parseInt(document.getElementById('newBatchQty').value);
        if(!qty) return alert("è«‹è¼¸å…¥æ•¸é‡");
        const group = groupedInventory.find(g => g.name === currentDetailItemName);
        if(!confirm("ç¢ºå®šå…¥åº«ï¼Ÿ")) return;
        try {
            await supabase.from('inventory').insert([{ name: group.name, category: group.category, unit: group.unit, expiry_date: date||null, quantity: qty, sort_order: group.sortOrder }]);
            // å…¥åº«è¨˜éŒ„å¯«å…¥ï¼šç®¡ç†å“¡
            await logAction('å…¥åº«', group.name, qty, qty, date, 'æ‰‹å‹•å…¥åº«', 'ç®¡ç†å“¡');
            alert("æˆåŠŸ"); loadInventory(); closeModal('detailModal');
        } catch(e) { alert(e.message); }
    }

    // ç´€éŒ„æ“ä½œ (å¯æŒ‡å®šæ“ä½œäººå“¡åç¨±)
    async function logAction(action, name, change, final, expiry, note, operatorName) {
        const op = operatorName || 'ç®¡ç†å“¡';
        await supabase.from('inventory_logs').insert([{ 
            product_name: name, action_type: action, change_qty: change, 
            final_qty: final, operator: op, note: `${expiry} ${note}` 
        }]);
    }

    async function loadLogs() {
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', {ascending:false}).limit(50);
        const tbody = document.getElementById('logBody');
        tbody.innerHTML = '';
        if(data) {
            data.forEach(log => {
                const date = new Date(log.created_at).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
                const color = log.action_type.includes('å…¥') ? '#34c759' : '#ff3b30';
                tbody.innerHTML += `<tr><td>${date.split(' ')[0]}<br>${date.split(' ')[1]}</td><td style="color:${color};font-weight:bold;">${log.action_type}</td><td>${log.product_name}</td><td>${log.change_qty}</td><td>${log.operator}</td></tr>`;
            });
        }
    }

    // ğŸ”¥ğŸ”¥ ç›¤é»å°ˆç”¨ç‰ˆ Excel åŒ¯å…¥ (è¦†è“‹æ¨¡å¼) ğŸ”¥ğŸ”¥
    function handleExcelImport(input) {
        const file = input.files[0];
        if(!file) return;
        
        if(!confirm("âš ï¸âš ï¸ è¶…ç´šé‡è¦è­¦å‘Š âš ï¸âš ï¸\n\næ‚¨ç¾åœ¨ä½¿ç”¨çš„æ˜¯ã€ç›¤é»è¦†è“‹æ¨¡å¼ã€‘ï¼\n\nç³»çµ±å°‡æœƒã€Œåˆªé™¤ã€Excel ä¸­æ‰€åˆ—å“é …çš„ã€Œæ‰€æœ‰èˆŠåº«å­˜ã€ï¼Œ\nä¸¦å®Œå…¨ä¾ç…§ Excel ä¸Šçš„æ•¸é‡é‡æ–°å»ºç«‹ã€‚\n\nä¾‹å¦‚ï¼šExcel å¯«å®‰ç´  2 ç½ï¼Œç³»çµ±å°±æœƒè®Šæˆ 2 ç½ (ä¸ç®¡åŸæœ¬æœ‰å¹¾ç½)ã€‚\n\nç¢ºå®šè¦åŸ·è¡Œç›¤é»ä¿®æ­£å—ï¼Ÿ")) {
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let count = 0;
                
                const btn = document.querySelector('.btn-import');
                const originalText = btn.innerText;
                btn.innerText = "â³ è™•ç†ä¸­...";
                btn.disabled = true;

                for(let row of json) {
                    let name = row['å“å'];
                    if(!name) continue;

                    let cat = row['åˆ†é¡'] || 'æœªåˆ†é¡';
                    let unit = row['å–®ä½'] || 'ç½';
                    let sortOrder = row['æ’åº'] || 9999;

                    if (!row['æ’åº']) {
                        const { data: oldData } = await supabase.from('inventory').select('sort_order').eq('name', name).limit(1);
                        if (oldData && oldData.length > 0) {
                            sortOrder = oldData[0].sort_order;
                        }
                    }

                    // 1. åˆªé™¤èˆŠå¸³
                    await supabase.from('inventory').delete().eq('name', name);

                    // 2. æº–å‚™æ–°å¸³
                    let itemsToInsert = [];
                    if (row['æ•¸é‡'] != null || row['åº«å­˜'] != null) {
                        itemsToInsert.push({ qty: row['æ•¸é‡'] || row['åº«å­˜'], date: row['æœ‰æ•ˆæ—¥æœŸ'] });
                    }
                    for (let i = 1; i <= 10; i++) {
                        let qtyKey = `åº«å­˜${i}`;
                        let dateKey = `æ•ˆæœŸ${i}`;
                        if (row[qtyKey] != null && row[qtyKey] !== '') {
                            itemsToInsert.push({ qty: row[qtyKey], date: row[dateKey] });
                        }
                    }

                    // 3. å¯«å…¥æ–°å¸³
                    let totalNewQty = 0;
                    for (let item of itemsToInsert) {
                        let finalDate = null;
                        if (item.date) {
                            if (typeof item.date === 'number') {
                                finalDate = new Date(Math.round((item.date - 25569) * 86400 * 1000)).toISOString().split('T')[0];
                            } else if (typeof item.date === 'string') {
                                let cleanDate = item.date.trim().replace(/\//g, '-').replace('ç„¡æ•ˆæœŸ', '');
                                if (cleanDate && !isNaN(Date.parse(cleanDate))) {
                                    finalDate = new Date(cleanDate).toISOString().split('T')[0];
                                }
                            }
                        }

                        if (item.qty !== null && item.qty !== '') {
                            await supabase.from('inventory').insert([{ 
                                name: name, category: cat, unit: unit, 
                                quantity: item.qty, expiry_date: finalDate, sort_order: sortOrder 
                            }]);
                            totalNewQty += parseInt(item.qty || 0);
                        }
                    }
                    
                    if (itemsToInsert.length > 0) {
                        await logAction('ç›¤é»', name, 0, totalNewQty, '-', 'Excelè¦†è“‹ä¿®æ­£', 'ç®¡ç†å“¡');
                        count++;
                    }
                }

                alert(`âœ… ç›¤é»ä¿®æ­£å®Œæˆï¼å…±æ›´æ–° ${count} å€‹å“é …`); 
                input.value = ''; 
                btn.innerText = originalText;
                btn.disabled = false;
                loadInventory();

            } catch(e) { 
                alert("âŒ å¤±æ•—: " + e.message); 
                console.error(e);
                input.value = '';
                document.querySelector('.btn-import').innerText = "ğŸ“‚ åŒ¯å…¥";
                document.querySelector('.btn-import').disabled = false;
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // ğŸ”¥ ç›¤é»å–®ä¸‹è¼‰ (æ©«å‘å±•é–‹ 1~5)
    function downloadBlankForm() {
        if(groupedInventory.length === 0) return alert("ç„¡è³‡æ–™");
        
        const exportData = groupedInventory.map(group => {
            let row = {
                "æ’åº": group.sortOrder,
                "åˆ†é¡": group.category,
                "å“å": group.name,
                "å–®ä½": group.unit,
                "ç³»çµ±ç¸½æ•¸": group.totalQty,
                "ç›¤é»å¡«å¯«å€": "" 
            };

            const validBatches = group.batches
                .filter(b => b.quantity > 0)
                .sort((a,b) => new Date(a.expiry_date||'9999-12-31') - new Date(b.expiry_date||'9999-12-31'));

            // å›ºå®šæ¬„ä½ 1~5
            for (let i = 0; i < 5; i++) {
                const num = i + 1;
                const batch = validBatches[i];
                row[`åº«å­˜${num}`] = batch ? batch.quantity : ""; 
                row[`æ•ˆæœŸ${num}`] = batch ? (batch.expiry_date || 'ç„¡æ•ˆæœŸ') : "";
            }
            // è¶…é 5 ç­†ç¹¼çºŒåŠ 
            for (let i = 5; i < validBatches.length; i++) {
                 const num = i + 1;
                 const batch = validBatches[i];
                 row[`åº«å­˜${num}`] = batch.quantity;
                 row[`æ•ˆæœŸ${num}`] = batch.expiry_date || 'ç„¡æ•ˆæœŸ';
            }
            return row;
        });

        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // æ³¨å…¥è‡ªå‹•åŠ ç¸½å…¬å¼ (å‡è¨­ç›¤é»å¡«å¯«å€åœ¨ F æ¬„)
        // é€™è£¡è¨­å®š Fæ¬„ = G+I+K+M+O... (å„å€‹åˆ†æ‰¹åº«å­˜çš„åŠ ç¸½)
        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = 1; R <= range.e.r; ++R) {
            const cell_ref = XLSX.utils.encode_cell({c: 5, r: R}); // Fæ¬„ (Index 5)
            const rowNum = R + 1;
            // é€™è£¡åªæ˜¯é è¨­å…¬å¼ï¼Œä½¿ç”¨è€…å¡«å¯«å¾Œæœƒè¦†è“‹
            const formula = `SUM(G${rowNum},I${rowNum},K${rowNum},M${rowNum},O${rowNum})`; 
            if(!ws[cell_ref]) ws[cell_ref] = { t: 'n', v: 0 };
            ws[cell_ref].f = formula;
        }

        ws['!cols'] = [
            {wch:5}, {wch:10}, {wch:20}, {wch:5}, {wch:8}, {wch:15}, 
            {wch:6}, {wch:12}, {wch:6}, {wch:12}, {wch:6}, {wch:12}, {wch:6}, {wch:12}, {wch:6}, {wch:12}
        ];
        const wb = XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»å–®");
        XLSX.writeFile(wb, `ç›¤é»è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // ğŸ”¥ åº«å­˜å ±è¡¨ä¸‹è¼‰ (æ©«å‘å±•é–‹ 1~5)
    function exportStock() {
        if(groupedInventory.length === 0) return alert("ç„¡è³‡æ–™");
        const exportData = groupedInventory.map(group => {
            let row = {
                "æ’åº": group.sortOrder,
                "åˆ†é¡": group.category,
                "å“å": group.name,
                "ç¸½åº«å­˜": group.totalQty,
                "å–®ä½": group.unit
            };

            const validBatches = group.batches
                .filter(b => b.quantity > 0)
                .sort((a,b) => new Date(a.expiry_date||'9999-12-31') - new Date(b.expiry_date||'9999-12-31'));

            for (let i = 0; i < 5; i++) {
                const num = i + 1;
                const batch = validBatches[i];
                row[`åº«å­˜${num}`] = batch ? batch.quantity : ""; 
                row[`æ•ˆæœŸ${num}`] = batch ? (batch.expiry_date || 'ç„¡æ•ˆæœŸ') : "";
            }
            for (let i = 5; i < validBatches.length; i++) {
                 const num = i + 1;
                 const batch = validBatches[i];
                 row[`åº«å­˜${num}`] = batch.quantity;
                 row[`æ•ˆæœŸ${num}`] = batch.expiry_date || 'ç„¡æ•ˆæœŸ';
            }
            return row;
        });

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜ç¸½è¡¨");
        XLSX.writeFile(wb, `åº«å­˜ç¸½è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    async function exportLogs() {
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', {ascending:false}).limit(1000);
        if(!data || data.length === 0) return alert("ç„¡ç´€éŒ„");
        const exportData = data.map(l => ({ 
            "æ™‚é–“": new Date(l.created_at).toLocaleString(), "å‹•ä½œ": l.action_type, 
            "å“å": l.product_name, "ç•°å‹•": l.change_qty, "å‚™è¨»": l.note, "äººå“¡": l.operator 
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ç´€éŒ„");
        XLSX.writeFile(wb, `åº«å­˜ç´€éŒ„_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function openNewItemModal() { document.getElementById('newItemModal').style.display = 'flex'; }
    async function submitNewItem() {
        const name = document.getElementById('newItemName').value;
        const qty = document.getElementById('newItemQty').value;
        if(!name) return;
        await supabase.from('inventory').insert([{ name: name, category: document.getElementById('newCat').value, unit: document.getElementById('newUnit').value, expiry_date: document.getElementById('newItemDate').value || null, quantity: qty, sort_order: 9999 }]);
        // å»ºæª”è¨˜éŒ„å¯«å…¥ï¼šç®¡ç†å“¡
        await logAction('å»ºæª”', name, qty, qty, document.getElementById('newItemDate').value || null, 'æ–°å¢å“é …', 'ç®¡ç†å“¡');
        alert("å·²æ–°å¢"); closeModal('newItemModal'); loadInventory();
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
