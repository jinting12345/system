<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šå“åº«å­˜ç®¡ç†ç³»çµ± (é€²éšç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .back-btn { text-decoration: none; color: #666; font-weight: bold; }
        h2 { margin: 0; color: #2c3e50; }
        .role-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white; }

        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 5px 5px 0 0; font-weight: bold; color: #555; }
        .tab-btn.active { background: #1a73e8; color: white; }

        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 5px 5px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-content.active { display: block; }

        /* æ§åˆ¶å€ */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .search-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px; }
        
        /* ğŸ”¥ åˆ†é¡é¸å–®æ¨£å¼ */
        .category-select { padding: 10px; border: 1px solid #1a73e8; border-radius: 4px; color: #1a73e8; font-weight: bold; background: white; cursor: pointer; }

        .action-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; }
        .btn-in { background: #28a745; } 
        .btn-out { background: #dc3545; } 
        .btn-import { background: #17a2b8; } 
        .btn-export { background: #6f42c1; } 
        .btn-stocktake { background: #e67e22; } /* ç›¤é»æ©˜è‰² */
        
        .admin-only { display: none; }

        /* è¡¨æ ¼å„ªåŒ– */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f1f3f5; color: #444; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }

        /* æ•ˆæœŸè­¦ç¤º */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; display: inline-block; min-width: 60px; text-align: center; }
        .bg-ok { background: #28a745; }
        .bg-warn { background: #ffc107; color: #333; }
        .bg-danger { background: #dc3545; }
        .bg-cat { background: #6c757d; font-size: 0.9em; margin-right: 5px; } 

        .date-cell { font-family: Consolas, monospace; color: #555; }
        .qty-cell { font-size: 1.2em; color: #1a73e8; font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
        <h2>ğŸ“¦ ç‡Ÿé¤Šå“åº«å­˜ç®¡ç† <span id="roleLabel"></span></h2>
        <div style="font-size:14px; color:#666;" id="userInfo">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('stock')">ğŸ“Š æ‰¹è™Ÿæ•ˆæœŸåº«å­˜</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“ é€²å‡ºç´€éŒ„</button>
    </div>

    <div id="stock" class="tab-content active">
        <div class="controls">
            <select id="categoryFilter" class="category-select" onchange="filterTable()">
                <option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>
            </select>

            <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å“å..." onkeyup="filterTable()">
            
            <input type="file" id="excel_input" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelImport(this)">

            <button class="action-btn btn-import admin-only" onclick="document.getElementById('excel_input').click()">ğŸ“‚ åŒ¯å…¥ Excel</button>
            <button class="action-btn btn-in admin-only" style="background:#007bff;" onclick="openAddModal()">â• æ–°å¢å“é …</button>
            
            <button class="action-btn btn-stocktake" onclick="downloadBlankForm()">ğŸ“„ ä¸‹è¼‰ç©ºç™½ç›¤é»è¡¨</button>
            <button class="action-btn btn-export" onclick="exportStock()">ğŸ“¥ ä¸‹è¼‰ç¸½åº«å­˜è¡¨</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table id="stockTable">
                <thead>
                    <tr>
                        <th width="15%">åˆ†é¡</th>
                        <th width="25%">å“å</th>
                        <th width="10%">åº«å­˜</th>
                        <th width="8%">å–®ä½</th>
                        <th width="15%">æœ‰æ•ˆæ—¥æœŸ (æ‰¹è™Ÿ)</th>
                        <th width="10%">ç‹€æ…‹</th>
                        <th width="17%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="stockBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logs" class="tab-content">
        <div class="controls" style="justify-content: space-between;">
            <h3>æœ€è¿‘ 50 ç­†ç•°å‹•</h3>
            <button class="action-btn btn-export" onclick="exportLogs()">ğŸ“¥ ä¸‹è¼‰ç´€éŒ„</button>
        </div>
        <table id="logTable">
            <thead>
                <tr>
                    <th>æ™‚é–“</th> <th>å‹•ä½œ</th> <th>å“å</th> <th>ç•°å‹•é‡</th> <th>æ•ˆæœŸ</th> <th>æ“ä½œäºº</th> <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>
</div>

<div id="actionModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">åŸ·è¡Œå‹•ä½œ</h3>
        
        <div id="newItemFields" style="display:none;">
            <div class="form-group"><label>åˆ†é¡</label><input type="text" id="newCat" placeholder="ä¾‹å¦‚: ç³–å°¿ç—…é…æ–¹"></div>
            <div class="form-group"><label>å“å</label><input type="text" id="newName" placeholder="è¼¸å…¥ç”¢å“åç¨±"></div>
            <div class="form-group"><label>å–®ä½</label><input type="text" id="newUnit" placeholder="ä¾‹å¦‚: ç½, ç®±"></div>
            <div class="form-group"><label>æœ‰æ•ˆæ—¥æœŸ</label><input type="date" id="newDate"></div>
        </div>

        <div id="existingItemFields">
            <div class="form-group"><label>å“å</label><input type="text" id="actName" disabled style="background:#eee;"></div>
            <div class="form-group"><label>æœ‰æ•ˆæ—¥æœŸ</label><input type="text" id="actDateDisplay" disabled style="background:#eee;"></div>
        </div>

        <div class="form-group">
            <label>æ•¸é‡</label>
            <input type="number" id="actQty" placeholder="è«‹è¼¸å…¥æ•¸é‡">
        </div>
        <div class="form-group">
            <label>å‚™è¨» (é¸å¡«)</label>
            <input type="text" id="actNote" placeholder="ä¾‹å¦‚: ç—…æˆ¿é ˜ç”¨ã€å» å•†é€²è²¨">
        </div>
        
        <input type="hidden" id="actId">
        <input type="hidden" id="actType">
        <input type="hidden" id="actCurrentQty">

        <div class="modal-footer">
            <button class="action-btn" style="background:#666;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="action-btn btn-in" id="confirmBtn" onclick="submitAction()">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
    function cleanString(str) { return str.replace(/[^\x20-\x7E]/g, '').trim(); }
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

    let inventoryData = [];
    let currentUser = '';
    let isAdmin = false;

    // åˆå§‹åŒ–
    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if(!session) window.location.href = 'index.html';
        currentUser = session.user.email;
        document.getElementById('userInfo').innerText = currentUser;

        await checkUserRole();
        loadInventory();
        loadLogs();
    })();

    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUser).single();
        const roleLabel = document.getElementById('roleLabel');
        if (data && data.role === 'admin') {
            isAdmin = true;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            roleLabel.innerHTML = '<span class="role-badge" style="background:#dc3545;">ç®¡ç†å“¡</span>';
        } else {
            isAdmin = false;
            roleLabel.innerHTML = '<span class="role-badge" style="background:#28a745;">ä¸€èˆ¬äººå“¡</span>';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function loadInventory() {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '<tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>';
        
        const { data, error } = await supabase
            .from('inventory')
            .select('*')
            .order('category', { ascending: true })
            .order('name', { ascending: true })
            .order('expiry_date', { ascending: true });

        if(error) { alert("è®€å–å¤±æ•—"); console.error(error); return; }
        
        inventoryData = data || [];
        updateCategoryFilter(inventoryData);
        renderTable(inventoryData);
    }

    function updateCategoryFilter(data) {
        const select = document.getElementById('categoryFilter');
        const currentVal = select.value;
        const categories = [...new Set(data.map(i => i.category || 'æœªåˆ†é¡'))].sort();
        
        select.innerHTML = '<option value="ALL">ğŸ“‚ æ‰€æœ‰åˆ†é¡</option>';
        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
        select.value = currentVal;
    }

    function renderTable(data) {
        const tbody = document.getElementById('stockBody');
        tbody.innerHTML = '';
        const today = new Date();
        const warningDate = new Date(); warningDate.setDate(today.getDate() + 90);

        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">ç„¡åº«å­˜è³‡æ–™</td></tr>';
            return;
        }

        data.forEach(item => {
            let statusBadge = '<span class="badge bg-ok">æ­£å¸¸</span>';
            let dateStr = item.expiry_date || 'ç„¡æ•ˆæœŸ';
            
            if(item.expiry_date) {
                const exp = new Date(item.expiry_date);
                if(exp < today) statusBadge = '<span class="badge bg-danger">å·²éæœŸ</span>';
                else if(exp < warningDate) statusBadge = '<span class="badge bg-warn">å¿«éæœŸ</span>';
            }

            let actionButtons = '';
            if (isAdmin) {
                actionButtons = `
                    <button class="action-btn btn-in" style="font-size:12px; padding:4px 8px;" onclick="openAction('IN', '${item.id}')">è£œè²¨</button>
                    <button class="action-btn btn-out" style="font-size:12px; padding:4px 8px;" onclick="openAction('OUT', '${item.id}')">é ˜ç”¨</button>
                `;
            } else {
                actionButtons = `
                    <button class="action-btn btn-out" style="font-size:12px; padding:4px 8px;" onclick="openAction('OUT', '${item.id}')">é ˜ç”¨</button>
                `;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="badge bg-cat">${item.category || 'æœªåˆ†é¡'}</span></td>
                <td style="font-weight:bold;">${item.name}</td>
                <td class="qty-cell">${item.quantity}</td>
                <td>${item.unit || 'ç½'}</td>
                <td class="date-cell">${dateStr}</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        const text = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('categoryFilter').value;
        
        const filtered = inventoryData.filter(i => {
            const matchText = i.name.toLowerCase().includes(text) || (i.category && i.category.includes(text));
            const matchCat = cat === 'ALL' || i.category === cat;
            return matchText && matchCat;
        });
        
        renderTable(filtered);
    }

    function openAction(type, id) {
        const item = inventoryData.find(i => i.id === id);
        if(!item) return;

        document.getElementById('actionModal').style.display = 'flex';
        document.getElementById('newItemFields').style.display = 'none';
        document.getElementById('existingItemFields').style.display = 'block';

        document.getElementById('actId').value = id;
        document.getElementById('actType').value = type;
        document.getElementById('actCurrentQty').value = item.quantity;
        document.getElementById('actName').value = item.name;
        document.getElementById('actDateDisplay').value = item.expiry_date || 'ç„¡';
        document.getElementById('actQty').value = '';
        document.getElementById('actNote').value = '';

        setupModalButton(type, item.name);
    }

    function openAddModal() {
        document.getElementById('actionModal').style.display = 'flex';
        document.getElementById('newItemFields').style.display = 'block';
        document.getElementById('existingItemFields').style.display = 'none';
        
        document.getElementById('actType').value = 'NEW';
        document.getElementById('actId').value = ''; 
        document.getElementById('newCat').value = '';
        document.getElementById('newName').value = '';
        document.getElementById('newUnit').value = '';
        document.getElementById('newDate').value = '';
        document.getElementById('actQty').value = '';
        
        const btn = document.getElementById('confirmBtn');
        document.getElementById('modalTitle').innerText = "âœ¨ æ–°å¢åº«å­˜å“é …";
        btn.innerText = "ç¢ºèªæ–°å¢";
        btn.className = "action-btn btn-in";
    }

    function setupModalButton(type, name) {
        const btn = document.getElementById('confirmBtn');
        const title = document.getElementById('modalTitle');
        if(type === 'IN') {
            title.innerText = `â• è£œè²¨ (åŸæœ‰æ‰¹è™Ÿ)ï¼š${name}`;
            btn.innerText = 'ç¢ºèªå…¥åº«';
            btn.className = 'action-btn btn-in';
        } else {
            title.innerText = `â– é ˜ç”¨ï¼š${name}`;
            btn.innerText = 'ç¢ºèªé ˜ç”¨';
            btn.className = 'action-btn btn-out';
        }
    }

    async function submitAction() {
        const type = document.getElementById('actType').value;
        const qtyInput = parseInt(document.getElementById('actQty').value);
        const note = document.getElementById('actNote').value;
        const btn = document.getElementById('confirmBtn');

        if(!qtyInput || qtyInput <= 0) return alert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡');
        btn.disabled = true;

        try {
            if (type === 'NEW') {
                const newName = document.getElementById('newName').value.trim();
                const newCat = document.getElementById('newCat').value.trim();
                const newDate = document.getElementById('newDate').value;
                const newUnit = document.getElementById('newUnit').value;

                if (!newName) throw new Error("å“åå¿…å¡«");

                const { error } = await supabase.from('inventory').insert([{
                    name: newName,
                    category: newCat,
                    quantity: qtyInput,
                    unit: newUnit,
                    expiry_date: newDate || null
                }]);
                if(error) throw error;
                await logAction('æ–°å¢å“é …', newName, qtyInput, qtyInput, newDate, note);

            } else {
                const id = document.getElementById('actId').value;
                const currentQty = parseInt(document.getElementById('actCurrentQty').value);
                const name = document.getElementById('actName').value;
                const date = document.getElementById('actDateDisplay').value;

                let newQty = currentQty;
                if(type === 'IN') newQty += qtyInput;
                else {
                    if(currentQty < qtyInput) throw new Error('åº«å­˜ä¸è¶³ï¼');
                    newQty -= qtyInput;
                }

                const { error } = await supabase.from('inventory').update({ quantity: newQty }).eq('id', id);
                if(error) throw error;

                await logAction(type === 'IN' ? 'è£œè²¨' : 'é ˜ç”¨', name, qtyInput, newQty, date, note);
            }

            alert('âœ… æ“ä½œæˆåŠŸ');
            closeModal();
            loadInventory();
            loadLogs();
        } catch(e) {
            alert('âŒ å¤±æ•—: ' + e.message);
        } finally {
            btn.disabled = false;
        }
    }

    async function logAction(action, name, change, final, expiry, note) {
        await supabase.from('inventory_logs').insert([{
            product_name: name,
            action_type: action,
            change_qty: change,
            final_qty: final,
            operator: currentUser,
            note: `æ•ˆæœŸ:${expiry || '-'} / ${note}`
        }]);
    }

    async function handleExcelImport(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        if (!confirm("âš ï¸ æ³¨æ„ï¼šé€™å°‡åŒ¯å…¥å¤šç­†è³‡æ–™ã€‚\nç³»çµ±æœƒæ ¹æ“šã€Œå“å + æœ‰æ•ˆæ—¥æœŸã€ä¾†åˆ¤æ–·æ˜¯æ›´æ–°ç¾æœ‰åº«å­˜é‚„æ˜¯æ–°å¢ã€‚\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) {
            inputElement.value = ''; return;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                let successCount = 0;

                for (let row of jsonData) {
                    let name = row['å“å'];
                    let cat = row['åˆ†é¡']; 
                    let qty = row['æ•¸é‡'] || row['åº«å­˜æ•¸é‡'] || row['åº«å­˜']; 
                    let unit = row['å–®ä½'] || row['è¦æ ¼'];
                    let expiry = formatExcelDate(row['æœ‰æ•ˆæ—¥æœŸ']);

                    if (!name || (qty === undefined && qty === null)) continue; 

                    let query = supabase.from('inventory').select('id, quantity').eq('name', name);
                    if (expiry) { query = query.eq('expiry_date', expiry); } 
                    else { query = query.is('expiry_date', null); }

                    const { data: existing } = await query;

                    if (existing && existing.length > 0) {
                        await supabase.from('inventory')
                            .update({ quantity: qty, category: cat, unit: unit }) 
                            .eq('id', existing[0].id);
                    } else {
                        await supabase.from('inventory').insert([{
                            name: name,
                            category: cat || 'æœªåˆ†é¡',
                            quantity: qty,
                            unit: unit || 'ç½',
                            expiry_date: expiry
                        }]);
                    }
                    successCount++;
                }

                alert(`âœ… åŒ¯å…¥å®Œæˆï¼è™•ç†äº† ${successCount} ç­†è³‡æ–™ã€‚`);
                inputElement.value = '';
                loadInventory();
                
            } catch (error) {
                console.error('åŒ¯å…¥å¤±æ•—:', error);
                alert('âŒ åŒ¯å…¥å¤±æ•—: ' + error.message);
                inputElement.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function formatExcelDate(excelDate) {
        if (!excelDate) return null;
        if (typeof excelDate === 'string') return excelDate.trim(); 
        if (typeof excelDate === 'number') {
            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            return date.toISOString().split('T')[0];
        }
        return null;
    }

    // ğŸ”¥ ä¸‹è¼‰ç©ºç™½ç›¤é»å–® (åº«å­˜æ¬„ä½æ¸…ç©º)
    function downloadBlankForm() {
        if(inventoryData.length === 0) return alert("ç›®å‰ç„¡è³‡æ–™å¯ä¸‹è¼‰");

        const sortedData = [...inventoryData].sort((a, b) => {
            const catA = a.category || 'zzz';
            const catB = b.category || 'zzz';
            return catA.localeCompare(catB) || a.name.localeCompare(b.name);
        });

        const exportData = sortedData.map(item => ({
            "åˆ†é¡": item.category || '',
            "å“å": item.name,
            "åº«å­˜æ•¸é‡": "", // ğŸ”¥ æ•…æ„ç•™ç©º
            "å–®ä½": item.unit || '',
            "æœ‰æ•ˆæ—¥æœŸ": item.expiry_date || ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        ws['!cols'] = [{wch: 15}, {wch: 30}, {wch: 10}, {wch: 8}, {wch: 15}];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»å¡«å¯«å–®");
        XLSX.writeFile(wb, `ç©ºç™½ç›¤é»è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // ä¸‹è¼‰åº«å­˜ç¸½è¡¨ (æœ‰æ•¸å­—çš„)
    function exportStock() {
        if(inventoryData.length === 0) return alert("ç„¡è³‡æ–™å¯åŒ¯å‡º");
        const exportData = inventoryData.map(item => ({
            "åˆ†é¡": item.category || '',
            "å“å": item.name,
            "åº«å­˜": item.quantity,
            "å–®ä½": item.unit || '',
            "æ•ˆæœŸ": item.expiry_date || 'ç„¡',
            "ç‹€æ…‹": getStatusText(item.expiry_date)
        }));
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜ç¸½è¡¨");
        XLSX.writeFile(wb, `ç‡Ÿé¤Šå“åº«å­˜å ±è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function getStatusText(dateStr) {
        if(!dateStr) return 'æ­£å¸¸';
        const today = new Date();
        const exp = new Date(dateStr);
        const warningDate = new Date(); warningDate.setDate(today.getDate() + 90);
        if(exp < today) return 'å·²éæœŸ';
        if(exp < warningDate) return 'å¿«éæœŸ';
        return 'æ­£å¸¸';
    }

    async function exportLogs() {
        const btn = document.querySelector('.btn-export');
        const oldText = btn ? btn.innerText : '';
        if(btn) btn.innerText = "ä¸‹è¼‰ä¸­...";

        try {
            const { data, error } = await supabase.from('inventory_logs').select('*').order('created_at', { ascending: false }).limit(1000);
            if(error) throw error;
            if(!data || data.length === 0) return alert("ç„¡ç´€éŒ„å¯åŒ¯å‡º");

            const exportData = data.map(log => ({
                "æ™‚é–“": new Date(log.created_at).toLocaleString('zh-TW'),
                "å‹•ä½œ": log.action_type,
                "å“å": log.product_name,
                "ç•°å‹•é‡": log.change_qty,
                "çµé¤˜": log.final_qty,
                "æ“ä½œäºº": log.operator,
                "å‚™è¨»": log.note || ""
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç•°å‹•ç´€éŒ„");
            XLSX.writeFile(wb, `é€²å‡ºè²¨ç´€éŒ„_${new Date().toISOString().slice(0,10)}.xlsx`);
        } catch(e) {
            console.error(e); alert("åŒ¯å‡ºå¤±æ•—ï¼š" + e.message);
        } finally {
            if(btn) btn.innerText = oldText;
        }
    }

    async function loadLogs() {
        const tbody = document.getElementById('logBody');
        const { data } = await supabase.from('inventory_logs').select('*').order('created_at', { ascending: false }).limit(50);
        if(!data) return;
        tbody.innerHTML = '';
        data.forEach(log => {
            const dateStr = new Date(log.created_at).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'numeric', minute:'numeric'});
            const color = log.action_type.includes('å…¥') || log.action_type.includes('å¢') || log.action_type.includes('è£œ') ? 'green' : 'red';
            tbody.innerHTML += `<tr><td>${dateStr}</td><td style="color:${color};font-weight:bold;">${log.action_type}</td><td>${log.product_name}</td><td>${log.change_qty}</td><td>${log.note.split('/')[0]||''}</td><td>${log.operator}</td><td>${log.note.split('/')[1]||''}</td></tr>`;
        });
    }

    function closeModal() { document.getElementById('actionModal').style.display = 'none'; }
</script>

</body>
</html>
