<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·å–®è¾¨è­˜ (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #1a73e8; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;}
        
        /* ä¸Šå‚³å€å¡Š */
        .upload-area { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; background: #f8fafc; }
        .upload-area:active { background: #e8f0fe; border-color: #1a73e8; }
        .upload-icon { font-size: 32px; margin-bottom: 5px; }
        
        #preview-container { display: none; margin-top: 15px; text-align: center; }
        #preview-img { max-width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* é€²åº¦æ¢ */
        .progress-container { margin-top: 20px; display: none; }
        .progress-bar { width: 100%; height: 12px; background-color: #e2e8f0; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background-color: #1a73e8; transition: width 0.3s ease; }
        .status-text { margin-top: 5px; font-size: 13px; color: #64748b; text-align: center; font-weight: bold;}

        /* çµæœè¡¨æ ¼ */
        .result-section { display: none; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f1f5f9; color: #475569; font-size: 14px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; } /* æ‰‹æ©Ÿå­—é«”å¤§ä¸€é» */
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; display: flex; justify-content: center; align-items: center; }
        .btn-primary { background-color: #1a73e8; }
        .btn-success { background-color: #10b981; }
        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; }
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ğŸ“· ç—…æ­·å–®è¾¨è­˜ (æ‰‹æ©Ÿç‰ˆ)</h2>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“¸</div>
        <div style="font-weight:bold; color:#555;">é»æ“Šæ‹ç…§ / é¸åœ–</div>
        <div style="font-size:12px; color:#999; margin-top:5px;">ç³»çµ±æœƒè‡ªå‹•å£“ç¸®åœ–ç‰‡åŠ é€Ÿè™•ç†</div>
    </div>
    <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(this)">

    <div id="preview-container">
        <img id="preview-img">
    </div>

    <div class="progress-container" id="progressContainer">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="status-text" id="statusText">æº–å‚™ä¸­...</div>
    </div>
    
    <div class="result-section" id="resultSection">
        <h3>âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="35%">ç—…æ­·è™Ÿ</th><th width="50%">å§“å</th><th width="15%"></th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="btn-group">
            <button class="btn btn-primary" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½</button>
            <button class="btn btn-success" onclick="location.reload()">ğŸ”„ é‡ä¾†</button>
        </div>
    </div>
</div>

<script>
    async function handleFileSelect(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];

        // é¡¯ç¤ºåˆå§‹é è¦½
        const img = document.getElementById('preview-img');
        img.src = URL.createObjectURL(file);
        document.getElementById('preview-container').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';

        // åŸ·è¡Œå£“ç¸® + è¾¨è­˜
        await runOCR(file);
    }

    async function runOCR(originalFile) {
        const pContainer = document.getElementById('progressContainer');
        const pFill = document.getElementById('progressFill');
        const status = document.getElementById('statusText');
        
        pContainer.style.display = 'block';
        status.innerText = "ğŸš€ æ­£åœ¨å£“ç¸®åœ–ç‰‡ä»¥åŠ é€Ÿè™•ç†...";
        pFill.style.width = "10%";

        try {
            // 1. åœ–ç‰‡å£“ç¸® (æ‰‹æ©Ÿç‰ˆæ•‘æ˜Ÿ)
            const options = {
                maxSizeMB: 1,           // é™åˆ¶æœ€å¤§ 1MB
                maxWidthOrHeight: 1024, // é™åˆ¶é•·å¯¬ 1024px (å° OCR ä¾†èªªå¾ˆå¤ äº†)
                useWebWorker: true
            };
            const compressedFile = await imageCompression(originalFile, options);
            
            // æ›´æ–°é è¦½åœ–ç‚ºå£“ç¸®å¾Œçš„ (ç¯€çœè¨˜æ†¶é«”)
            document.getElementById('preview-img').src = URL.createObjectURL(compressedFile);
            status.innerText = "â˜ï¸ å•Ÿå‹•è¾¨è­˜å¼•æ“...";
            pFill.style.width = "30%";

            // 2. å•Ÿå‹• Tesseract
            const worker = await Tesseract.createWorker({
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const pct = 30 + Math.round(m.progress * 70); // è®“é€²åº¦æ¢å¾ 30% é–‹å§‹è·‘
                        pFill.style.width = pct + '%';
                        status.innerText = `ğŸ” æ­£åœ¨è®€å–æ–‡å­—... ${Math.round(m.progress * 100)}%`;
                    } else if (m.status.includes('loading')) {
                        status.innerText = "ğŸ“¥ ä¸‹è¼‰èªè¨€åŒ… (é¦–æ¬¡éœ€ç´„20ç§’)...";
                    }
                }
            });

            await worker.loadLanguage('chi_tra+eng');
            await worker.initialize('chi_tra+eng');

            // 3. é–‹å§‹è¾¨è­˜
            const { data: { text } } = await worker.recognize(compressedFile);
            
            status.innerText = "âœ… å®Œæˆï¼";
            pFill.style.width = "100%";

            const parsedData = parseTextToData(text);
            renderTable(parsedData);
            
            await worker.terminate(); // é‡‹æ”¾è¨˜æ†¶é«”
            pContainer.style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';

        } catch (err) {
            console.error(err);
            alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message + "\nå»ºè­°ä½¿ç”¨ Wi-Fi é€£ç·š");
            status.innerText = "âŒ å¤±æ•—";
        }
    }

    // ç°¡æ˜“è§£æé‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ)
    function parseTextToData(rawText) {
        const lines = rawText.split('\n');
        const results = [];
        lines.forEach(line => {
            const cleanLine = line.replace(/\s+/g, ' ').trim();
            if (cleanLine.includes('ç—…æ­·è™Ÿ') || cleanLine.length < 5) return;
            const mrnMatch = cleanLine.match(/(\d{5,8})/);
            const nameMatch = cleanLine.match(/[\u4e00-\u9fa5]{2,4}/g);
            if (mrnMatch) {
                const mrn = mrnMatch[0];
                let name = '';
                if (nameMatch) {
                    const blacklist = ['è¤‡è¨º', 'è³‡æ–™', 'é½Šå…¨', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜'];
                    const potentialNames = nameMatch.filter(n => !blacklist.some(bad => n.includes(bad)));
                    if (potentialNames.length > 0) name = potentialNames[0];
                }
                if (mrn) results.push({ mrn, name });
            }
        });
        return results;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:red;padding:20px;">âš ï¸ æœªåµæ¸¬åˆ°è³‡æ–™ï¼Œè«‹èª¿æ•´æ‹ç…§è§’åº¦<br>é¿å…åå…‰æˆ–é™°å½±</td></tr>'; return; }
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text" value="${row.mrn}"></td><td><input type="text" value="${row.name}"></td><td onclick="this.parentElement.remove()" style="text-align:center;font-size:1.2em;">âŒ</td>`;
            tbody.appendChild(tr);
        });
    }

    function copyToClipboard() {
        const rows = document.querySelectorAll('#tableBody tr');
        let text = ""; 
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs.length > 0) text += `${inputs[0].value}\t${inputs[1].value}\n`;
        });
        if(!text) { alert("æ²’æœ‰è³‡æ–™å¯è¤‡è£½"); return; }
        navigator.clipboard.writeText(text).then(() => alert('âœ… å·²è¤‡è£½ï¼å¯è²¼ä¸Šè‡³ Excel')).catch(() => alert('è¤‡è£½å¤±æ•—'));
    }
</script>

</body>
</html>
