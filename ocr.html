<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·è¾¨è­˜ (çµ‚æ¥µæ”¾å¤§ç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f8f9fa; padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 15px 0; color: #2c3e50; font-size: 1.4rem; text-align: center; font-weight: 800;}
        
        .status-box { background: #e3f2fd; color: #0d47a1; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; text-align: center; border: 1px solid #bbdefb; font-weight: bold;}
        .error-box { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: left; font-size: 14px; border: 1px solid #fecaca; }

        .action-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;}
        .btn-action:active { transform: scale(0.96); }
        .btn-camera { background: linear-gradient(135deg, #28a745, #218838); }
        .btn-gallery { background: linear-gradient(135deg, #f39c12, #d35400); }
        
        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; background: white;}

        .preview-area { margin-top: 15px; display: none; text-align: center;}
        canvas { max-width: 100%; border-radius: 8px; border: 1px solid #333; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* çµæœè¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; border: 1px solid #eee; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 16px; }
        th { background-color: #f1f3f5; color: #495057; font-size: 14px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 18px; color: #212529; }
        
        /* è¢å…‰ç­†æ¨™ç±¤ */
        .tag { font-size: 12px; padding: 3px 8px; border-radius: 12px; margin-left: 5px; display: inline-block; font-weight: bold; vertical-align: middle; box-shadow: 0 1px 2px rgba(0,0,0,0.1);}
        .tag-orange { background: #ff9800; color: white; }
        .tag-yellow { background: #ffeb3b; color: #333; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0d6efd; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:5px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ğŸ“· ç—…æ­·è¾¨è­˜ (çµ‚æ¥µæ”¾å¤§ç‰ˆ)</h2>
    
    <div id="statusBox" class="status-box">
        ğŸ’¡ æº–å‚™å°±ç·’ (è«‹ç¢ºèªå·²æ›å› 3MB å­—åº«)
    </div>
    <div id="errorBox" class="error-box"></div>

    <div class="action-group">
        <button id="btnCam" class="btn-action btn-camera" onclick="startProcess('camera')">
            ğŸ“¸ æ‹ç…§
        </button>
        <button id="btnGal" class="btn-action btn-gallery" onclick="startProcess('gallery')">
            ğŸ–¼ï¸ é¸ç…§ç‰‡
        </button>
    </div>
    
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="loadFile(this)">
    <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="loadFile(this)">

    <div class="preview-area" id="previewArea">
        <div style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ‘‡ é›»è…¦è¦–è¦ºå¢å¼·å½±åƒ (æ”¾å¤§250%) ğŸ‘‡</div>
        <canvas id="processCanvas"></canvas>
    </div>

    <div id="resultArea" style="display:none; margin-top:20px;">
        <h3 style="margin:0 0 10px 0; color:#333; font-size:16px;">âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="35%">ç—…æ­·è™Ÿ</th><th width="65%">å§“å</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="copyResult()" style="flex:1; padding:12px; background:#1a73e8; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ“‹ è¤‡è£½</button>
            <button onclick="location.reload()" style="flex:1; padding:12px; background:#6c757d; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ”„ é‡ä¾†</button>
        </div>
    </div>
</div>

<script>
    let colorMap = []; 

    async function startProcess(type) {
        if (type === 'camera') document.getElementById('cameraInput').click();
        else document.getElementById('galleryInput').click();
    }

    function loadFile(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        // é–å®šä»‹é¢
        const btns = document.querySelectorAll('.btn-action');
        btns.forEach(b => { b.disabled = true; b.style.opacity = '0.5'; });
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('errorBox').style.display = 'none';
        
        document.getElementById('statusBox').innerHTML = '<div class="loader"></div> 1. å½±åƒæ”¾å¤§èˆ‡è‰²å½©åˆ†æ...';

        setTimeout(() => {
            processAndRecognize(file);
        }, 100);
        input.value = '';
    }

    async function processAndRecognize(file) {
        try {
            const canvas = document.getElementById('processCanvas');
            // 1. å½±åƒè™•ç†ï¼šé€™æ˜¯é—œéµï¼æ”¾å¤§ + éŠ³åŒ–
            await smartEnhance(file, canvas);
            document.getElementById('previewArea').style.display = 'block';

            // 2. åŸ·è¡Œ OCR
            document.getElementById('statusBox').innerHTML = '<div class="loader"></div> 2. è¼‰å…¥è¼•é‡æ ¸å¿ƒ (3MB) è¾¨è­˜ä¸­...';
            await runTesseract(canvas);

        } catch (err) {
            console.error(err);
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `<strong>éŒ¯èª¤ï¼š</strong>${err.message}<br>è«‹ç¢ºèª GitHub ä¸Šæ˜¯ 3MB çš„ chi_tra.traineddata.gz`;
            document.getElementById('statusBox').innerText = "âŒ å¤±æ•—";
        } finally {
            const btns = document.querySelectorAll('.btn-action');
            btns.forEach(b => { b.disabled = false; b.style.opacity = '1'; });
        }
    }

    // ğŸ”¥ æ ¸å¿ƒæŠ€è¡“ï¼šå½±åƒæ”¾å¤§èˆ‡å¢å¼·
    function smartEnhance(file, canvas) {
        return new Promise((resolve) => {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                // å¼·åˆ¶æ”¾å¤§åˆ° 1800px å¯¬ (é€™èƒ½è®“å°å­—è®Šå¤§å­—ï¼Œè¼•é‡ç‰ˆå¤§è…¦ä¹Ÿèƒ½è®€æ‡‚ï¼)
                const targetWidth = 1800; 
                const scale = targetWidth / img.width;
                canvas.width = targetWidth;
                canvas.height = img.height * scale;
                
                // ç•«ä¸Šå»
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const width = canvas.width;
                const height = canvas.height;
                
                // åˆå§‹åŒ–é¡è‰²åœ°åœ– (ä¾æ“šæ–°é«˜åº¦)
                colorMap = new Array(height).fill(null);

                for (let y = 0; y < height; y++) {
                    let oScore = 0, yScore = 0;
                    
                    // è‰²å½©åµæ¸¬ (æ¯10é»æŠ½æ¨£)
                    for (let x = 0; x < width; x += 10) {
                        const i = (y * width + x) * 4;
                        const r = data[i], g = data[i+1], b = data[i+2];

                        // é»ƒè‰²/æ©˜è‰² åˆ¤å®šé‚è¼¯
                        if (r > 180 && g > 180 && b < 160) {
                            if (Math.abs(r - g) < 45) yScore++;
                        } else if (r > 210 && g > 120 && g < 190 && b < 120) {
                            oScore++;
                        }
                    }
                    if (oScore > 5) colorMap[y] = 'orange';
                    else if (yScore > 5) colorMap[y] = 'yellow';
                }

                // å½±åƒå¢å¼· (äºŒå€¼åŒ– + å°æ¯”æå‡)
                for (let i = 0; i < data.length; i += 4) {
                    let gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                    // é–¾å€¼è¨­ç‚º 145ï¼Œç¨å¾®æ¿€é€²ä¸€é»å»èƒŒ
                    const val = gray < 145 ? 0 : 255;
                    data[i] = data[i+1] = data[i+2] = val;
                }
                
                ctx.putImageData(imageData, 0, 0);
                resolve();
            };
            img.src = URL.createObjectURL(file);
        });
    }

    async function runTesseract(canvas) {
        // è¨­å®š workerï¼Œè·¯å¾‘æŒ‡å‘æœ¬åœ°
        const worker = await Tesseract.createWorker({
            langPath: './', 
            logger: m => {
                if (m.status === 'recognizing text') {
                    document.getElementById('statusBox').innerHTML = `<div class="loader"></div> è¾¨è­˜ä¸­... ${Math.floor(m.progress * 100)}%`;
                }
            }
        });

        await worker.loadLanguage('chi_tra');
        await worker.initialize('chi_tra');
        
        // åƒæ•¸è¨­å®šï¼šä½¿ç”¨ç¨€ç–æ–‡å­—æ¨¡å¼
        await worker.setParameters({
            tessedit_char_whitelist: '0123456789æ—é™³æé»ƒå¼µç‹å³åŠ‰è”¡æ¥Šè¨±é„­è¬éƒ­æ´ªæ›¾é‚±å»–è³´å‘¨å¾è˜‡è‘‰èŠå‘‚æ±Ÿä½•è•­ç¾…é«˜æ½˜ç°¡æœ±é¾å½­æ¸¸è©¹èƒ¡æ–½æ²ˆä½™ç›§æ¢è¶™é¡æŸ¯å­«é­ç¿æˆ´èŒƒå®‹é„§æœä¾¯æ›¹è–›å‚…ä¸æ¸©ç´€è”£æ­è—é€£é¦¬è‘£å¤æ¹¯é–»ç°¡ä¸çŸ¥å±±æ°´æœ¨åœŸé‡‘ç«æ—¥æœˆé½Šå…¨è³‡æ–™æ–°æ”¶æ¡ˆå¯è¤‡è¨º',
            tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT, 
        });

        const { data } = await worker.recognize(canvas);
        await worker.terminate(); // é‡‹æ”¾è¨˜æ†¶é«”

        document.getElementById('statusBox').innerText = "âœ… å®Œæˆï¼";
        
        const parsedData = mergeDataWithColor(data);
        renderTable(parsedData);
        document.getElementById('resultArea').style.display = 'block';
    }

    function mergeDataWithColor(ocrData) {
        const lines = ocrData.lines;
        const results = [];
        const noise = ['ç—…æ­·', 'å§“å', 'è¤‡è¨º', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'æ—¥æœŸ', 'ä¸Šåˆ', 'ä¸‹åˆ', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜', '11412'];

        lines.forEach(line => {
            const text = line.text.replace(/\s+/g, '').trim();
            if (text.length < 5) return;

            const centerY = Math.floor((line.bbox.y0 + line.bbox.y1) / 2);
            let color = null;
            let yCount = 0, oCount = 0;
            // æ“´å¤§åµæ¸¬ç¯„åœï¼Œå› ç‚ºåœ–ç‰‡æ”¾å¤§äº†
            const range = 25; 

            for(let y = centerY - range; y < centerY + range; y++) {
                if (y >= 0 && y < colorMap.length) {
                    if(colorMap[y] === 'yellow') yCount++;
                    if(colorMap[y] === 'orange') oCount++;
                }
            }
            if (yCount > 10) color = 'yellow';
            else if (oCount > 10) color = 'orange';

            const mrnMatch = text.match(/(\d{5,8})/);
            const nameMatch = text.match(/[\u4e00-\u9fa5]{2,4}/);

            if (mrnMatch) {
                let name = '';
                if (nameMatch) {
                    const candidate = nameMatch[0];
                    if (!noise.some(bad => candidate.includes(bad))) { name = candidate; }
                }
                results.push({ mrn: mrnMatch[0], name: name, color: color });
            }
        });
        return results;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="2" style="color:red;text-align:center;">âš ï¸ æœªåµæ¸¬åˆ°è³‡æ–™</td></tr>'; return; }
        
        data.forEach(r => {
            let colorTag = '';
            if (r.color === 'orange') colorTag = '<span class="tag tag-orange">æ©˜è‰²</span>';
            if (r.color === 'yellow') colorTag = '<span class="tag tag-yellow">é»ƒè‰²</span>';

            tbody.innerHTML += `<tr>
                <td><input type="text" value="${r.mrn}"></td>
                <td>
                    <div style="display:flex; align-items:center;">
                        <input type="text" value="${r.name}" style="flex:1;">
                        ${colorTag}
                    </div>
                </td>
            </tr>`;
        });
    }

    function copyResult() {
        const rows = document.querySelectorAll('#tableBody tr');
        let txt = "";
        rows.forEach(r => {
            const inputs = r.querySelectorAll('input');
            const tag = r.querySelector('.tag');
            let color = tag ? tag.innerText : "";
            if(inputs.length) txt += `${inputs[0].value}\t${inputs[1].value}\t${color}\n`;
        });
        if(txt) navigator.clipboard.writeText(txt).then(()=>alert("âœ… å·²è¤‡è£½")).catch(()=>alert("âŒ è¤‡è£½å¤±æ•—"));
    }
</script>

</body>
</html>
