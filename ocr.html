<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·è¾¨è­˜ (ä¿®æ­£ç‰ˆ+è¢å…‰ç­†)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 15px 0; color: #2c3e50; font-size: 1.3rem; text-align: center; font-weight: 800;}
        
        .status-box { background: #e3f2fd; color: #0d47a1; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; text-align: center; border: 1px solid #bbdefb; font-weight: bold;}
        .error-box { background: #fee2e2; color: #b91c1c; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: left; font-size: 14px; border: 1px solid #fecaca; }

        .action-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-camera { background: linear-gradient(135deg, #28a745, #218838); }
        .btn-gallery { background: linear-gradient(135deg, #f39c12, #d35400); }
        
        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; background: white;}

        .preview-area { margin-top: 15px; display: none; text-align: center;}
        canvas { max-width: 100%; border-radius: 8px; border: 1px solid #333; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* çµæœè¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 16px; }
        th { background-color: #f8fafc; color: #64748b; font-size: 14px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; color: #333; }
        
        /* è¢å…‰ç­†æ¨™ç±¤æ¨£å¼ */
        .tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; display: inline-block; font-weight: bold; vertical-align: middle;}
        .tag-orange { background: #ff9800; color: white; border: 1px solid #e65100; }
        .tag-yellow { background: #ffeb3b; color: #333; border: 1px solid #fbc02d; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display:inline-block; vertical-align:middle; margin-right:5px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ğŸ“· ç—…æ­·è¾¨è­˜ (ä¿®æ­£ç‰ˆ+è‰²å½©)</h2>
    
    <div id="statusBox" class="status-box">
        ğŸ’¡ æº–å‚™å°±ç·’ (è«‹ç¢ºä¿å·²ä¸Šå‚³ 16MB å­—åº«)
    </div>
    <div id="errorBox" class="error-box"></div>

    <div class="action-group">
        <button id="btnCam" class="btn-action btn-camera" onclick="startProcess('camera')">
            ğŸ“¸ æ‹ç…§
        </button>
        <button id="btnGal" class="btn-action btn-gallery" onclick="startProcess('gallery')">
            ğŸ–¼ï¸ é¸ç…§ç‰‡
        </button>
    </div>
    
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="loadFile(this)">
    <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="loadFile(this)">

    <div class="preview-area" id="previewArea">
        <div style="font-size:12px; color:#666; margin-bottom:5px;">ğŸ‘‡ è™•ç†å¾Œå½±åƒ (å»èƒŒ+è‰²å½©æ¨™è¨˜) ğŸ‘‡</div>
        <canvas id="processCanvas"></canvas>
    </div>

    <div id="resultArea" style="display:none; margin-top:20px;">
        <h3 style="margin:0 0 10px 0; color:#333; font-size:16px;">âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="35%">ç—…æ­·è™Ÿ</th><th width="65%">å§“å</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="copyResult()" style="flex:1; padding:12px; background:#1a73e8; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ“‹ è¤‡è£½</button>
            <button onclick="location.reload()" style="flex:1; padding:12px; background:#6c757d; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ”„ é‡ä¾†</button>
        </div>
    </div>
</div>

<script>
    let colorMap = []; // å„²å­˜æ¯ä¸€è¡Œçš„é«˜åº¦æ˜¯å¦æœ‰é¡è‰²

    async function startProcess(type) {
        if (type === 'camera') document.getElementById('cameraInput').click();
        else document.getElementById('galleryInput').click();
    }

    function loadFile(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        // é–å®šä»‹é¢
        const btns = document.querySelectorAll('.btn-action');
        btns.forEach(b => { b.disabled = true; b.style.opacity = '0.5'; });
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('errorBox').style.display = 'none';
        
        document.getElementById('statusBox').innerHTML = '<div class="loader"></div> 1. æƒæè¢å…‰ç­†é¡è‰²...';

        setTimeout(() => {
            processImage(file);
        }, 100);
        input.value = '';
    }

    async function processImage(file) {
        try {
            const canvas = document.getElementById('processCanvas');
            // 1. å…ˆåšè‰²å½©åµæ¸¬èˆ‡å½±åƒå¢å¼·
            await enhanceAndDetectColor(file, canvas);
            document.getElementById('previewArea').style.display = 'block';

            // 2. åŸ·è¡Œ OCR
            document.getElementById('statusBox').innerHTML = '<div class="loader"></div> 2. è¼‰å…¥ 16MB æ ¸å¿ƒè¾¨è­˜ä¸­...';
            await runTesseract(canvas);

        } catch (err) {
            console.error(err);
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `<strong>ç™¼ç”ŸéŒ¯èª¤ï¼š</strong><br>${err.message}`;
            document.getElementById('statusBox').innerText = "âŒ å¤±æ•—";
        } finally {
            const btns = document.querySelectorAll('.btn-action');
            btns.forEach(b => { b.disabled = false; b.style.opacity = '1'; });
        }
    }

    // ğŸ”¥ æ­¥é©Ÿä¸€ï¼šå½±åƒè™•ç†èˆ‡è‰²å½©åµæ¸¬
    function enhanceAndDetectColor(file, canvas) {
        return new Promise((resolve) => {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                const targetWidth = 1000; // è§£æåº¦è¨­å®š
                const scale = targetWidth / img.width;
                canvas.width = targetWidth;
                canvas.height = img.height * scale;
                
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const width = canvas.width;
                const height = canvas.height;
                
                // åˆå§‹åŒ–é¡è‰²åœ°åœ– (ç´€éŒ„æ¯ä¸€è¡Œæ˜¯å¦æœ‰é¡è‰²)
                colorMap = new Array(height).fill(null);

                for (let y = 0; y < height; y++) {
                    let orangeScore = 0;
                    let yellowScore = 0;
                    
                    // æ¯è¡ŒæŠ½æ¨£æª¢æŸ¥ (æ¯5å€‹åƒç´ æª¢æŸ¥ä¸€æ¬¡)
                    for (let x = 0; x < width; x += 5) {
                        const i = (y * width + x) * 4;
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];

                        // --- A. è‰²å½©åµæ¸¬é‚è¼¯ ---
                        // é»ƒè‰²: ç´…ç¶ éƒ½å¾ˆé«˜ï¼Œè—å¾ˆä½
                        if (r > 180 && g > 180 && b < 150) {
                            if (Math.abs(r - g) < 40) yellowScore++;
                        }
                        // æ©˜è‰²: ç´…å¾ˆé«˜ï¼Œç¶ ä¸­ç­‰ï¼Œè—ä½
                        else if (r > 200 && g > 100 && g < 180 && b < 100) {
                            orangeScore++;
                        }
                    }
                    
                    // å¦‚æœé€™ä¸€è¡Œæœ‰å¾ˆå¤šé»ƒè‰²æˆ–æ©˜è‰²é»ï¼Œå°±æ¨™è¨˜èµ·ä¾†
                    if (orangeScore > 10) colorMap[y] = 'orange';
                    else if (yellowScore > 10) colorMap[y] = 'yellow';
                }

                // --- B. å½±åƒäºŒå€¼åŒ– (è®“æ–‡å­—è®Šé»‘ç™½ä»¥åˆ©è¾¨è­˜) ---
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                    // å¢å¼·å°æ¯”ï¼šä½æ–¼120è®Šé»‘ï¼Œé«˜æ–¼120è®Šç™½
                    const val = gray < 130 ? 0 : 255;
                    data[i] = data[i+1] = data[i+2] = val;
                }
                
                ctx.putImageData(imageData, 0, 0);
                resolve();
            };
            img.src = URL.createObjectURL(file);
        });
    }

    // ğŸ”¥ æ­¥é©ŸäºŒï¼šåŸ·è¡Œ OCR (ä¿®æ­£ç‰ˆ)
    async function runTesseract(canvas) {
        // ä½¿ç”¨ createWorker (v5å¯«æ³•)
        const worker = await Tesseract.createWorker({
            langPath: './', // é‡è¦ï¼šè¨­å®šç‚ºæœ¬åœ°ç›®éŒ„ï¼Œè®€å– chi_tra.traineddata.gz
            logger: m => {
                if (m.status === 'recognizing text') {
                    document.getElementById('statusBox').innerHTML = `<div class="loader"></div> è¾¨è­˜ä¸­... ${Math.floor(m.progress * 100)}%`;
                }
            }
        });

        // è¼‰å…¥èªè¨€åŒ…
        try {
            await worker.loadLanguage('chi_tra');
        } catch (e) {
            throw new Error("æ‰¾ä¸åˆ°èªè¨€åŒ…ï¼è«‹ç¢ºèª GitHub ä¸Šæœ‰ chi_tra.traineddata.gz");
        }
        
        await worker.initialize('chi_tra');
        
        // è¨­å®šåƒæ•¸ (åªæŠ“æ•¸å­—å’Œå¸¸è¦‹æ¼¢å­—)
        await worker.setParameters({
            tessedit_char_whitelist: '0123456789æ—é™³æé»ƒå¼µç‹å³åŠ‰è”¡æ¥Šè¨±é„­è¬éƒ­æ´ªæ›¾é‚±å»–è³´å‘¨å¾è˜‡è‘‰èŠå‘‚æ±Ÿä½•è•­ç¾…é«˜æ½˜ç°¡æœ±é¾å½­æ¸¸è©¹èƒ¡æ–½æ²ˆä½™ç›§æ¢è¶™é¡æŸ¯å­«é­ç¿æˆ´èŒƒå®‹é„§æœä¾¯æ›¹è–›å‚…ä¸æ¸©ç´€è”£æ­è—é€£é¦¬è‘£å¤æ¹¯é–»ç°¡ä¸çŸ¥å±±æ°´æœ¨åœŸé‡‘ç«æ—¥æœˆé½Šå…¨è³‡æ–™æ–°æ”¶æ¡ˆå¯è¤‡è¨º',
            tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT, 
        });

        const { data } = await worker.recognize(canvas);
        await worker.terminate();

        document.getElementById('statusBox').innerText = "âœ… å®Œæˆï¼";
        
        // è§£æè³‡æ–™ä¸¦çµåˆé¡è‰²
        const parsedData = mergeDataWithColor(data);
        renderTable(parsedData);
        document.getElementById('resultArea').style.display = 'block';
    }

    function mergeDataWithColor(ocrData) {
        const lines = ocrData.lines;
        const results = [];
        const noise = ['ç—…æ­·', 'å§“å', 'è¤‡è¨º', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'æ—¥æœŸ', 'ä¸Šåˆ', 'ä¸‹åˆ', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜', '11412'];

        lines.forEach(line => {
            const text = line.text.replace(/\s+/g, '').trim();
            if (text.length < 5) return;

            // æ‰¾å‡ºé€™è¡Œå­—çš„ Y è»¸ä¸­å¿ƒé»
            const centerY = Math.floor((line.bbox.y0 + line.bbox.y1) / 2);
            
            // æª¢æŸ¥è©²é«˜åº¦æ˜¯å¦æœ‰é¡è‰² (ç¯„åœ +/- 10px)
            let color = null;
            let yCount = 0, oCount = 0;
            for(let y = centerY - 10; y < centerY + 10; y++) {
                if (y >= 0 && y < colorMap.length) {
                    if(colorMap[y] === 'yellow') yCount++;
                    if(colorMap[y] === 'orange') oCount++;
                }
            }
            if (yCount > 5) color = 'yellow';
            if (oCount > 5) color = 'orange';

            const mrnMatch = text.match(/(\d{5,8})/);
            const nameMatch = text.match(/[\u4e00-\u9fa5]{2,4}/);

            if (mrnMatch) {
                let name = '';
                if (nameMatch) {
                    const candidate = nameMatch[0];
                    if (!noise.some(bad => candidate.includes(bad))) { name = candidate; }
                }
                results.push({ mrn: mrnMatch[0], name: name, color: color });
            }
        });
        return results;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="2" style="color:red;text-align:center;">âš ï¸ æœªåµæ¸¬åˆ°è³‡æ–™</td></tr>'; return; }
        
        data.forEach(r => {
            let colorTag = '';
            if (r.color === 'orange') colorTag = '<span class="tag tag-orange">æ©˜è‰²</span>';
            if (r.color === 'yellow') colorTag = '<span class="tag tag-yellow">é»ƒè‰²</span>';

            tbody.innerHTML += `<tr>
                <td><input type="text" value="${r.mrn}"></td>
                <td>
                    <div style="display:flex; align-items:center;">
                        <input type="text" value="${r.name}" style="flex:1;">
                        ${colorTag}
                    </div>
                </td>
            </tr>`;
        });
    }

    function copyResult() {
        const rows = document.querySelectorAll('#tableBody tr');
        let txt = "";
        rows.forEach(r => {
            const inputs = r.querySelectorAll('input');
            const tag = r.querySelector('.tag');
            let color = tag ? tag.innerText : "";
            if(inputs.length) txt += `${inputs[0].value}\t${inputs[1].value}\t${color}\n`;
        });
        if(txt) navigator.clipboard.writeText(txt).then(()=>alert("âœ… å·²è¤‡è£½")).catch(()=>alert("âŒ è¤‡è£½å¤±æ•—"));
    }
</script>

</body>
</html>
