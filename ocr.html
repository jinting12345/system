<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æ­·è¾¨è­˜ (æŠ—é™°å½±å¢å¼·ç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/browser-image-compression/2.0.2/browser-image-compression.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { margin: 0 0 15px 0; color: #1a73e8; font-size: 1.3rem; text-align: center; }
        
        .status-box { background: #e8f0fe; color: #1557b0; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; text-align: center; border: 1px solid #d2e3fc; font-weight: bold;}
        
        /* é›™æŒ‰éˆ• */
        .action-group { display: flex; gap: 12px; margin-top: 20px; }
        .btn-action { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-camera { background: linear-gradient(135deg, #28a745, #218838); }
        .btn-gallery { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
        .btn-disabled { background: #ccc; cursor: not-allowed; pointer-events: none; }

        .btn-back { display:inline-block; margin-bottom:15px; text-decoration:none; color:#666; font-size:14px; padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; background: white;}

        .preview-area { margin-top: 15px; text-align: center; display: none; }
        canvas { max-width: 100%; border-radius: 8px; border: 1px solid #333; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 16px; }
        th { background-color: #f8fafc; color: #64748b; font-size: 14px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; color: #333; }
    </style>
</head>
<body>

<a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

<div class="card">
    <h2>ğŸ“· ç—…æ­·è¾¨è­˜ (æŠ—é™°å½±ç‰ˆ)</h2>
    
    <div id="statusBox" class="status-box">
        ğŸš€ æº–å‚™å°±ç·’ (è«‹ç¢ºèª GitHub å­—åº«å·²ä¸Šå‚³)
    </div>

    <div class="action-group">
        <button id="btnCam" class="btn-action btn-camera" onclick="startOCR('camera')">
            <span style="font-size:24px">ğŸ“¸</span> æ‹ ç…§
        </button>
        <button id="btnGal" class="btn-action btn-gallery" onclick="startOCR('gallery')">
            <span style="font-size:24px">ğŸ–¼ï¸</span> é¸ç…§ç‰‡
        </button>
    </div>
    
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="processImage(this)">
    <input type="file" id="galleryInput" accept="image/*" style="display:none" onchange="processImage(this)">

    <div class="preview-area" id="previewArea">
        <p style="font-size:12px; color:#999; margin:5px 0;">å½±åƒè™•ç†é è¦½ (ä¿ç•™ç°éšç´°ç¯€)â†“</p>
        <canvas id="processCanvas"></canvas>
    </div>

    <div id="resultArea" style="display:none; margin-top:20px;">
        <h3 style="margin:0 0 10px 0; color:#333; font-size:16px;">âœ… è¾¨è­˜çµæœ</h3>
        <table id="resultTable">
            <thead>
                <tr><th width="35%">ç—…æ­·è™Ÿ</th><th width="50%">å§“å</th><th width="15%"></th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="copyResult()" style="flex:1; padding:12px; background:#1a73e8; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ“‹ è¤‡è£½</button>
            <button onclick="location.reload()" style="flex:1; padding:12px; background:#6c757d; color:white; border:none; border-radius:8px; font-weight:bold;">ğŸ”„ é‡ä¾†</button>
        </div>
    </div>
</div>

<script>
    async function startOCR(type) {
        if (type === 'camera') document.getElementById('cameraInput').click();
        else document.getElementById('galleryInput').click();
    }

    async function processImage(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];

        // é–å®šä»‹é¢
        const btns = document.querySelectorAll('.btn-action');
        btns.forEach(b => b.classList.add('btn-disabled'));
        document.getElementById('resultArea').style.display = 'none';
        
        try {
            updateStatus("è™•ç†åœ–ç‰‡é™°å½±...");
            const canvas = document.getElementById('processCanvas');
            await imageProcessing(file, canvas);
            document.getElementById('previewArea').style.display = 'block';

            await runTesseract(canvas);

        } catch (err) {
            console.error(err);
            alert("éŒ¯èª¤ï¼š" + err.message);
            updateStatus("âŒ ç™¼ç”ŸéŒ¯èª¤");
        } finally {
            btns.forEach(b => b.classList.remove('btn-disabled'));
        }
        input.value = '';
    }

    // ğŸ”¥ é‡é»ä¿®æ”¹ï¼šåªåšç¸®æ”¾å’Œè¼•å¾®å°æ¯”åº¦èª¿æ•´ï¼Œä¸åšæš´åŠ›äºŒå€¼åŒ–
    function imageProcessing(file, canvas) {
        return new Promise((resolve) => {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                const maxWidth = 1000; // ç¨å¾®æé«˜è§£æåº¦ä»¥è¾¨è­˜è¡¨æ ¼
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                
                // 1. ç¹ªè£½åŸåœ–
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // 2. è½‰ç°éš (ä½†ä¸è½‰é»‘ç™½)
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    // ç°¡å–®çš„å°æ¯”åº¦å¢å¼·ï¼Œä½†ä¿ç•™ç°éšéæ¸¡ï¼Œé¿å…é™°å½±è®Šå…¨é»‘
                    let color = avg;
                    if (color > 150) color = 255; // æŠŠæ·ºç°èƒŒæ™¯è®Šç™½
                    // æ·±è‰²å­—é«”å’Œé™°å½±ä¿ç•™åŸæ¨£ï¼Œè®“ OCR å¼•æ“è‡ªå·±å»åˆ‡åˆ†
                    
                    data[i] = color;
                    data[i + 1] = color;
                    data[i + 2] = color;
                }
                ctx.putImageData(imageData, 0, 0);
                resolve();
            };
            img.src = URL.createObjectURL(file);
        });
    }

    async function runTesseract(canvasElement) {
        updateStatus("å•Ÿå‹• Tesseract v5...");
        
        const worker = await Tesseract.createWorker({
            langPath: './', 
            gzip: false, 
            logger: m => {
                if (m.status === 'recognizing text') {
                    updateStatus(`è¾¨è­˜ä¸­... ${Math.floor(m.progress * 100)}%`);
                }
            }
        });
        
        await worker.loadLanguage('chi_tra');
        await worker.initialize('chi_tra');
        
        // è¨­å®šåƒæ•¸ï¼šåªå…è¨±æ•¸å­—å’Œç¹é«”ä¸­æ–‡ï¼Œä¸¦å˜—è©¦ä¿ç•™è¡¨æ ¼çµæ§‹
        await worker.setParameters({
            tessedit_char_whitelist: '0123456789æ—é™³æé»ƒå¼µç‹å³åŠ‰è”¡æ¥Šè¨±é„­è¬éƒ­æ´ªæ›¾é‚±å»–è³´å‘¨å¾è˜‡è‘‰èŠå‘‚æ±Ÿä½•è•­ç¾…é«˜æ½˜ç°¡æœ±é¾å½­æ¸¸è©¹èƒ¡æ–½æ²ˆä½™ç›§æ¢è¶™é¡æŸ¯å­«é­ç¿æˆ´èŒƒå®‹é„§æœä¾¯æ›¹è–›å‚…ä¸æ¸©ç´€è”£æ­è—é€£é¦¬è‘£å¤æ¹¯é–»ç°¡ä¸çŸ¥å±±æ°´æœ¨åœŸé‡‘ç«æ—¥æœˆé½Šå…¨è³‡æ–™æ–°æ”¶æ¡ˆå¯é»æ¥šè»’é¦¨å‹è¦‹é¦™å¦‚å¯¶ç |',
            tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT, // é‡å°ç¨€ç–æ–‡å­—(è¡¨æ ¼)çš„æœ€ä½³æ¨¡å¼
        });

        const { data: { text } } = await worker.recognize(canvasElement);
        await worker.terminate();

        updateStatus("âœ… å®Œæˆï¼");
        const data = parseData(text);
        renderTable(data);
        document.getElementById('resultArea').style.display = 'block';
    }

    function updateStatus(msg) {
        document.getElementById('statusBox').innerText = msg;
    }

    function parseData(text) {
        // å…ˆç§»é™¤æ‰æ‰€æœ‰ç©ºç™½ï¼Œè®Šæˆä¸€é•·ä¸²å­—å…ƒï¼Œå†ä¾†åˆ‡
        // å› ç‚ºè¡¨æ ¼ç·š | å¸¸å¸¸æœƒæŠŠæ•¸å­—åˆ‡æ–·
        const lines = text.split(/\r?\n/);
        const data = [];
        const noise = ['ç—…æ­·', 'å§“å', 'è¤‡è¨º', 'æ”¶æ¡ˆ', 'é†«å¸«', 'ç¢ºèª', 'æ—¥æœŸ', 'ä¸Šåˆ', 'ä¸‹åˆ', 'å–®å…§', 'åˆä½µ', 'è¨»è¨˜', 'è³‡æ–™', 'é½Šå…¨'];

        lines.forEach(line => {
            // ç§»é™¤æ‰€æœ‰ç©ºæ ¼
            let clean = line.replace(/\s+/g, '');
            // æŠŠ | æ›æˆç©ºå­—ä¸²
            clean = clean.replace(/\|/g, ''); 
            
            if (clean.length < 4) return;

            // æŠ“å– 5-8 ä½æ•¸å­—
            const mrnMatch = clean.match(/(\d{5,8})/);
            
            // æŠ“å–ä¸­æ–‡å§“å (2-4å€‹å­—)
            // æ’é™¤æ‰å¸¸è¦‹çš„æ¨™é¡Œå­—
            const nameMatch = clean.match(/[\u4e00-\u9fa5]{2,4}/g);

            if (mrnMatch) {
                let validName = '';
                if (nameMatch) {
                    // æ‰¾å‡ºä¸åŒ…å«é›œè¨Šè©çš„å§“å
                    for (let name of nameMatch) {
                        if (!noise.some(bad => name.includes(bad))) {
                            validName = name;
                            break; // æ‰¾åˆ°ç¬¬ä¸€å€‹åƒåå­—çš„å°±åœ
                        }
                    }
                }
                
                // åªæœ‰ç•¶åå­—å’Œç—…æ­·è™Ÿéƒ½æŠ“åˆ°æ‰ç®—æˆåŠŸ (æˆ–è€…æ‚¨å¯ä»¥æ”¾å¯¬æ¨™æº–)
                if (validName) {
                    data.push({ mrn: mrnMatch[0], name: validName });
                }
            }
        });
        return data;
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="color:red;text-align:center;">âš ï¸ æœªåµæ¸¬åˆ°æœ‰æ•ˆè³‡æ–™<br>è«‹ç¢ºèªç…§ç‰‡æ–¹å‘æ­£ç¢º</td></tr>';
            return;
        }
        data.forEach(r => {
            tbody.innerHTML += `<tr>
                <td><input type="text" value="${r.mrn}"></td>
                <td><input type="text" value="${r.name}"></td>
                <td onclick="this.parentElement.remove()" style="text-align:center;font-size:1.2em;color:red;">Ã—</td>
            </tr>`;
        });
    }

    function copyResult() {
        const rows = document.querySelectorAll('#tableBody tr');
        let txt = "";
        rows.forEach(r => {
            const i = r.querySelectorAll('input');
            if(i.length) txt += `${i[0].value}\t${i[1].value}\n`;
        });
        if(txt) navigator.clipboard.writeText(txt).then(()=>alert("âœ… å·²è¤‡è£½")).catch(()=>alert("âŒ è¤‡è£½å¤±æ•—"));
    }
</script>

</body>
</html>
