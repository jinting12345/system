<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§åˆç´„ç”¢ç”Ÿå™¨ (æ·±åº¦é™¤éŒ¯ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .btn { color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; transition: 0.3s; margin-top: 10px; }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; }
        /* åŠ å¤§é™¤éŒ¯è¦–çª—ï¼Œæ–¹ä¾¿é–±è®€ */
        .debug { margin-top: 20px; padding: 15px; background: #333; color: #0f0; border-radius: 4px; font-size: 14px; max-height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="section">
        <h2>æ­¥é©Ÿ 1:ä¸Šå‚³ PDF (æ·±åº¦é™¤éŒ¯æ¨¡å¼)</h2>
        <div class="upload-area">
            <p>è«‹ä¸Šå‚³ PDFï¼Œä¸¦è§€å¯Ÿä¸‹æ–¹é»‘è‰²è¦–çª—çš„è¼¸å‡º</p>
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-primary" onclick="parsePDF()">ğŸ“‚ è®€å–ä¸¦æª¢æ¸¬</button>
        </div>
        <div id="debug" class="debug">ç­‰å¾…åŸ·è¡Œ...</div>
    </div>

    <div class="section">
        <h2>æ­¥é©Ÿ 2:ç¢ºèªè³‡æ–™</h2>
        <div class="form-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="user_name"></div>
        <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="user_id"></div>
        <div class="form-group"><label>å€‹æ¡ˆé›»è©±</label><input type="text" id="user_phone"></div>
        <div class="form-group">
            <label>éƒ¨åˆ†è² æ“”</label>
            <select id="payment">
                <option value="240">240 (ç¬¬ä¸‰é¡)</option>
                <option value="75">75 (ç¬¬äºŒé¡)</option>
                <option value="0">0 (ç¬¬ä¸€é¡)</option>
            </select>
        </div>
        <div class="form-group"><label>ç°½ç´„äººå§“å</label><input type="text" id="contractor_name"></div>
        <div class="form-group"><label>ç°½ç´„äººé›»è©±</label><input type="text" id="contractor_phone"></div>
        <div class="form-group"><label>æˆ¶ç±åœ°å€</label><input type="text" id="household_address"></div>
        <div class="form-group"><label>é€šè¨Šåœ°å€</label><input type="text" id="contact_address"></div>
        <div class="form-group"><label>è¨ªè¦–æ—¥æœŸ</label><input type="text" id="visit_date"></div>
        <button class="btn btn-success" onclick="generateWord()">ğŸ“ ä¸‹è¼‰ Word</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://oipnjnwootorawargsxe.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII'; 
        const BUCKET_NAME = 'system_files'; 
        const TEMPLATE_NAME = 'template.docx';
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        window.onload = function() {
            const today = new Date();
            const rocYear = today.getFullYear() - 1911;
            document.getElementById('visit_date').value = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
        };

        function showDebug(msg) {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            // åŠ ä¸Šæ™‚é–“æˆ³è¨˜ï¼Œæ–¹ä¾¿çœ‹é †åº
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `[${time}] ${msg}\n`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            const debugDiv = document.getElementById('debug');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!");
                return;
            }

            btn.innerText = "åˆ†æä¸­...";
            btn.disabled = true;
            debugDiv.innerHTML = "=== é–‹å§‹é™¤éŒ¯åˆ†æ ===\n";

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = ""; 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    // é€™è£¡æ”¹ç”¨ç©ºå­—ä¸²é€£æ¥ï¼Œä¸¦ç§»é™¤æ‰€æœ‰ç©ºç™½ï¼Œé‚„åŸæœ€åŸå§‹çš„æ–‡å­—æµ
                    const pageStr = textContent.items.map(item => item.str).join(""); 
                    fullText += pageStr;
                }

                // ç§»é™¤æ‰€æœ‰æ›è¡Œå’Œç©ºç™½ï¼Œè®“è³‡æ–™è®Šæˆä¸€æ¢é•·é¾
                const cleanText = fullText.replace(/[\s\n\r]/g, "");
                
                showDebug(`âœ“ PDF è®€å–å®Œæˆï¼Œç¸½å­—æ•¸: ${cleanText.length}`);
                
                // â˜…â˜…â˜… é™¤éŒ¯é‡é» 1: å°å‡ºå‰ 300 å€‹å­—æª¢æŸ¥è¡¨é ­ â˜…â˜…â˜…
                showDebug(`\n--- [å‰300å­—é è¦½] ---\n${cleanText.substring(0, 300)}...\n------------------`);

                // è§£æåŸºæœ¬æ¬„ä½
                let userName = "", userId = "", userPhone = "";
                const headerMatch = cleanText.match(/å§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?([^\/]+)\/([A-Z][0-9]{9})/);
                if (headerMatch) { userName = headerMatch[1]; userId = headerMatch[2]; }
                const phoneMatch = cleanText.match
