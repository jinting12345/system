// â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šé‡å°é•·ç…§å¹³å° PDF çš„å¼·åŠ›è§£æé‚è¼¯ â˜…â˜…â˜…
        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆï¼");
                return;
            }

            btn.innerText = "è§£æä¸­...";
            btn.disabled = true;

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = ""; 
                
                // è®€å–æ¯ä¸€é 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    // ä¿ç•™åŸæœ¬çš„æ–‡å­—é †åºï¼Œç”¨æ›è¡Œåˆ†é–‹
                    const pageStr = textContent.items.map(item => item.str).join("\n"); 
                    fullText += pageStr + "\n";
                }

                // â˜… é—œéµæŠ€å·§ï¼šå»ºç«‹ä¸€å€‹ã€Œå»é™¤æ‰€æœ‰ç©ºç™½èˆ‡æ›è¡Œã€çš„ä¹¾æ·¨å­—ä¸²ï¼Œå°ˆé–€ç”¨ä¾†æ‰¾å›ºå®šæ ¼å¼ â˜…
                // é€™æ¨£å¯ä»¥é¿å… PDF æ’ç‰ˆé€ æˆçš„ç©ºç™½å¹²æ“¾
                const cleanText = fullText.replace(/\s+/g, "");

                console.log("åŸå§‹é•·åº¦:", fullText.length, "æ¸…ç†å¾Œé•·åº¦:", cleanText.length);

                // --- è®Šæ•¸åˆå§‹åŒ– ---
                let userName = "";
                let userId = "";
                let userPhone = "";
                let householdAddress = "";
                let contactAddress = "";
                let paymentVal = "240";
                let contractorName = "";
                let contractorPhone = "";

                // ==========================================
                // ç­–ç•¥ 1ï¼šå§“åèˆ‡èº«åˆ†è­‰ (ä½¿ç”¨ cleanText æœ€æº–)
                // ==========================================
                // PDF æœ€ä¸Šæ–¹é€šå¸¸æœ‰ä¸€è¡Œï¼š "å€‹æ¡ˆå§“å/èº«åˆ†è­‰å­—è™Ÿ:å³ç§€æ/S201821350"
                // é€™æ˜¯æœ€å®Œç¾çš„éŒ¨é»ï¼Œæˆ‘å€‘å„ªå…ˆæŠ“é€™è£¡
                
                const headerMatch = cleanText.match(/å€‹æ¡ˆå§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?([^\/]+)\/([A-Z][0-9]{9})/);
                
                if (headerMatch) {
                    userName = headerMatch[1].trim();
                    userId = headerMatch[2].trim();
                    console.log("â˜… ç­–ç•¥1 (è¡¨é ­) æˆåŠŸ:", userName, userId);
                } else {
                    // å‚™ç”¨ç­–ç•¥ï¼šå¦‚æœåœ¨è¡¨é ­æ²’æŠ“åˆ°ï¼Œæ‰å»å…§æ–‡æ‰¾
                    // é€™è£¡è¦ç‰¹åˆ¥å°å¿ƒ "å‚³çµ±å§“å" é€™å€‹å¹²æ“¾å­—
                    const nameMatch = fullText.match(/å€‹æ¡ˆå§“å\s*[:ï¼š]?\s*([^\s]+)/);
                    if (nameMatch) {
                        let potentialName = nameMatch[1].trim();
                        // å¦‚æœæŠ“åˆ° "å‚³çµ±å§“å" æˆ– "/"ï¼Œå°±å¾€å¾Œæ‰¾ä¸‹ä¸€å€‹è©
                        if (potentialName.includes("å‚³çµ±å§“å") || potentialName === "/") {
                            // å˜—è©¦ç”¨æ›´è¤‡é›œçš„ Regex ç•¥é "å‚³çµ±å§“å"
                            const deepMatch = fullText.match(/å€‹æ¡ˆå§“å.*?å‚³çµ±å§“å\s*([^\s]+)/s);
                            if (deepMatch) potentialName = deepMatch[1].trim();
                        }
                        if (!userName) userName = potentialName;
                    }
                    
                    const idMatch = cleanText.match(/([A-Z][0-9]{9})/);
                    if (idMatch && !userId) userId = idMatch[1];
                }

                // ==========================================
                // ç­–ç•¥ 2ï¼šé›»è©± (ä½¿ç”¨ cleanText)
                // ==========================================
                // å…ˆæ‰¾ "å€‹æ¡ˆé›»è©±" å¾Œé¢çš„ 09xxxxxxxx
                // cleanText è£¡æœƒè®Šæˆ "å€‹æ¡ˆé›»è©±0913935315" é€™ç¨®æ ¼å¼ï¼Œéå¸¸å¥½æŠ“
                const phoneBlockMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
                
                if (phoneBlockMatch) {
                    userPhone = phoneBlockMatch[1];
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±å…¨åŸŸæœå°‹ 09 é–‹é ­çš„æ‰‹æ©Ÿ
                    const fallbackPhone = cleanText.match(/(09\d{8})/);
                    if (fallbackPhone) userPhone = fallbackPhone[1];
                }

                // ==========================================
                // ç­–ç•¥ 3ï¼šåœ°å€ (å¿…é ˆä½¿ç”¨ fullText ä¿ç•™è·¯åå®Œæ•´æ€§)
                // ==========================================
                // åœ°å€å¾Œé¢é€šå¸¸æ¥è‘— "â€»(é‡Œã€é„°..." é€™äº›æç¤ºå­—ï¼Œæˆ‘å€‘æŠŠå®ƒç•¶ä½œçµæŸé»
                
                // æˆ¶ç±åœ°å€
                const hMatch = fullText.match(/æˆ¶ç±åœ°å€\s*([\u4e00-\u9fa5\d]+[ç¸£å¸‚][^â€»\n]+)/);
                if (hMatch) {
                    householdAddress = hMatch[1].replace(/[:ï¼š]/g, "").trim();
                }

                // é€šè¨Šåœ°å€ (å±…ä½(é€šè¨Š)åœ°)
                const cMatch = fullText.match(/å±…ä½\(é€šè¨Š\)åœ°\s*å€?\s*([\u4e00-\u9fa5\d]+[ç¸£å¸‚][^â€»\n]+)/);
                if (cMatch) {
                    let raw = cMatch[1];
                    // ç§»é™¤æ‹¬è™Ÿå…§çš„éƒµéå€è™Ÿ (826) é€™ç¨®é›œè¨Š
                    raw = raw.replace(/\(éƒµéå€è™Ÿ[:ï¼š]?\d*\)/g, "");
                    contactAddress = raw.trim();
                }

                // ==========================================
                // ç­–ç•¥ 4ï¼šè²»ç”¨ç­‰ç´š (ç¬¬Xé¡)
                // ==========================================
                if (cleanText.includes("ç¬¬ä¸€é¡")) paymentVal = "0";
                else if (cleanText.includes("ç¬¬äºŒé¡")) paymentVal = "75";
                else if (cleanText.includes("ç¬¬ä¸‰é¡")) paymentVal = "240";

                // ==========================================
                // ç­–ç•¥ 5ï¼šä»£ç†äºº
                // ==========================================
                const agentMatch = cleanText.match(/ä»£ç†äººå§“å([^\s]+)/);
                if (agentMatch) {
                    // ç¢ºä¿æŠ“åˆ°çš„ä¸æ˜¯ "ä»£ç†äººèº«åˆ†è­‰" é€™ç¨®æ¨™é¡Œ
                    let agentName = agentMatch[1];
                    if (!agentName.includes("èº«åˆ†è­‰") && !agentName.includes("é›»è©±")) {
                        contractorName = agentName;
                    } else {
                        contractorName = userName; // æ²’æŠ“åˆ°å°±ç”¨æœ¬äºº
                    }
                    
                    // ä»£ç†äººé›»è©±
                    const agentPhoneMatch = cleanText.match(/ä»£ç†äººæ‰‹æ©Ÿ(09\d{8})/);
                    if (agentPhoneMatch) contractorPhone = agentPhoneMatch[1];
                    else contractorPhone = userPhone;
                } else {
                    contractorName = userName;
                    contractorPhone = userPhone;
                }

                // --- å¡«å…¥è¡¨å–® ---
                // ç¢ºä¿ä¸æœƒå¡«å…¥ undefined
                document.getElementById('user_name').value = userName || "";
                document.getElementById('user_id').value = userId || "";
                document.getElementById('user_phone').value = userPhone || "";
                document.getElementById('payment').value = paymentVal;
                document.getElementById('contractor_name').value = contractorName || userName || "";
                document.getElementById('contractor_phone').value = contractorPhone || userPhone || "";
                document.getElementById('household_address').value = householdAddress || "";
                document.getElementById('contact_address').value = contactAddress || "";

                if(userName) {
                    alert(`è§£ææˆåŠŸï¼\nå§“åï¼š${userName}\né›»è©±ï¼š${userPhone}`);
                } else {
                    alert("è§£æå®Œæˆï¼Œä½†è³‡æ–™å¯èƒ½æœ‰ç¼ºæ¼ï¼Œè«‹æ‰‹å‹•ç¢ºèªã€‚");
                }

            } catch (err) {
                console.error(err);
                alert("è®€å– PDF å¤±æ•—ï¼š" + err.message);
            } finally {
                btn.innerText = "ğŸ“‚ è®€å– PDF è³‡æ–™";
                btn.disabled = false;
            }
        }
