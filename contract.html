<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§åˆç´„ç”¢ç”Ÿå™¨ (PDFè‡ªå‹•ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        .section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; transition: 0.3s; margin-top: 10px; }
        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* PDF ä¸Šå‚³å€å¡Š */
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; }
        .upload-area:hover { border-color: #007bff; background: #e9ecef; }
    </style>
</head>
<body>

    <div class="section">
        <h2>æ­¥é©Ÿ 1ï¼šä¸Šå‚³ PDF è‡ªå‹•å¸¶å…¥è³‡æ–™</h2>
        <div class="upload-area">
            <p>è«‹é¸æ“‡å€‹æ¡ˆçš„ PDF è©•ä¼°æª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•æ“·å–è³‡æ–™ã€‚</p>
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-primary" onclick="parsePDF()">ğŸ“‚ è®€å– PDF è³‡æ–™</button>
        </div>
    </div>

    <div class="section">
        <h2>æ­¥é©Ÿ 2ï¼šç¢ºèªä¸¦ä¿®æ”¹è³‡æ–™</h2>

        <div class="form-group">
            <label>å€‹æ¡ˆå§“å</label>
            <input type="text" id="user_name" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>èº«åˆ†è­‰å­—è™Ÿ</label>
            <input type="text" id="user_id" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>å€‹æ¡ˆé›»è©±</label>
            <input type="text" id="user_phone" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>éƒ¨åˆ†è² æ“” (å…ƒ)</label>
            <select id="payment">
                <option value="240">240 (ç¬¬ä¸‰é¡/ä¸€èˆ¬)</option>
                <option value="75">75 (ç¬¬äºŒé¡/ä¸­ä½æ”¶)</option>
                <option value="0">0 (ç¬¬ä¸€é¡/ä½æ”¶)</option>
            </select>
        </div>

        <div class="form-group">
            <label>ç°½ç´„äººå§“å</label>
            <input type="text" id="contractor_name" placeholder="é è¨­åŒå€‹æ¡ˆ" />
        </div>

        <div class="form-group">
            <label>ç°½ç´„äººé›»è©±</label>
            <input type="text" id="contractor_phone" placeholder="é è¨­åŒå€‹æ¡ˆ" />
        </div>

        <div class="form-group">
            <label>æˆ¶ç±åœ°å€</label>
            <input type="text" id="household_address" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>é€šè¨Šåœ°å€</label>
            <input type="text" id="contact_address" placeholder="ç­‰å¾…è®€å–..." />
        </div>

        <div class="form-group">
            <label>è¨ªè¦–æ—¥æœŸ (é è¨­ä»Šæ—¥)</label>
            <input type="text" id="visit_date">
        </div>

        <button class="btn btn-success" onclick="generateWord()">ğŸ“ ä¸‹è¼‰ Word å¥‘ç´„æ›¸</button>
    </div>

    <script>
        // ================= è¨­å®šå€ (è«‹ç¢ºèªé€™è£¡æ˜¯å¦æ­£ç¢º) =================
        const SUPABASE_URL = 'https://oipnjnwootorawargsxe.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII'; // è«‹ç¢ºèªæ‚¨çš„ Key
        const BUCKET_NAME = 'system_files'; 
        const TEMPLATE_NAME = 'template.docx';
        
        // è¨­å®š PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        // =============================================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // åˆå§‹åŒ–æ—¥æœŸ
        window.onload = function() {
            const today = new Date();
            const rocYear = today.getFullYear() - 1911;
            const dateStr = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            document.getElementById('visit_date').value = dateStr;
        };

        // --- åŠŸèƒ½ A: è§£æ PDF ---
        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆï¼");
                return;
            }

            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = "";
                let page1Text = "";
                let page13Text = "";

                // è®€å–æ¯ä¸€é æ–‡å­—
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageStr = textContent.items.map(item => item.str).join(" ");
                    fullText += pageStr + "\n";
                    if (i === 1) page1Text = pageStr;
                    if (i === 13) page13Text = pageStr;
                }

                console.log("PDF è®€å–å®Œæˆ");

                // --- æ­£è¦è¡¨é”å¼æŠ“å–è³‡æ–™ (èˆ‡ Python é‚è¼¯å°æ‡‰) ---
                
                // 1. å§“å
                let userName = "";
                const nameMatch = fullText.match(/å€‹æ¡ˆå§“å[:ï¼š]?\s*([^\s/]+)/);
                if (nameMatch) userName = nameMatch[1].trim();

                // 2. èº«åˆ†è­‰
                let userId = "";
                const idMatch = fullText.match(/([A-Z][0-9]{9})/);
                if (idMatch) userId = idMatch[1].trim();

                // 3. é›»è©±
                let userPhone = "";
                const phoneMatch = fullText.match(/(09\d{8}|0\d{1,2}-?\d{6,8})/);
                if (phoneMatch) userPhone = phoneMatch[0].trim();

                // 4. åœ°å€
                let householdAddress = "";
                const hMatch = fullText.match(/æˆ¶ç±åœ°å€\s+([^\nâ€»]+)/);
                if (hMatch) householdAddress = hMatch[1].trim();

                let contactAddress = "";
                const cMatch = fullText.match(/å±…ä½\(é€šè¨Š\)åœ°\s+(.+?)(\s|$)/);
                if (cMatch) {
                    let raw = cMatch[1].replace("å€", "").trim();
                    contactAddress = raw.replace(/\(éƒµéå€è™Ÿ[:ï¼š].*?\)/, "").trim();
                }

                // 5. åˆ¤æ–·è²»ç”¨ (å…ˆæ‰¾ç¬¬1é ï¼Œå†æ‰¾ç¬¬13é )
                let paymentVal = "240"; 
                const levelRegex = /(ç¬¬\s*[ä¸€äºŒä¸‰]\s*é¡)/;
                let wMatch = page1Text.match(levelRegex);
                if (!wMatch && page13Text) wMatch = page13Text.match(levelRegex);

                if (wMatch) {
                    const txt = wMatch[1].replace(/\s/g, "");
                    if (txt.includes("ç¬¬ä¸€é¡")) paymentVal = "0";
                    else if (txt.includes("ç¬¬äºŒé¡")) paymentVal = "75";
                    else if (txt.includes("ç¬¬ä¸‰é¡")) paymentVal = "240";
                }

                // 6. ä»£ç†äºº
                let contractorName = userName;
                let contractorPhone = userPhone;
                const agentMatch = fullText.match(/ä»£ç†äººå§“å\s+([^\s]+)/);
                if (agentMatch && agentMatch[1].length > 1) {
                    contractorName = agentMatch[1].trim();
                    const agentPhoneMatch = fullText.match(/ä»£ç†äººæ‰‹æ©Ÿ\s*(09\d{8})/);
                    if (agentPhoneMatch) contractorPhone = agentPhoneMatch[1].trim();
                }

                // --- å¡«å…¥ç¶²é è¡¨å–® ---
                document.getElementById('user_name').value = userName;
                document.getElementById('user_id').value = userId;
                document.getElementById('user_phone').value = userPhone;
                document.getElementById('payment').value = paymentVal;
                document.getElementById('contractor_name').value = contractorName;
                document.getElementById('contractor_phone').value = contractorPhone;
                document.getElementById('household_address').value = householdAddress;
                document.getElementById('contact_address').value = contactAddress;

                alert("è³‡æ–™å·²è‡ªå‹•å¸¶å…¥ï¼è«‹æª¢æŸ¥å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚");

            } catch (err) {
                console.error(err);
                alert("è®€å– PDF å¤±æ•—ï¼š" + err.message);
            } finally {
                btn.innerText = "ğŸ“‚ è®€å– PDF è³‡æ–™";
                btn.disabled = false;
            }
        }

        // --- åŠŸèƒ½ B: è¨ˆç®—æ—¥æœŸ ---
        function calculateEndDate(visitDateStr) {
            if (!visitDateStr) return "";
            const match = visitDateStr.match(/^(\d{2,3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (!match) return "æ—¥æœŸæ ¼å¼éŒ¯èª¤";

            let year = parseInt(match[1]) + 1911;
            let month = parseInt(match[2]);
            let day = parseInt(match[3]);

            let newMonth = month + 3;
            let newYear = year;
            if (newMonth > 12) {
                newYear += 1;
                newMonth -= 12;
            }
            const lastDayOfNewMonth = new Date(newYear, newMonth, 0).getDate();
            const newDay = Math.min(day, lastDayOfNewMonth);

            return `${newYear - 1911}å¹´${newMonth}æœˆ${newDay}æ—¥`;
        }

        // --- åŠŸèƒ½ C: ä¸‹è¼‰ Word ---
        async function generateWord() {
            const btn = document.querySelector('.btn-success');
            const originalText = btn.innerText;
            btn.innerText = "â³ è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                // 1. ä¸‹è¼‰ç¯„æœ¬
                const { data: fileData, error } = await supabase
                    .storage
                    .from(BUCKET_NAME)
                    .download(TEMPLATE_NAME);

                if (error) throw new Error("ä¸‹è¼‰ç¯„æœ¬å¤±æ•—: " + error.message);

                // 2. æº–å‚™è³‡æ–™
                const visitDate = document.getElementById('visit_date').value;
                const templateData = {
                    user_name: document.getElementById('user_name').value,
                    user_id: document.getElementById('user_id').value,
                    user_phone: document.getElementById('user_phone').value,
                    payment: document.getElementById('payment').value,
                    contractor_name: document.getElementById('contractor_name').value,
                    contractor_phone: document.getElementById('contractor_phone').value,
                    household_address: document.getElementById('household_address').value,
                    contact_address: document.getElementById('contact_address').value,
                    visit_date: visitDate,
                    end_date: calculateEndDate(visitDate)
                };

                // 3. ç”¢ç”Ÿ Word
                const arrayBuffer = await fileData.arrayBuffer();
                const zip = new PizZip(arrayBuffer);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                doc.render(templateData);

                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const fileName = `ç¾©å¤§é†«é™¢å¥‘ç´„æ›¸_${templateData.user_name}.docx`;
                saveAs(blob, fileName);

            } catch (err) {
                alert("éŒ¯èª¤: " + err.message);
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
