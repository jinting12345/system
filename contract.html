// â˜…â˜…â˜… æ ¸å¿ƒè§£æé‚è¼¯ (æ”¹é€²ç‰ˆ - åƒè€ƒ Python é‚è¼¯) â˜…â˜…â˜…
        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!");
                return;
            }

            btn.innerText = "è§£æä¸­...";
            btn.disabled = true;

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = "";
                let page1Text = "";
                let page13Text = "";
                
                // è®€å–æ‰€æœ‰é é¢ï¼Œç‰¹åˆ¥ä¿å­˜ç¬¬1é å’Œç¬¬13é 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageStr = textContent.items.map(item => item.str).join("\n");
                    
                    fullText += pageStr + "\n";
                    
                    if (i === 1) page1Text = pageStr;
                    if (i === 13) page13Text = pageStr;
                }

                console.log("PDF è®€å–å®Œæˆï¼Œç¸½å­—æ•¸:", fullText.length);

                // --- 1. å€‹æ¡ˆå§“å ---
                let userName = "";
                let nameMatch = fullText.match(/å€‹æ¡ˆå§“å[:ï¼š]?\s*([^\s\/]+)/);
                if (nameMatch) {
                    userName = nameMatch[1].trim();
                    // éæ¿¾æ‰ç„¡æ•ˆå€¼
                    if (userName.includes("å‚³çµ±") || userName.length < 2) {
                        const backupMatch = fullText.match(/å€‹æ¡ˆå§“å\s+([\u4e00-\u9fa5]{2,4})/);
                        if (backupMatch) userName = backupMatch[1].trim();
                    }
                }

                // --- 2. èº«åˆ†è­‰ ---
                let userId = "";
                const idMatch = fullText.match(/([A-Z][0-9]{9})/);
                if (idMatch) userId = idMatch[1].trim();

                // --- 3. é›»è©± (æ”¹ç”¨ Python çš„é›™é‡ç­–ç•¥) ---
                let userPhone = "";
                // ç­–ç•¥A: èº«åˆ†è­‰å¾Œé¢ç·Šæ¥çš„é›»è©±
                const phoneMatchA = fullText.match(/[A-Z][0-9]{9}\s+(09\d{8}|0\d{1,2}-?\d{6,8})/);
                if (phoneMatchA) {
                    userPhone = phoneMatchA[1].trim();
                } else {
                    // ç­–ç•¥B: é›»è©±æ¨™ç±¤å¾Œçš„è™Ÿç¢¼
                    const phoneMatchB = fullText.match(/é›»è©±\s*[:ï¼š]?\s*(09\d{8}|0\d{1,2}-?\d{6,8})/);
                    if (phoneMatchB) userPhone = phoneMatchB[1].trim();
                }

                // --- 4. ç¦åˆ©èº«åˆ†èˆ‡è²»ç”¨ (ä½¿ç”¨ Python çš„æŒ‡å®šé æ•¸æœå°‹æ³•) ---
                let paymentVal = "240";
                let welfareLevel = "";
                let foundWelfare = false;

                // æ’é™¤é¸é …åˆ—è¡¨çš„æ­£å‰‡ï¼šå‰é¢ä¸èƒ½æœ‰æ•¸å­—å’Œé»
                const targetPattern = /(?<!\d\.)(ç¬¬\s*[ä¸€äºŒä¸‰]\s*é¡)/;

                // å„ªå…ˆæœå°‹ç¬¬1é 
                if (page1Text) {
                    const match1 = page1Text.match(targetPattern);
                    if (match1) {
                        welfareLevel = match1[1];
                        foundWelfare = true;
                        console.log("â˜… åœ¨ç¬¬1é ç™¼ç¾èº«åˆ†:", welfareLevel);
                    }
                }

                // å¦‚æœç¬¬1é æ²’æ‰¾åˆ°ï¼Œæœå°‹ç¬¬13é 
                if (!foundWelfare && page13Text) {
                    const match13 = page13Text.match(targetPattern);
                    if (match13) {
                        welfareLevel = match13[1];
                        foundWelfare = true;
                        console.log("â˜… åœ¨ç¬¬13é ç™¼ç¾èº«åˆ†:", welfareLevel);
                    }
                }

                // è½‰æ›è²»ç”¨
                if (foundWelfare) {
                    const cleanLevel = welfareLevel.replace(/\s/g, "");
                    if (cleanLevel.includes("ç¬¬ä¸€é¡")) paymentVal = "0";
                    else if (cleanLevel.includes("ç¬¬äºŒé¡")) paymentVal = "75";
                    else if (cleanLevel.includes("ç¬¬ä¸‰é¡")) paymentVal = "240";
                }

                // --- 5. ä»£ç†äºº ---
                let contractorName = userName;
                let contractorPhone = userPhone;

                const agentMatch = fullText.match(/ä»£ç†äººå§“å\s+([^\s]+)/);
                if (agentMatch) {
                    const agentName = agentMatch[1].trim();
                    if (agentName.length > 1 && !agentName.includes("å§“å")) {
                        contractorName = agentName;
                        
                        const agentPhoneMatch = fullText.match(/ä»£ç†äººæ‰‹æ©Ÿ\s*(09\d{8}|0\d{1,2}-?\d{6,8})/);
                        if (agentPhoneMatch) {
                            contractorPhone = agentPhoneMatch[1].trim();
                        }
                    }
                }

                // --- 6. åœ°å€ (ä½¿ç”¨ Python çš„æ­£å‰‡ç­–ç•¥) ---
                let householdAddress = "";
                let contactAddress = "";

                // æˆ¶ç±åœ°å€
                const hMatch = fullText.match(/æˆ¶ç±åœ°å€\s+([^\nâ€»]+)/);
                if (hMatch) {
                    householdAddress = hMatch[1].trim();
                }

                // é€šè¨Šåœ°å€
                const cMatch = fullText.match(/å±…ä½\(é€šè¨Š\)åœ°\s+([^\n]+)/);
                if (cMatch) {
                    let rawAddress = cMatch[1].trim();
                    rawAddress = rawAddress.replace(/å€/g, "").trim();
                    rawAddress = rawAddress.replace(/\(éƒµéå€è™Ÿ[:ï¼š].*?\)/g, "").trim();
                    contactAddress = rawAddress;
                }

                // --- å¡«å…¥è¡¨å–® ---
                document.getElementById('user_name').value = userName || "";
                document.getElementById('user_id').value = userId || "";
                document.getElementById('user_phone').value = userPhone || "";
                document.getElementById('payment').value = paymentVal;
                document.getElementById('contractor_name').value = contractorName || "";
                document.getElementById('contractor_phone').value = contractorPhone || "";
                document.getElementById('household_address').value = householdAddress || "";
                document.getElementById('contact_address').value = contactAddress || "";

                // é¡¯ç¤ºçµæœ
                const resultMsg = `âœ… è§£æå®Œæˆï¼\n\n` +
                    `å§“å: ${userName}\n` +
                    `èº«åˆ†è­‰: ${userId}\n` +
                    `é›»è©±: ${userPhone}\n` +
                    `ç¦åˆ©èº«åˆ†: ${welfareLevel || 'æœªåµæ¸¬åˆ°'}\n` +
                    `éƒ¨åˆ†è² æ“”: ${paymentVal}å…ƒ\n` +
                    `ä»£ç†äºº: ${contractorName}\n\n` +
                    `æˆ¶ç±: ${householdAddress || 'âŒ æœªæ‰¾åˆ°'}\n` +
                    `é€šè¨Š: ${contactAddress || 'âŒ æœªæ‰¾åˆ°'}`;
                
                alert(resultMsg);

            } catch (err) {
                console.error("PDFè§£æéŒ¯èª¤:", err);
                alert("è®€å– PDF å¤±æ•—ï¼š" + err.message);
            } finally {
                btn.innerText = "ğŸ“‚ è®€å– PDF è³‡æ–™";
                btn.disabled = false;
            }
        }
