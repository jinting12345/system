<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾©å¤§é†«é™¢é•·ç…§åˆç´„ç”Ÿæˆç³»çµ±</title>
    
    <!-- å¼•å…¥ Supabase å®˜æ–¹ SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.37.11/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f5f7fa; color: #333; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #edf2f7; padding-bottom: 20px; }
        .header h1 { color: #2c3e50; margin: 0; font-size: 2em; }
        .header p { color: #7f8c8d; margin-top: 10px; }

        .step-section { margin-bottom: 30px; }
        .step-header { display: flex; align-items: center; margin-bottom: 15px; }
        .step-number { background: #3498db; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
        .step-title { font-weight: bold; font-size: 1.2em; color: #2c3e50; }

        .upload-box { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc; transition: 0.3s; }
        .upload-box:hover { border-color: #3498db; background: #ebf8ff; }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #fff; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #4a5568; font-size: 0.95em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
        .full-width { grid-column: span 2; }
        .highlight { color: #e53e3e; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; margin-top: 15px; }
        .btn-parse { background-color: #3498db; }
        .btn-parse:hover { background-color: #2980b9; }
        .btn-generate { background-color: #27ae60; }
        .btn-generate:hover { background-color: #219150; }
        .btn:disabled { background-color: #a0aec0; cursor: not-allowed; }

        input[type="file"] { margin-bottom: 10px; }

        .alert-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 6px; }
        .alert-box strong { color: #856404; }

        /* ç™»å…¥è¦–çª—æ¨£å¼ */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 10px; width: 300px;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- ç™»å…¥è¦–çª— (å› ç‚ºæ˜¯ Private Bucketï¼Œå¿…é ˆå…ˆç™»å…¥) -->
<div id="login-modal">
    <div class="login-box">
        <h2>ç³»çµ±ç™»å…¥</h2>
        <p>è«‹å…ˆç™»å…¥ä»¥å–å¾—å®‰å…¨ç¯„æœ¬</p>
        <div style="margin-bottom: 15px;">
            <input type="email" id="email" placeholder="Email" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <input type="password" id="password" placeholder="å¯†ç¢¼" style="width: 100%; padding: 8px;">
        </div>
        <button onclick="handleLogin()" class="btn btn-parse">ç™»å…¥</button>
        <p id="login-msg" style="color: red; margin-top: 10px; font-size: 0.9em;"></p>
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>é•·ç…§åˆç´„è‡ªå‹•ç”Ÿæˆç³»çµ±</h1>
        <p>ç¾©å¤§é†«é™¢å°ˆç”¨ / æ”¯æ´ PDF è§£æèˆ‡ Word ç”Ÿæˆ</p>
        <!-- é¡¯ç¤ºç™»å…¥ç‹€æ…‹ -->
        <p id="user-status" style="font-size: 0.8em; color: #27ae60;"></p>
    </div>

    <div class="alert-box">
        <strong>âš ï¸ é‡è¦æé†’</strong>
        <p>è¨˜å¾—å†æ¬¡ç¢ºèªç”Ÿæˆå…§å®¹æ˜¯å¦æœ‰èª¤</p>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">ä¸Šå‚³è©•ä¼°é‡è¡¨ PDF</div>
        </div>
        <div class="upload-box">
            <p>è«‹é¸æ“‡å€‹æ¡ˆçš„è©•ä¼°é‡è¡¨ PDF æª”æ¡ˆ</p>
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-parse" onclick="parsePDF()">ğŸ” è§£æè³‡æ–™</button>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">ç¢ºèªåˆç´„è³‡æ–™</div>
        </div>
        
        <div class="grid-form">
            <div class="form-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="user_name" /></div>
            <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="user_id" /></div>
            <div class="form-group"><label>å€‹æ¡ˆé›»è©±</label><input type="text" id="user_phone" /></div>
            <div class="form-group">
                <label>éƒ¨åˆ†è² æ“”é‡‘é¡</label>
                <select id="payment">
                    <option value="240">240 (ä¸€èˆ¬æˆ¶)</option>
                    <option value="75">75 (ä¸­ä½æ”¶)</option>
                    <option value="0">0 (ä½æ”¶å…¥æˆ¶)</option>
                </select>
            </div>
            <div class="form-group"><label>ç°½ç´„äººå§“å</label><input type="text" id="contractor_name" /></div>
            <div class="form-group"><label>ç°½ç´„äººé›»è©±</label><input type="text" id="contractor_phone" /></div>
            <div class="form-group full-width"><label class="highlight">æˆ¶ç±åœ°å€ (è«‹ç¢ºèªå®Œæ•´æ€§)</label><input type="text" id="household_address" /></div>
            <div class="form-group full-width"><label class="highlight">é€šè¨Šåœ°å€ (è«‹ç¢ºèªå®Œæ•´æ€§)</label><input type="text" id="contact_address" /></div>
            <div class="form-group"><label>è¨ªè¦–æ—¥æœŸ</label><input type="text" id="visit_date"></div>
            <div class="form-group"><label>åˆç´„çµæŸæ—¥æœŸ</label><input type="text" id="end_date"></div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">ç”Ÿæˆ Word å¥‘ç´„æ›¸</div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <label style="flex: 1; cursor: pointer;">
                <input type="radio" name="template_mode" value="auto" checked onchange="switchTemplateMode()">
                <span style="margin-left: 8px; font-weight: bold;">ğŸ”’ è‡ªå‹•æ¨¡å¼ (ä½¿ç”¨ç³»çµ±ç¯„æœ¬)</span>
            </label>
            <label style="flex: 1; cursor: pointer;">
                <input type="radio" name="template_mode" value="manual" onchange="switchTemplateMode()">
                <span style="margin-left: 8px; font-weight: bold;">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³æ¨¡å¼</span>
            </label>
        </div>

        <div id="auto_mode_box" class="upload-box" style="border-color: #27ae60; background: #f0fdf4;">
            <p style="color: #27ae60; font-weight: bold;">âœ… å°‡ä½¿ç”¨ç³»çµ±å…§å»ºçš„å®‰å…¨ç¯„æœ¬</p>
            <p style="color: #666; font-size: 0.9em; margin-top: 10px;">ç¯„æœ¬å·²å®‰å…¨å­˜æ”¾æ–¼ Supabase,ä¸æœƒå¤–æµ</p>
            <button class="btn btn-generate" onclick="generateWordAuto()">ğŸ“„ ä¸‹è¼‰åˆç´„ (è‡ªå‹•æ¨¡å¼)</button>
        </div>

        <div id="manual_mode_box" class="upload-box" style="display: none; border-color: #3498db; background: #ebf8ff;">
            <p style="color: #3498db; font-weight: bold;">è«‹é¸æ“‡ Word åˆç´„ç¯„æœ¬ (.docx)</p>
            <input type="file" id="template_upload" accept=".docx" />
            <button class="btn btn-generate" style="background-color: #3498db;" onclick="generateWordManual()">ğŸ“„ ä¸‹è¼‰åˆç´„ (æ‰‹å‹•æ¨¡å¼)</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // 1. åˆå§‹åŒ– Supabase (è«‹å¡«å…¥ä½ çš„ URL å’Œ Anon Key)
    // ============================================
    const SUPABASE_URL = 'https://oipnjnwootorawargsxe.supabase.co'; 
    const SUPABASE_KEY = 'è«‹å¡«å…¥ä½ åŸæœ¬çš„é‚£å€‹é•·é•·çš„anon_keyå­—ä¸²'; // âš ï¸ æ³¨æ„ï¼šé€™ä¾ç„¶æ˜¯ anon keyï¼Œä½†æ¬Šé™ç”±ç™»å…¥æ±ºå®š

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ============================================
    // 2. ç™»å…¥é‚è¼¯
    // ============================================
    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const msg = document.getElementById('login-msg');

        if(!email || !password) {
            msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
            return;
        }

        msg.innerText = "ç™»å…¥ä¸­...";
        
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            msg.innerText = "ç™»å…¥å¤±æ•—: " + error.message;
        } else {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('user-status').innerText = `ç›®å‰ä½¿ç”¨è€…: ${data.user.email}`;
            console.log("ç™»å…¥æˆåŠŸï¼Œå·²å–å¾— Token");
        }
    }

    // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™»å…¥é (é‡æ–°æ•´ç†é é¢æ™‚)
    async function checkSession() {
        const { data } = await supabase.auth.getSession();
        if (data.session) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('user-status').innerText = `ç›®å‰ä½¿ç”¨è€…: ${data.session.user.email}`;
        }
    }
    
    // ============================================
    // 3. Supabase ä¸‹è¼‰ (ä¿®æ­£ç‰ˆ - ä½¿ç”¨ SDK)
    // ============================================
    async function downloadTemplateFromSupabase() {
        // ä½¿ç”¨ SDK ä¸‹è¼‰ï¼Œå®ƒæœƒè‡ªå‹•æŠŠä½ çš„ã€Œç™»å…¥èº«åˆ†ã€å¸¶å…¥ Header
        // é€™æ¨£æ‰èƒ½é€šé RLS é©—è­‰
        
        // âš ï¸ ç¢ºèª Bucket ID (å¤§å°å¯«æ•æ„Ÿ)
        const bucketId = 'system_files';  // æˆ–è€…æ˜¯ 'SYSTEM_FILES'ï¼Œè«‹çœ‹ä½  Dashboard
        const filePath = 'templates/template.docx';

        const { data, error } = await supabase
          .storage
          .from(bucketId)
          .download(filePath);

        if (error) {
            console.error('Supabase ä¸‹è¼‰éŒ¯èª¤:', error);
            if (error.message.includes('Object not found')) {
                 throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆï¼Œè«‹ç¢ºèªè·¯å¾‘æˆ– Bucket åç¨±å¤§å°å¯«");
            }
            if (error.statusCode === '403' || error.error === 'Unauthorized') {
                 throw new Error("æ¬Šé™ä¸è¶³ï¼šè«‹ç¢ºèªæ‚¨å·²ç™»å…¥ï¼Œä¸” RLS ç­–ç•¥æ­£ç¢º");
            }
            throw new Error(error.message);
        }

        // å°‡ Blob è½‰ç‚º ArrayBuffer
        return await data.arrayBuffer();
    }

    // ============================================
    // å…¶ä»–åŸæœ‰é‚è¼¯ (PDF è§£æ & Word ç”Ÿæˆ)
    // ============================================

    // è¨­å®š PDF.js Worker
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
    }

    // åˆå§‹åŒ–æ—¥æœŸèˆ‡ Session
    window.onload = function() {
        checkSession(); // æª¢æŸ¥ç™»å…¥
        
        const today = new Date();
        const rocYear = today.getFullYear() - 1911;
        document.getElementById('visit_date').value = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
        document.getElementById('end_date').value = `${rocYear+1}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
    };

    function cleanTextDeep(text) {
        return text.replace(/â€»/g, "").replace(/\(é‡Œ[ã€ï¼Œ]é„°[ã€ï¼Œ]éƒµéå€è™Ÿ.*?\)/g, "").replace(/[\(ï¼ˆ]éƒµéå€è™Ÿ[:ï¼š]?\s*\d+[\)ï¼‰]/g, "").replace(/[()]/g, "").replace(/[\s\n\r]/g, "");
    }
    
    function extractAddressFromChunk(chunk) {
        const regex = /([å°è‡º]?[^0-9\s]{2,3}[ç¸£å¸‚].*?[è™Ÿæ¨“])/;
        const match = chunk.match(regex);
        return match ? match[1].replace(/^[^å°è‡ºé«˜æ–°åŒ—æ¡ƒä¸­å—åŸºå®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å±]*/, "") : "";
    }

    async function parsePDF() {
        if (typeof pdfjsLib === 'undefined') { alert("PDF å…ƒä»¶è¼‰å…¥ä¸­..."); return; }
        const fileInput = document.getElementById('pdf_upload');
        const btn = document.querySelector('.btn-parse');
        
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!"); return; }

        btn.innerText = "â³ è§£æä¸­...";
        btn.disabled = true;

        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            let fullText = ""; 
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(""); 
            }
            const cleanText = cleanTextDeep(fullText);

            // ç°¡åŒ–è§£æé‚è¼¯ (ä¿ç•™ä½ åŸæœ¬çš„é‚è¼¯)
            let userName = "", userId = "", userPhone = "", paymentVal = "240";
            const headerMatch = cleanText.match(/å§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?([^\/]+)\/([A-Z][0-9]{9})/);
            if (headerMatch) { userName = headerMatch[1].replace(/[:ï¼š]/g, ""); userId = headerMatch[2]; }
            
            const phoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
            if (phoneMatch) userPhone = phoneMatch[1];

            let contractorName = userName, contractorPhone = userPhone;
            // (å…¶é¤˜è§£æé‚è¼¯ç•¥ï¼Œä¿æŒä½ åŸæœ¬çš„ä»£ç¢¼å³å¯)
            
            // å¡«å…¥ç¯„ä¾‹è³‡æ–™ (æ¨¡æ“¬)
            document.getElementById('user_name').value = userName;
            document.getElementById('user_id').value = userId;
            document.getElementById('user_phone').value = userPhone;
        } catch (err) {
            alert("è§£æéŒ¯èª¤: " + err.message);
        } finally {
            btn.innerText = "ğŸ” è§£æè³‡æ–™";
            btn.disabled = false;
        }
    }

    function switchTemplateMode() {
        const mode = document.querySelector('input[name="template_mode"]:checked').value;
        document.getElementById('auto_mode_box').style.display = mode === 'auto' ? 'block' : 'none';
        document.getElementById('manual_mode_box').style.display = mode === 'manual' ? 'block' : 'none';
    }

    // è‡ªå‹•æ¨¡å¼ (ä½¿ç”¨ SDK)
    async function generateWordAuto() {
        const btn = document.querySelector('#auto_mode_box .btn-generate');
        btn.innerText = "â³ ä¸‹è¼‰ç¯„æœ¬ä¸­...";
        btn.disabled = true;

        try {
            const arrayBuffer = await downloadTemplateFromSupabase(); // å‘¼å«æ–°çš„ SDK å‡½å¼
            btn.innerText = "â³ ç”Ÿæˆä¸­...";
            await generateWordFromBuffer(arrayBuffer);
        } catch (error) {
            console.error(error);
            alert("è‡ªå‹•æ¨¡å¼å¤±æ•—: " + error.message);
        } finally {
            btn.innerText = "ğŸ“„ ä¸‹è¼‰åˆç´„ (è‡ªå‹•æ¨¡å¼)";
            btn.disabled = false;
        }
    }

    // æ‰‹å‹•æ¨¡å¼
    async function generateWordManual() {
        const templateInput = document.getElementById('template_upload');
        const btn = document.querySelector('#manual_mode_box .btn-generate');
        if (templateInput.files.length === 0) { alert("è«‹é¸æ“‡ Word æª”æ¡ˆ"); return; }
        
        btn.innerText = "â³ è™•ç†ä¸­...";
        try {
            const arrayBuffer = await templateInput.files[0].arrayBuffer();
            await generateWordFromBuffer(arrayBuffer);
        } catch(e) { alert("éŒ¯èª¤: " + e.message); } 
        finally { btn.innerText = "ğŸ“„ ä¸‹è¼‰åˆç´„ (æ‰‹å‹•æ¨¡å¼)"; }
    }

    // ç”Ÿæˆ Word (å…±ç”¨)
    async function generateWordFromBuffer(arrayBuffer) {
        if (typeof PizZip === 'undefined') { alert("ç³»çµ±è¼‰å…¥ä¸­..."); return; }
        const zip = new PizZip(arrayBuffer);
        const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

        // æ”¶é›†è¡¨å–®è³‡æ–™
        const templateData = {
            user_name: document.getElementById('user_name').value,
            user_id: document.getElementById('user_id').value,
            // ... å…¶ä»–æ¬„ä½
        };

        doc.setData(templateData);
        doc.render();
        const blob = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
        saveAs(blob, `åˆç´„_${templateData.user_name || 'æœªå‘½å'}.docx`);
    }
</script>

</body>
</html>
