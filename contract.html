<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§åˆç´„ç”¢ç”Ÿå™¨ (é›¢ç·šå®‰å…¨ç‰ˆ)</title>
    
    <!-- å¼•å…¥ Word ç”Ÿæˆæ ¸å¿ƒ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- å¼•å…¥ PDF è§£æ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f4f4f4; }
        .section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #34495e; font-size: 1.1em; }
        input, select { width: 100%; padding: 12px; border: 1px solid #bdc3c7; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .btn { color: white; padding: 14px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; transition: 0.2s; margin-top: 10px; font-weight: bold; }
        .btn-primary { background-color: #3498db; }
        .btn-success { background-color: #27ae60; }
        .btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .upload-area { border: 3px dashed #bdc3c7; padding: 30px; text-align: center; border-radius: 12px; background: #ecf0f1; margin-bottom: 15px; }
        .file-label { display: block; margin-bottom: 10px; color: #666; }
    </style>
</head>
<body>

    <div class="section">
        <h2>æ­¥é©Ÿ 1: ä¸Šå‚³ PDF é€²è¡Œè§£æ</h2>
        <div class="upload-area">
            <span class="file-label">1. é¸æ“‡ã€Œç…§é¡§ç®¡ç†è©•ä¼°é‡è¡¨ã€PDFï¼š</span>
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-primary" onclick="parsePDF()">ğŸ” è§£æ PDF è³‡æ–™</button>
        </div>
    </div>

    <div class="section">
        <h2>æ­¥é©Ÿ 2: ç¢ºèªè³‡æ–™ & é¸æ“‡åˆç´„ç¯„æœ¬</h2>
        <div class="form-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="user_name" /></div>
        <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="user_id" /></div>
        <div class="form-group"><label>å€‹æ¡ˆé›»è©±</label><input type="text" id="user_phone" /></div>
        <div class="form-group">
            <label>éƒ¨åˆ†è² æ“”</label>
            <select id="payment">
                <option value="240">240 (ç¬¬ä¸‰é¡/ä¸€èˆ¬)</option>
                <option value="75">75 (ç¬¬äºŒé¡/ä¸­ä½æ”¶)</option>
                <option value="0">0 (ç¬¬ä¸€é¡/ä½æ”¶)</option>
            </select>
        </div>
        <div class="form-group"><label>ç°½ç´„äººå§“å</label><input type="text" id="contractor_name" /></div>
        <div class="form-group"><label>ç°½ç´„äººé›»è©±</label><input type="text" id="contractor_phone" /></div>
        
        <div class="form-group">
            <label style="color:red;">æˆ¶ç±åœ°å€</label>
            <input type="text" id="household_address" />
        </div>

        <div class="form-group">
            <label style="color:red;">é€šè¨Šåœ°å€</label>
            <input type="text" id="contact_address" />
        </div>

        <div class="form-group"><label>è¨ªè¦–æ—¥æœŸ</label><input type="text" id="visit_date"></div>

        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ccc;">

        <div class="upload-area" style="background: #e8f8f5; border-color: #27ae60;">
            <span class="file-label" style="color: #27ae60; font-weight: bold;">2. è«‹é¸æ“‡é›»è…¦ä¸­çš„ã€ŒWord åˆç´„ç¯„æœ¬ (.docx)ã€ï¼š</span>
            <input type="file" id="template_upload" accept=".docx" />
            <button class="btn btn-success" onclick="generateWord()">ğŸ“„ ç”Ÿæˆå¥‘ç´„æ›¸</button>
        </div>
    </div>

    <script>
        // è¨­å®š PDF worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        window.onload = function() {
            const today = new Date();
            const rocYear = today.getFullYear() - 1911;
            document.getElementById('visit_date').value = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
        };

        // æ¸…æ´—å‡½æ•¸
        function cleanTextDeep(text) {
            return text
                .replace(/â€»/g, "")
                .replace(/\(é‡Œ[ã€ï¼Œ]é„°[ã€ï¼Œ]éƒµéå€è™Ÿ.*?\)/g, "")
                .replace(/[\(ï¼ˆ]éƒµéå€è™Ÿ[:ï¼š]?\s*\d+[\)ï¼‰]/g, "") 
                .replace(/[()]/g, "")
                .replace(/[\s\n\r]/g, "");
        }

        // åœ°å€æå–
        function extractAddressFromChunk(chunk) {
            const regex = /([å°è‡º]?[^0-9\s]{2,3}[ç¸£å¸‚].*?[è™Ÿæ¨“])/;
            const match = chunk.match(regex);
            if (match) {
                return match[1].replace(/^[^å°è‡ºé«˜æ–°åŒ—æ¡ƒä¸­å—åŸºå®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å±]*/, "");
            }
            return "";
        }

        // ================= è§£æ PDF é‚è¼¯ =================
        async function parsePDF() {
            const fileInput = document.getElementById('pdf_upload');
            const btn = document.querySelector('button[onclick="parsePDF()"]');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!");
                return;
            }

            btn.innerText = "ğŸ” è§£æä¸­...";
            btn.disabled = true;

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = ""; 
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageStr = textContent.items.map(item => item.str).join(""); 
                    fullText += pageStr;
                }
                
                const cleanText = cleanTextDeep(fullText);

                // åŸºæœ¬æ¬„ä½
                let userName = "", userId = "", userPhone = "", paymentVal = "240";
                const headerMatch = cleanText.match(/å§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?([^\/]+)\/([A-Z][0-9]{9})/);
                if (headerMatch) { userName = headerMatch[1].replace(/[:ï¼š]/g, ""); userId = headerMatch[2]; }
                
                const phoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
                if (phoneMatch) userPhone = phoneMatch[1];

                const welfareMatch = cleanText.match(/é•·ç…§ç¦åˆ©.*?(ç¬¬[ä¸€äºŒä¸‰]é¡)/);
                if (welfareMatch) {
                    if (welfareMatch[1].includes("ä¸€")) paymentVal = "0";
                    else if (welfareMatch[1].includes("äºŒ")) paymentVal = "75";
                }

                let contractorName = userName;
                let contractorPhone = userPhone;
                let agentMatch = cleanText.match(/ä»£ç†äººå§“å(.*?)ä»£ç†äººèº«åˆ†è­‰/);
                if (!agentMatch) agentMatch = cleanText.match(/ä¸»è¦è¯çµ¡äººå§“å(.*?)ä¸»è¦è¯çµ¡äºº/);
                if (agentMatch) {
                    let tempName = agentMatch[1].replace(/[:ï¼š]/g, "").trim();
                    if (tempName.length > 1) contractorName = tempName;
                }
                const agentPhoneMatch = cleanText.match(/(?:ä»£ç†äºº|è¯çµ¡äºº)æ‰‹æ©Ÿ[::]?.*?((09\d{8}))/);
                if (agentPhoneMatch) contractorPhone = agentPhoneMatch[1];

                // åœ°å€è§£æ (çµ‚æ¥µé‚è¼¯)
                let hAddr = "";
                let cAddr = "";
                const idxHouse = cleanText.indexOf("æˆ¶ç±åœ°å€");
                if (idxHouse !== -1) {
                    const chunk = cleanText.substring(idxHouse, idxHouse + 100);
                    hAddr = extractAddressFromChunk(chunk);
                }
                let idxContact = cleanText.indexOf("é€šè¨Šåœ°å€");
                if (idxContact === -1) idxContact = cleanText.indexOf("å±…ä½é€šè¨Š");
                if (idxContact === -1 && cleanText.indexOf("å±…ä½") !== -1) {
                     const tempIdx = cleanText.lastIndexOf("å±…ä½"); 
                     if (tempIdx > idxHouse) idxContact = tempIdx; 
                }
                if (idxContact !== -1) {
                    const chunk = cleanText.substring(idxContact, idxContact + 100);
                    let foundAddr = extractAddressFromChunk(chunk);
                    if (foundAddr && foundAddr !== hAddr) {
                        cAddr = foundAddr;
                    }
                }
                if (!hAddr || !cAddr) {
                    const allAddrRegex = /([å°è‡º]?[^0-9\s]{2,3}[ç¸£å¸‚].*?[è™Ÿæ¨“])/g;
                    const matches = [];
                    let m;
                    while ((m = allAddrRegex.exec(cleanText)) !== null) {
                        let a = m[1].replace(/^[^å°è‡ºé«˜æ–°åŒ—æ¡ƒä¸­å—åŸºå®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å±]*/, "");
                        if (!a.includes("ä¸­å¿ƒ") && !a.includes("é†«é™¢") && !a.includes("è¡›ç”Ÿå±€") && a.length > 8) {
                            matches.push(a);
                        }
                    }
                    if (!hAddr && matches.length > 0) hAddr = matches[0];
                    if (!cAddr && matches.length > 1) cAddr = matches[1];
                }
                if (!cAddr) cAddr = hAddr;

                // å¡«å…¥
                document.getElementById('user_name').value = userName;
                document.getElementById('user_id').value = userId;
                document.getElementById('user_phone').value = userPhone;
                document.getElementById('payment').value = paymentVal;
                document.getElementById('contractor_name').value = contractorName;
                document.getElementById('contractor_phone').value = contractorPhone;
                document.getElementById('household_address').value = hAddr;
                document.getElementById('contact_address').value = cAddr;

                alert(`è§£ææˆåŠŸï¼\næˆ¶ç±ï¼š${hAddr}\né€šè¨Šï¼š${cAddr}`);

            } catch (err) {
                alert("éŒ¯èª¤: " + err.message);
                console.error(err);
            } finally {
                btn.innerText = "ğŸ” è§£æ PDF è³‡æ–™";
                btn.disabled = false;
            }
        }

        function calculateEndDate(visitDateStr) {
            if (!visitDateStr) return "";
            const match = visitDateStr.match(/^(\d{2,3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (!match) return "";
            let year = parseInt(match[1]) + 1911;
            let month = parseInt(match[2]);
            let day = parseInt(match[3]);
            let newMonth = month + 3;
            let newYear = year;
            if (newMonth > 12) { newYear += 1; newMonth -= 12; }
            const lastDayOfNewMonth = new Date(newYear, newMonth, 0).getDate();
            const newDay = Math.min(day, lastDayOfNewMonth);
            return `${newYear - 1911}å¹´${newMonth}æœˆ${newDay}æ—¥`;
        }

        // ================= Word ç”Ÿæˆé‚è¼¯ (é›¢ç·šç‰ˆ) =================
        async function generateWord() {
            const templateInput = document.getElementById('template_upload');
            const btn = document.querySelector('.btn-success');
            
            if (templateInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡æ‚¨çš„ Word åˆç´„ç¯„æœ¬ (.docx)ï¼");
                return;
            }

            const originalText = btn.innerText;
            btn.innerText = "â³ è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                // 1. è®€å–æœ¬åœ°çš„ Word ç¯„æœ¬
                const file = templateInput.files[0];
                const arrayBuffer = await file.arrayBuffer();

                // 2. æº–å‚™è³‡æ–™
                const visitDate = document.getElementById('visit_date').value;
                const templateData = {
                    user_name: document.getElementById('user_name').value,
                    user_id: document.getElementById('user_id').value,
                    user_phone: document.getElementById('user_phone').value,
                    payment: document.getElementById('payment').value,
                    contractor_name: document.getElementById('contractor_name').value,
                    contractor_phone: document.getElementById('contractor_phone').value,
                    household_address: document.getElementById('household_address').value,
                    contact_address: document.getElementById('contact_address').value,
                    visit_date: visitDate,
                    end_date: calculateEndDate(visitDate)
                };

                // 3. æ¸²æŸ“ Word
                const zip = new PizZip(arrayBuffer);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                doc.render(templateData);

                // 4. ä¸‹è¼‰
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                saveAs(blob, `ç¾©å¤§é†«é™¢å¥‘ç´„æ›¸_${templateData.user_name}.docx`);
                
            } catch (err) {
                alert("ç”Ÿæˆå¤±æ•—: " + err.message);
                console.error(err);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
