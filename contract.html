<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§åˆç´„ç”¢ç”Ÿå™¨ (JSç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-submit { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; }
        .btn-submit:hover { background-color: #0056b3; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

    <h2>æ­¥é©Ÿ 2ï¼šç¢ºèªä¸¦ä¿®æ”¹è³‡æ–™</h2>

    <div class="form-group">
        <label>å€‹æ¡ˆå§“å</label>
        <input type="text" id="user_name" value="æ¸¬è©¦å€‹æ¡ˆ">
    </div>

    <div class="form-group">
        <label>èº«åˆ†è­‰å­—è™Ÿ</label>
        <input type="text" id="user_id" value="S201821350">
    </div>

    <div class="form-group">
        <label>å€‹æ¡ˆé›»è©±</label>
        <input type="text" id="user_phone" value="0913935315">
    </div>

    <div class="form-group">
        <label>éƒ¨åˆ†è² æ“” (å…ƒ)</label>
        <select id="payment">
            <option value="240">240 (ç¬¬ä¸‰é¡/ä¸€èˆ¬)</option>
            <option value="75">75 (ç¬¬äºŒé¡/ä¸­ä½æ”¶)</option>
            <option value="0">0 (ç¬¬ä¸€é¡/ä½æ”¶)</option>
        </select>
    </div>

    <div class="form-group">
        <label>ç°½ç´„äººå§“å</label>
        <input type="text" id="contractor_name" value="æ¸¬è©¦å€‹æ¡ˆ">
    </div>

    <div class="form-group">
        <label>ç°½ç´„äººé›»è©±</label>
        <input type="text" id="contractor_phone" value="0913935315">
    </div>

    <div class="form-group">
        <label>æˆ¶ç±åœ°å€</label>
        <input type="text" id="household_address" value="é«˜é›„å¸‚ç¯„ä¾‹å€ç¯„ä¾‹è·¯123è™Ÿ">
    </div>

    <div class="form-group">
        <label>é€šè¨Šåœ°å€</label>
        <input type="text" id="contact_address" value="é«˜é›„å¸‚æ¢“å®˜å€æ¢“å®˜è·¯534è™Ÿ">
    </div>

    <div class="form-group">
        <label>è¨ªè¦–æ—¥æœŸ (é è¨­ä»Šæ—¥)</label>
        <input type="text" id="visit_date">
    </div>

    <button class="btn-submit" onclick="generateWord()">ğŸ“ ä¸‹è¼‰ Word å¥‘ç´„æ›¸</button>

    <script>
        // ================= è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡) =================
        const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII'; 
        const BUCKET_NAME = 'system_files';  // ä½ çš„ Bucket åç¨±
        const TEMPLATE_NAME = 'template.docx'; // ä½ çš„ç¯„æœ¬æª”å
        // =====================================================

        // åˆå§‹åŒ– Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // åˆå§‹åŒ–æ—¥æœŸ (è‡ªå‹•å¸¶å…¥ä»Šå¤©)
        window.onload = function() {
            const today = new Date();
            const rocYear = today.getFullYear() - 1911;
            const dateStr = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            document.getElementById('visit_date').value = dateStr;
        };

        // è¨ˆç®—çµæŸæ—¥æœŸ (è¨ªè¦–æ—¥ + 3å€‹æœˆ)
        function calculateEndDate(visitDateStr) {
            if (!visitDateStr) return "";
            
            // è§£æ "114å¹´12æœˆ14æ—¥"
            const match = visitDateStr.match(/^(\d{2,3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (!match) return "æ—¥æœŸæ ¼å¼éŒ¯èª¤";

            let year = parseInt(match[1]) + 1911; // è½‰è¥¿å…ƒ
            let month = parseInt(match[2]);
            let day = parseInt(match[3]);

            // åŠ  3 å€‹æœˆ
            let newMonth = month + 3;
            let newYear = year;

            if (newMonth > 12) {
                newYear += 1;
                newMonth -= 12;
            }

            // è™•ç†æ—¥æœŸ (ä¾‹å¦‚ 2/30 ä¸å­˜åœ¨ï¼Œè¦è®Šæˆ 2/28)
            const lastDayOfNewMonth = new Date(newYear, newMonth, 0).getDate();
            const newDay = Math.min(day, lastDayOfNewMonth);

            return `${newYear - 1911}å¹´${newMonth}æœˆ${newDay}æ—¥`;
        }

        // æ ¸å¿ƒåŠŸèƒ½ï¼šç”¢ç”Ÿ Word
        async function generateWord() {
            const btn = document.querySelector('.btn-submit');
            const originalText = btn.innerText;
            btn.innerText = "â³ ä¸‹è¼‰ç¯„æœ¬ä¸¦è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                // 1. å¾ Supabase ä¸‹è¼‰ç¯„æœ¬
                const { data: fileData, error } = await supabase
                    .storage
                    .from(BUCKET_NAME)
                    .download(TEMPLATE_NAME);

                if (error) throw new Error("ä¸‹è¼‰ç¯„æœ¬å¤±æ•—: " + error.message + " (è«‹æª¢æŸ¥ Supabase Policy)");

                // 2. æº–å‚™è³‡æ–™
                const visitDate = document.getElementById('visit_date').value;
                const endDate = calculateEndDate(visitDate);
                
                const templateData = {
                    user_name: document.getElementById('user_name').value,
                    user_id: document.getElementById('user_id').value,
                    user_phone: document.getElementById('user_phone').value,
                    payment: document.getElementById('payment').value,
                    contractor_name: document.getElementById('contractor_name').value,
                    contractor_phone: document.getElementById('contractor_phone').value,
                    household_address: document.getElementById('household_address').value,
                    contact_address: document.getElementById('contact_address').value,
                    visit_date: visitDate,
                    end_date: endDate
                };

                console.log("å¯«å…¥è³‡æ–™:", templateData);

                // 3. è®€å–ä¸¦æ¸²æŸ“ Word
                const arrayBuffer = await fileData.arrayBuffer();
                const zip = new PizZip(arrayBuffer);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                // å¡«å…¥è³‡æ–™
                doc.render(templateData);

                // 4. è¼¸å‡ºä¸¦ä¸‹è¼‰
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const fileName = `ç¾©å¤§é†«é™¢å¥‘ç´„æ›¸_${templateData.user_name}.docx`;
                saveAs(blob, fileName);
                
                alert("ä¸‹è¼‰æˆåŠŸï¼");

            } catch (err) {
                console.error(err);
                alert("ç™¼ç”ŸéŒ¯èª¤: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
