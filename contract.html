<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾©å¤§é†«é™¢é•·ç…§åˆç´„ç”Ÿæˆç³»çµ±</title>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.37.11/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f5f7fa; color: #333; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #edf2f7; padding-bottom: 20px; }
        .header h1 { color: #2c3e50; margin: 0; font-size: 2em; }
        .header p { color: #7f8c8d; margin-top: 10px; }

        .step-section { margin-bottom: 30px; }
        .step-header { display: flex; align-items: center; margin-bottom: 15px; }
        .step-number { background: #3498db; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
        .step-title { font-weight: bold; font-size: 1.2em; color: #2c3e50; }

        .upload-box { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc; transition: 0.3s; }
        .upload-box:hover { border-color: #3498db; background: #ebf8ff; }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #fff; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #4a5568; font-size: 0.95em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
        .full-width { grid-column: span 2; }
        .highlight { color: #e53e3e; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; margin-top: 15px; }
        .btn-parse { background-color: #3498db; }
        .btn-parse:hover { background-color: #2980b9; }
        .btn-generate { background-color: #27ae60; }
        .btn-generate:hover { background-color: #219150; }
        .btn:disabled { background-color: #a0aec0; cursor: not-allowed; }

        input[type="file"] { margin-bottom: 10px; }

        .alert-box { 
            background: #fff3cd; 
            border-left: 4px solid #ffc107; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 6px; 
        }
        .alert-box strong { color: #856404; }
        .alert-box p { margin: 8px 0; color: #856404; font-size: 0.95em; }
        .alert-box code { 
            background: #fff; 
            padding: 2px 6px; 
            border-radius: 3px; 
            color: #d63384;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>é•·ç…§åˆç´„è‡ªå‹•ç”Ÿæˆç³»çµ±</h1>
        <p>ç¾©å¤§é†«é™¢å°ˆç”¨ / æ”¯æ´ PDF è§£æèˆ‡ Word ç”Ÿæˆ</p>
    </div>

    <div class="alert-box">
        <strong>âš ï¸ é‡è¦æé†’</strong>
        <p>è¨˜å¾—å†æ¬¡ç¢ºèªç”Ÿæˆå…§å®¹æ˜¯å¦æœ‰èª¤</p>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">ä¸Šå‚³è©•ä¼°é‡è¡¨ PDF</div>
        </div>
        <div class="upload-box">
            <p>è«‹é¸æ“‡å€‹æ¡ˆçš„è©•ä¼°é‡è¡¨ PDF æª”æ¡ˆ</p>
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-parse" onclick="parsePDF()">ğŸ” è§£æè³‡æ–™</button>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">ç¢ºèªåˆç´„è³‡æ–™</div>
        </div>
        
        <div class="grid-form">
            <div class="form-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="user_name" /></div>
            <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="user_id" /></div>
            
            <div class="form-group"><label>å€‹æ¡ˆé›»è©±</label><input type="text" id="user_phone" /></div>
            <div class="form-group">
                <label>éƒ¨åˆ†è² æ“”é‡‘é¡</label>
                <select id="payment">
                    <option value="240">240 (ä¸€èˆ¬æˆ¶)</option>
                    <option value="75">75 (ä¸­ä½æ”¶)</option>
                    <option value="0">0 (ä½æ”¶å…¥æˆ¶)</option>
                </select>
            </div>

            <div class="form-group"><label>ç°½ç´„äººå§“å</label><input type="text" id="contractor_name" /></div>
            <div class="form-group"><label>ç°½ç´„äººé›»è©±</label><input type="text" id="contractor_phone" /></div>

            <div class="form-group full-width">
                <label class="highlight">æˆ¶ç±åœ°å€ (è«‹ç¢ºèªå®Œæ•´æ€§)</label>
                <input type="text" id="household_address" />
            </div>

            <div class="form-group full-width">
                <label class="highlight">é€šè¨Šåœ°å€ (è«‹ç¢ºèªå®Œæ•´æ€§)</label>
                <input type="text" id="contact_address" />
            </div>

            <div class="form-group"><label>è¨ªè¦–æ—¥æœŸ</label><input type="text" id="visit_date"></div>
            <div class="form-group"><label>åˆç´„çµæŸæ—¥æœŸ</label><input type="text" id="end_date"></div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">ç”Ÿæˆ Word å¥‘ç´„æ›¸</div>
        </div>
        <div class="upload-box" style="border-color: #27ae60; background: #f0fdf4;">
            <p style="color: #27ae60; font-weight: bold;">è«‹é¸æ“‡ Word åˆç´„ç¯„æœ¬ (.docx)</p>
            <input type="file" id="template_upload" accept=".docx" />
            <button class="btn btn-generate" onclick="generateWord()">ğŸ“„ ä¸‹è¼‰åˆç´„</button>
        </div>
    </div>
</div>

<script>
    // è¨­å®š PDF.js Worker
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
    }

    // åˆå§‹åŒ–æ—¥æœŸ
    window.onload = function() {
        const today = new Date();
        const rocYear = today.getFullYear() - 1911;
        document.getElementById('visit_date').value = `${rocYear}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
        document.getElementById('end_date').value = `${rocYear+1}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
    };

    // è³‡æ–™æ¸…æ´—å‡½å¼
    function cleanTextDeep(text) {
        return text.replace(/â€»/g, "")
                   .replace(/\(é‡Œ[ã€ï¼Œ]é„°[ã€ï¼Œ]éƒµéå€è™Ÿ.*?\)/g, "")
                   .replace(/[\(ï¼ˆ]éƒµéå€è™Ÿ[:ï¼š]?\s*\d+[\)ï¼‰]/g, "") 
                   .replace(/[()]/g, "")
                   .replace(/[\s\n\r]/g, "");
    }

    function extractAddressFromChunk(chunk) {
        const regex = /([å°è‡º]?[^0-9\s]{2,3}[ç¸£å¸‚].*?[è™Ÿæ¨“])/;
        const match = chunk.match(regex);
        if (match) {
            return match[1].replace(/^[^å°è‡ºé«˜æ–°åŒ—æ¡ƒä¸­å—åŸºå®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å±]*/, "");
        }
        return "";
    }

    // PDF è§£ææ ¸å¿ƒé‚è¼¯
    async function parsePDF() {
        if (typeof pdfjsLib === 'undefined') { alert("PDF å…ƒä»¶è¼‰å…¥ä¸­,è«‹ç¨å€™..."); return; }
        const fileInput = document.getElementById('pdf_upload');
        const btn = document.querySelector('.btn-parse');
        
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ PDF æª”æ¡ˆ!"); return; }

        btn.innerText = "â³ è§£æä¸­...";
        btn.disabled = true;

        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            let fullText = ""; 
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(""); 
            }
            
            const cleanText = cleanTextDeep(fullText);

            // æå–åŸºæœ¬è³‡æ–™
            let userName = "", userId = "", userPhone = "", paymentVal = "240";
            const headerMatch = cleanText.match(/å§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?([^\/]+)\/([A-Z][0-9]{9})/);
            if (headerMatch) { userName = headerMatch[1].replace(/[:ï¼š]/g, ""); userId = headerMatch[2]; }
            
            const phoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
            if (phoneMatch) userPhone = phoneMatch[1];
            
            const welfareMatch = cleanText.match(/é•·ç…§ç¦åˆ©.*?(ç¬¬[ä¸€äºŒä¸‰]é¡)/);
            if (welfareMatch) {
                if (welfareMatch[1].includes("ä¸€")) paymentVal = "0";
                else if (welfareMatch[1].includes("äºŒ")) paymentVal = "75";
            }

            // æå–è¯çµ¡äºº
            let contractorName = userName;
            let contractorPhone = userPhone;
            let agentMatch = cleanText.match(/ä»£ç†äººå§“å(.*?)ä»£ç†äººèº«åˆ†è­‰/);
            if (!agentMatch) agentMatch = cleanText.match(/ä¸»è¦è¯çµ¡äººå§“å(.*?)ä¸»è¦è¯çµ¡äºº/);
            if (agentMatch) {
                let tempName = agentMatch[1].replace(/[:ï¼š]/g, "").trim();
                if (tempName.length > 1) contractorName = tempName;
            }
            const agentPhoneMatch = cleanText.match(/(?:ä»£ç†äºº|è¯çµ¡äºº)æ‰‹æ©Ÿ[::]?.*?((09\d{8}))/);
            if (agentPhoneMatch) contractorPhone = agentPhoneMatch[1];

            // æå–åœ°å€
            let hAddr = "", cAddr = "";
            const idxHouse = cleanText.indexOf("æˆ¶ç±åœ°å€");
            if (idxHouse !== -1) {
                hAddr = extractAddressFromChunk(cleanText.substring(idxHouse, idxHouse + 120));
            }
            
            let idxContact = cleanText.indexOf("é€šè¨Šåœ°å€");
            if (idxContact === -1) idxContact = cleanText.indexOf("å±…ä½é€šè¨Š");
            if (idxContact === -1 && cleanText.indexOf("å±…ä½") !== -1) {
                 const tempIdx = cleanText.lastIndexOf("å±…ä½"); 
                 if (tempIdx > idxHouse) idxContact = tempIdx; 
            }
            
            if (idxContact !== -1) {
                let foundAddr = extractAddressFromChunk(cleanText.substring(idxContact, idxContact + 120));
                if (foundAddr && foundAddr !== hAddr) cAddr = foundAddr;
            }
            
            // å‚™ç”¨æ–¹æ¡ˆ
            if (!hAddr || !cAddr) {
                const allAddrRegex = /([å°è‡º]?[^0-9\s]{2,3}[ç¸£å¸‚].*?[è™Ÿæ¨“])/g;
                const matches = [];
                let m;
                while ((m = allAddrRegex.exec(cleanText)) !== null) {
                    let a = m[1].replace(/^[^å°è‡ºé«˜æ–°åŒ—æ¡ƒä¸­å—åŸºå®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å±]*/, "");
                    if (!a.includes("ä¸­å¿ƒ") && !a.includes("é†«é™¢") && !a.includes("è¡›ç”Ÿå±€") && a.length > 8) matches.push(a);
                }
                if (!hAddr && matches.length > 0) hAddr = matches[0];
                if (!cAddr && matches.length > 1) cAddr = matches[1];
            }
            if (!cAddr) cAddr = hAddr;

            // å¡«å…¥è¡¨å–®
            document.getElementById('user_name').value = userName;
            document.getElementById('user_id').value = userId;
            document.getElementById('user_phone').value = userPhone;
            document.getElementById('payment').value = paymentVal;
            document.getElementById('contractor_name').value = contractorName;
            document.getElementById('contractor_phone').value = contractorPhone;
            document.getElementById('household_address').value = hAddr;
            document.getElementById('contact_address').value = cAddr;

        } catch (err) {
            alert("è§£æç™¼ç”ŸéŒ¯èª¤: " + err.message);
        } finally {
            btn.innerText = "ğŸ” è§£æè³‡æ–™";
            btn.disabled = false;
        }
    }

    // ===== Word ç”Ÿæˆ - ä½¿ç”¨å®¹éŒ¯æ¨¡å¼ =====
    async function generateWord() {
        if (typeof PizZip === 'undefined') { alert("ç³»çµ±è¼‰å…¥ä¸­,è«‹ç¨å€™..."); return; }

        const templateInput = document.getElementById('template_upload');
        const btn = document.querySelector('.btn-generate');
        
        if (templateInput.files.length === 0) {
            alert("è«‹å…ˆé¸æ“‡æ‚¨çš„ Word åˆç´„ç¯„æœ¬ (.docx)!");
            return;
        }

        btn.innerText = "â³ è™•ç†ä¸­...";
        btn.disabled = true;

        try {
            const file = templateInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const zip = new PizZip(arrayBuffer);

            const templateData = {
                user_name: document.getElementById('user_name').value || " ",
                user_id: document.getElementById('user_id').value || " ",
                user_phone: document.getElementById('user_phone').value || " ",
                payment: document.getElementById('payment').value || "0",
                contractor_name: document.getElementById('contractor_name').value || "åŒä½¿ç”¨è€…",
                contractor_phone: document.getElementById('contractor_phone').value || " ",
                household_address: document.getElementById('household_address').value || " ",
                contact_address: document.getElementById('contact_address').value || " ",
                visit_date: document.getElementById('visit_date').value || " ",
                end_date: document.getElementById('end_date').value || " "
            };

            // ä½¿ç”¨å®¹éŒ¯è§£æå™¨
            const doc = new window.docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
                nullGetter: () => "",
                delimiters: {
                    start: '{{',
                    end: '}}'
                }
            });

            // è¨­å®šè³‡æ–™ä¸¦æ¸²æŸ“
            doc.setData(templateData);
            doc.render();

            const blob = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            });

            saveAs(blob, `ç¾©å¤§é†«é™¢å¥‘ç´„æ›¸_${templateData.user_name}.docx`);
            alert("âœ… åˆç´„ç”ŸæˆæˆåŠŸ!");
            
        } catch (error) {
            console.error("è©³ç´°éŒ¯èª¤:", error);
            
            // å‹å–„çš„éŒ¯èª¤è¨Šæ¯
            let errorMsg = "ç”Ÿæˆå¤±æ•—,è«‹æª¢æŸ¥æ¨¡æ¿:\n\n";
            
            if (error.properties && error.properties.errors) {
                const errors = error.properties.errors;
                const tagErrors = errors.filter(e => e.message && e.message.includes('duplicate'));
                
                if (tagErrors.length > 0) {
                    errorMsg += "âŒ ç™¼ç¾æ¨™ç±¤æ ¼å¼å•é¡Œ!\n\n";
                    errorMsg += "åŸå› : Word åœ¨å„²å­˜æ™‚è‡ªå‹•æ‹†é–‹äº†æ¨™ç±¤\n\n";
                    errorMsg += "è§£æ±ºæ–¹æ³•:\n";
                    errorMsg += "1. ä½¿ç”¨ Google Docs é‡æ–°è£½ä½œæ¨¡æ¿\n";
                    errorMsg += "2. æˆ–ä½¿ç”¨ LibreOffice Writer\n";
                    errorMsg += "3. æˆ–åœ¨ Word ä¸­ä¸€æ¬¡æ‰“å®Œæ•´å€‹æ¨™ç±¤,ä¸­é–“ä¸è¦åœé “\n\n";
                    errorMsg += "æœ‰å•é¡Œçš„æ¨™ç±¤:\n";
                    tagErrors.forEach(e => {
                        const match = e.message.match(/{{([^}]+)}}/);
                        if (match) errorMsg += `  â€¢ {{${match[1]}}}\n`;
                    });
                }
            } else {
                errorMsg += error.message;
            }
            
            alert(errorMsg);
        } finally {
            btn.innerText = "ğŸ“„ ä¸‹è¼‰åˆç´„";
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
