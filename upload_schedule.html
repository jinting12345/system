<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­è¡¨ä¸Šå‚³</title>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient; // æ›è¼‰åˆ°å…¨åŸŸ
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; display: flex; align-items: center; font-weight: bold; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h3 { margin-top: 0; color: #333; }
        .instruction { background: #e8f0fe; padding: 15px; border-radius: 4px; font-size: 14px; color: #1967d2; margin-bottom: 20px; line-height: 1.6; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="file"], input[type="month"] { display: block; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button { padding: 12px 24px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.2s; width: 100%; margin-top: 10px; }
        button:hover { background: #0b5ed7; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; font-weight: bold; white-space: pre-wrap; line-height: 1.5; }
        .log-box { margin-top: 15px; padding: 12px; background: #212529; color: #0f0; border-radius: 6px; max-height: 250px; overflow-y: auto; font-size: 12px; font-family: Consolas, monospace; display: none; }

        #resultArea { display: none; margin-top: 20px; }
        .table-container { overflow-x: auto; border: 1px solid #dee2e6; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; font-size: 14px; }
        th { background-color: #f1f3f5; color: #495057; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }
        .tag-shift { background: #e3f2fd; color: #0d47a1; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
    </div>

    <div class="card">
        <h3>ğŸ“… ä¸Šå‚³ Excel ç­è¡¨ (è‡ªå‹•è¦†è“‹èˆŠè³‡æ–™)</h3>
        
        <div class="instruction">
            <strong>ğŸ’¡ åŠŸèƒ½æ›´æ–°ï¼š</strong><br>
            1. ç³»çµ±æœƒè‡ªå‹•åˆªé™¤è©²æœˆä»½èˆŠçš„ç­è¡¨ï¼Œå†å¯«å…¥æ–°çš„ (é¿å…é‡è¤‡)ã€‚<br>
            2. å·²åŠ å¼·éæ¿¾ï¼Œæœƒè‡ªå‹•å¿½ç•¥ Excel ä¸‹æ–¹çš„å‚™è¨»æ–‡å­—ã€‚<br>
            3. <strong>ä¸Šå‚³å¾Œè«‹å‹™å¿…æŸ¥çœ‹ä¸‹æ–¹é è¦½ï¼Œç¢ºèªåå­—æ˜¯å¦æ­£ç¢ºã€‚</strong>
        </div>

        <div class="form-group">
            <label for="targetMonth">æŒ‡å®šä¸Šå‚³æœˆä»½ (é¸å¡«ï¼Œä¸é¸å‰‡è‡ªå‹•æŠ“æœ€æ–°)</label>
            <input type="month" id="targetMonth">
        </div>

        <div class="form-group">
            <label for="fileInput">é¸æ“‡ Excel æª”æ¡ˆ (.xlsx)</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
        </div>

        <button id="uploadBtn" onclick="processExcel()">ğŸš€ é–‹å§‹åˆ†æä¸¦ä¸Šå‚³</button>
        <div id="status"></div>
        <div id="log" class="log-box"></div>
    </div>

    <div id="resultArea" class="card">
        <h3>ğŸ“‹ å€¼ç­äººå“¡æ¸…å–®é è¦½</h3>
        <p style="color: #666; font-size: 0.9em;">è«‹ç¢ºèªä»¥ä¸‹æ—¥æœŸèˆ‡äººå“¡æ˜¯å¦æ­£ç¢ºï¼š</p>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>å§“å</th>
                        <th>ç­åˆ¥ä»£ç¢¼</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.onerror = function(msg) {
            alert("âš ï¸ éŒ¯èª¤: " + msg);
            return false;
        };

        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        
        let supabase = null;

        // ğŸ”¥ ä¿®æ”¹ 2: åˆå§‹åŒ–é‚è¼¯ (ç­‰å¾… ESM)
        window.onload = function() {
            setTimeout(() => {
                try {
                    if (window.createClient) {
                        supabase = window.createClient(RAW_URL, RAW_KEY);
                        console.log("Supabase Ready");
                    } else {
                        throw new Error("Supabase å…ƒä»¶è¼‰å…¥å¤±æ•—");
                    }
                } catch(e) {
                    document.getElementById('status').innerHTML = `<span style="color:red">âš ï¸ ç³»çµ±å…ƒä»¶è¢«é˜»æ“‹ï¼Œç„¡æ³•é€£ç·šè³‡æ–™åº«ã€‚<br>è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–ç¶²è·¯ã€‚</span>`;
                    document.getElementById('uploadBtn').disabled = true;
                }
            }, 500);
        };

        function log(message) {
            const logBox = document.getElementById('log');
            logBox.style.display = 'block';
            logBox.innerHTML += `<div>${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function processExcel() {
            if(!supabase) { alert("ç³»çµ±æœªé€£ç·š"); return; }

            const fileInput = document.getElementById('fileInput');
            const targetMonthInput = document.getElementById('targetMonth');
            const status = document.getElementById('status');
            const btn = document.getElementById('uploadBtn');
            const logBox = document.getElementById('log');
            const resultArea = document.getElementById('resultArea');
            
            resultArea.style.display = 'none'; 
            status.innerText = '';
            
            if(!fileInput.files.length) { status.innerText = 'âŒ è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆ (.xlsx)'; return; }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            status.innerText = 'â³ æ­£åœ¨è®€å–ä¸¦åˆ†ææª”æ¡ˆ...';
            logBox.innerHTML = ''; 
            btn.disabled = true;

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let validSheets = [];
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        if (rows.length < 5) return;
                        const titleCell = rows[0][0];
                        if (!titleCell || typeof titleCell !== 'string') return;
                        const dateMatch = titleCell.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                        if (dateMatch) {
                            validSheets.push({
                                sheetName: sheetName,
                                year: dateMatch[1],
                                month: dateMatch[2].padStart(2, '0'),
                                sortKey: parseInt(dateMatch[1] + dateMatch[2].padStart(2, '0')),
                                rows: rows
                            });
                        }
                    });

                    if (validSheets.length === 0) throw new Error("ç„¡æ³•è­˜åˆ¥æœˆä»½æ¨™é¡Œ (éœ€åŒ…å« YYYYå¹´MMæœˆ)ã€‚");

                    let targetSheet = null;
                    const userSelectedMonth = targetMonthInput.value;
                    if (userSelectedMonth) {
                        const [uYear, uMonth] = userSelectedMonth.split('-');
                        targetSheet = validSheets.find(s => s.year === uYear && s.month === uMonth);
                        if (!targetSheet) throw new Error(`æ‰¾ä¸åˆ° ${uYear}å¹´${uMonth}æœˆ çš„å·¥ä½œè¡¨ã€‚`);
                    } else {
                        validSheets.sort((a, b) => b.sortKey - a.sortKey);
                        targetSheet = validSheets[0];
                    }

                    // é–‹å§‹è§£æ
                    let allInsertData = [];
                    const rows = targetSheet.rows;
                    const year = targetSheet.year;
                    const month = targetSheet.month;
                    const dayRow = rows[2]; // ç¬¬3åˆ—æ˜¯æ—¥æœŸ

                    let colToDateMap = {}; 
                    for (let c = 1; c < dayRow.length; c++) {
                        const dayVal = dayRow[c];
                        if (dayVal && !isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
                            const dayStr = String(dayVal).padStart(2, '0');
                            colToDateMap[c] = `${year}-${month}-${dayStr}`;
                        }
                    }

                    for (let r = 4; r < rows.length; r++) {
                        const row = rows[r];
                        const staffName = row[0];

                        if (!staffName || typeof staffName !== 'string') continue;
                        let cleanName = staffName.trim();
                        // éæ¿¾é‚è¼¯
                        if (cleanName.includes('ä¸»ç®¡') || cleanName.includes('å‚™è¨»') || cleanName.includes('é è¨ˆ')) continue;
                        if (cleanName.length > 5) continue;
                        if (cleanName.startsWith('*')) continue;

                        for (let c in colToDateMap) {
                            const cellValue = row[c];
                            const dateStr = colToDateMap[c];
                            if (cellValue && typeof cellValue === 'string' && cellValue.toUpperCase().includes('BN')) {
                                allInsertData.push({
                                    date: dateStr,
                                    shift: cellValue.trim(), 
                                    staff_name: cleanName,
                                    staff_email: '' 
                                });
                            }
                        }
                    }

                    if (allInsertData.length === 0) {
                        status.innerText = `âš ï¸ åœ¨ ${year}å¹´${month}æœˆ ä¸­æ²’æœ‰ç™¼ç¾ä»»ä½•å«æœ‰ "BN" çš„æ’ç­ã€‚`;
                        btn.disabled = false;
                        return;
                    }

                    renderTable(allInsertData);

                    // ============================================
                    // è³‡æ–™åº«æ“ä½œ
                    // ============================================
                    status.innerText = `ğŸ”„ æ­£åœ¨æ¸…ç† ${year}å¹´${month}æœˆ çš„èˆŠè³‡æ–™...`;
                    
                    const startDate = `${year}-${month}-01`;
                    const lastDay = new Date(year, month, 0).getDate();
                    const endDate = `${year}-${month}-${lastDay}`;

                    // 1. åˆªé™¤è©²æœˆä»½èˆŠè³‡æ–™
                    const { error: delError } = await supabase
                        .from('duty_roster')
                        .delete()
                        .gte('date', startDate)
                        .lte('date', endDate);
                    
                    if (delError) throw new Error("åˆªé™¤èˆŠè³‡æ–™å¤±æ•—: " + delError.message);

                    status.innerText = `ğŸš€ èˆŠè³‡æ–™å·²æ¸…é™¤ï¼Œæ­£åœ¨å¯«å…¥ ${allInsertData.length} ç­†æ–°è³‡æ–™...`;

                    // 2. å¯«å…¥æ–°è³‡æ–™
                    const { error } = await supabase.from('duty_roster').insert(allInsertData);
                    
                    if(error) throw error;
                    
                    status.innerHTML = `<span style="color:#198754; font-size:1.1em;">âœ… ä¸Šå‚³æˆåŠŸï¼å·²æ›´æ–° ${year}å¹´${month}æœˆ è³‡æ–™ã€‚</span>`;
                    log('âœ… è³‡æ–™åº«å¯«å…¥å®Œç•¢ã€‚');

                } catch(err) {
                    console.error(err);
                    status.innerHTML = `<span style="color:#dc3545">âŒ å¤±æ•—: ${err.message || err}</span>`;
                } finally {
                    btn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTable(data) {
            const resultArea = document.getElementById('resultArea');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = ''; 
            data.sort((a, b) => new Date(a.date) - new Date(b.date));
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.date}</td><td style="font-weight:bold;">${item.staff_name}</td><td><span class="tag-shift">${item.shift}</span></td>`;
                tbody.appendChild(tr);
            });
            resultArea.style.display = 'block';
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>
