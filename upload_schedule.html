<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­è¡¨ä¸Šå‚³ (BNå°ˆç”¨ä¿®å¾©ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #666; display: flex; align-items: center; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; color: #333; }
        .instruction { background: #e8f0fe; padding: 15px; border-radius: 4px; font-size: 14px; color: #1967d2; margin-bottom: 20px; line-height: 1.6; }
        
        input[type="file"] { margin: 20px 0; display: block; width: 100%; }
        button { padding: 12px 24px; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.2s; }
        button:hover { background: #0b5ed7; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; font-weight: bold; white-space: pre-wrap; line-height: 1.5; }
        .log-box { margin-top: 15px; padding: 12px; background: #212529; color: #0f0; border-radius: 6px; max-height: 250px; overflow-y: auto; font-size: 12px; font-family: Consolas, monospace; display: none; }
    </style>
</head>
<body>
    <div class="header">
        <a href="menu.html" class="back-btn">â¬… å›é¸å–®</a>
    </div>

    <div class="card">
        <h3>ğŸ“… ä¸Šå‚³ Excel ç‡Ÿé¤Šæ²»ç™‚ç§‘ç­è¡¨ (BNä¿®å¾©ç‰ˆ)</h3>
        
        <div class="instruction">
            <strong>ğŸ’¡ åŠŸèƒ½èªªæ˜ï¼š</strong><br>
            1. è‡ªå‹•è®€å– Excel ä¸­çš„å¹´ä»½èˆ‡æœˆä»½ (å¦‚ï¼š2025å¹´12æœˆ)ã€‚<br>
            2. è‡ªå‹•å°æ‡‰æ—¥æœŸ (1~31è™Ÿ) èˆ‡äººå“¡å§“åã€‚<br>
            3. <strong>æ™ºæ…§éæ¿¾ï¼š</strong> åƒ…æŠ“å–å«æœ‰ <code>BN</code> çš„æ’ç­ (åŒ…å« BN+3)ï¼Œä¸¦è‡ªå‹•æ’é™¤åº•éƒ¨çš„èªªæ˜æ–‡å­—ã€‚
        </div>

        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <button id="uploadBtn" onclick="processExcel()">ğŸš€ é–‹å§‹åˆ†æä¸¦ä¸Šå‚³</button>
        <div id="status"></div>
        <div id="log" class="log-box"></div>
    </div>

    <script>
        // ç°¡å–®çš„å­—ä¸²æ¸…ç†å‡½æ•¸
        function cleanString(str) { return str ? str.replace(/[^\x20-\x7E]/g, '').trim() : ''; }
        
        // Supabase è¨­å®š (ä¿ç•™æ‚¨åŸæœ¬æä¾›çš„ Key)
        const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
        const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
        const supabase = window.supabase.createClient(cleanString(RAW_URL), cleanString(RAW_KEY));

        function log(message) {
            const logBox = document.getElementById('log');
            logBox.style.display = 'block';
            logBox.innerHTML += `<div>${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function processExcel() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            const btn = document.getElementById('uploadBtn');
            const logBox = document.getElementById('log');
            
            if(!fileInput.files.length) { status.innerText = 'âŒ è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆ (.xlsx)'; return; }
            
            const file = fileInput.files[0];
            const reader = new FileReader();

            status.innerText = 'â³ æ­£åœ¨è®€å–ä¸¦åˆ†ææª”æ¡ˆ...';
            logBox.innerHTML = ''; 
            btn.disabled = true;

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let allInsertData = [];
                    let processedSheets = 0;
                    
                    // éæ­·æ¯ä¸€å€‹ Sheet
                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        // header:1 æœƒç”¢ç”ŸäºŒç¶­é™£åˆ— [row1, row2, ...]
                        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

                        if (rows.length < 5) return; 

                        // 1. æŠ“å–æ¨™é¡Œä¸­çš„ å¹´/æœˆ (é è¨­åœ¨ A1)
                        const titleCell = rows[0][0];
                        if (!titleCell || typeof titleCell !== 'string') return;

                        const dateMatch = titleCell.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
                        if (!dateMatch) {
                            log(`âš ï¸ Sheet [${sheetName}]ï¼šæ¨™é¡Œç„¡æ³•è­˜åˆ¥å¹´ä»½æœˆä»½ï¼Œè·³éã€‚`);
                            return;
                        }

                        const year = dateMatch[1];
                        const month = dateMatch[2].padStart(2, '0');
                        log(`ğŸ“‚ è®€å– Sheet [${sheetName}] -> ${year}-${month}`);
                        processedSheets++;

                        // 2. å®šä½æ—¥æœŸåˆ— (Row Index 2 => Excel ç¬¬3åˆ—)
                        const dayRowIndex = 2;
                        const dayRow = rows[dayRowIndex];
                        if (!dayRow) return;

                        // å»ºç«‹ Column Index -> æ—¥æœŸå­—ä¸² çš„å°ç…§è¡¨
                        let colToDateMap = {}; 
                        for (let c = 1; c < dayRow.length; c++) {
                            const dayVal = dayRow[c];
                            // ç¢ºä¿æ˜¯ 1~31 çš„æ•¸å­—
                            if (dayVal && !isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
                                const dayStr = String(dayVal).padStart(2, '0');
                                colToDateMap[c] = `${year}-${month}-${dayStr}`;
                            }
                        }

                        // 3. éæ­·äººå“¡åˆ— (å¾ Row Index 4 => Excel ç¬¬5åˆ— é–‹å§‹)
                        for (let r = 4; r < rows.length; r++) {
                            const row = rows[r];
                            const staffName = row[0]; // Aæ¬„å§“å

                            // éæ¿¾ç„¡æ•ˆåˆ—ï¼šç©ºåã€èªªæ˜æ–‡å­—(*é–‹é ­)ã€ä¸»ç®¡åˆ—è¡¨
                            if (!staffName || typeof staffName !== 'string') continue;
                            if (staffName.trim().startsWith('*') || staffName.includes('ä¸»ç®¡') || staffName.length > 8) {
                                continue; 
                            }

                            // æª¢æŸ¥æ¯ä¸€å¤©çš„æ’ç­
                            for (let c in colToDateMap) {
                                const cellValue = row[c];
                                const dateStr = colToDateMap[c];

                                // åˆ¤æ–·æ˜¯å¦åŒ…å« BN (è½‰å¤§å¯«æ¯”å°)
                                if (cellValue && typeof cellValue === 'string') {
                                    if (cellValue.toUpperCase().includes('BN')) {
                                        allInsertData.push({
                                            date: dateStr,
                                            shift: cellValue.trim(), 
                                            staff_name: staffName.trim(),
                                            staff_email: '' 
                                        });
                                    }
                                }
                            }
                        }
                    });

                    if (processedSheets === 0) {
                        status.innerText = 'âŒ éŒ¯èª¤ï¼šç„¡æ³•åœ¨æª”æ¡ˆä¸­è­˜åˆ¥å‡ºä»»ä½•æœ‰æ•ˆçš„æœˆä»½æ¨™é¡Œ (éœ€åŒ…å« YYYYå¹´MMæœˆ)ã€‚';
                        btn.disabled = false;
                        return;
                    }

                    if (allInsertData.length === 0) {
                        status.innerText = 'âš ï¸ åˆ†æå®Œæˆï¼Œä½†æ²’æœ‰ç™¼ç¾ä»»ä½•å«æœ‰ "BN" çš„æ’ç­ã€‚';
                        btn.disabled = false;
                        return;
                    }

                    status.innerText = `ğŸ“Š åˆ†æå®Œæˆï¼å…±æ‰¾åˆ° ${allInsertData.length} ç­†å€¼ç­è³‡æ–™ã€‚\nğŸš€ æ­£åœ¨å¯«å…¥è³‡æ–™åº«...`;
                    
                    // æ‰¹æ¬¡å¯«å…¥ Supabase
                    const { error } = await supabase.from('duty_roster').insert(allInsertData);
                    
                    if(error) throw error;
                    
                    status.innerHTML = `<span style="color:#198754; font-size:1.1em;">âœ… ä¸Šå‚³æˆåŠŸï¼å·²åŒ¯å…¥ ${allInsertData.length} ç­†è³‡æ–™ã€‚</span>`;
                    log('âœ… è³‡æ–™åº«å¯«å…¥å®Œç•¢ã€‚');

                } catch(err) {
                    console.error(err);
                    status.innerHTML = `<span style="color:#dc3545">âŒ ä¸Šå‚³å¤±æ•—: ${err.message || err}</span>`;
                } finally {
                    btn.disabled = false;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
