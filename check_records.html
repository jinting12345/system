<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ¥çœ‹ç…§ç‰‡ç´€éŒ„</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: #f2f4f8; margin: 0; padding: 10px; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 90px; }
        
        .btn-back { background-color: #6c757d; text-decoration: none; padding: 6px 12px; border-radius: 4px; color: white; font-size: 13px; font-weight: bold; display: inline-block; margin-bottom: 10px; }

        /* --- è¿·ä½ è³‡è¨Šåˆ— --- */
        .info-bar { 
            background: white; 
            padding: 8px 15px; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            font-size: 13px;
            border-left: 4px solid #007aff;
        }
        .info-label { color: #666; margin-right: 5px; }
        .info-val { font-weight: bold; color: #333; }
        .info-alert { color: #f59e0b; font-weight:bold; margin-left: 5px; }

        /* --- é€±å°èˆªæ§åˆ¶å™¨ --- */
        .week-nav { background: white; padding: 8px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .nav-btn { background: #e3f2fd; color: #007aff; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .nav-btn:active { background: #bbdefb; }
        .date-range { text-align: center; font-weight: bold; color: #333; font-size: 0.95em; }
        .date-range small { display: inline-block; color: #888; font-size: 0.8em; margin-left: 5px; font-weight: normal;}

        /* --- å¡ç‰‡å¼åˆ—è¡¨ --- */
        .record-list { display: flex; flex-direction: column; gap: 10px; }
        .day-card { background: white; border-radius: 10px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; }
        .day-card.weekend { background-color: #fffbf0; border-color: #faeacc; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #eee; }
        
        /* æ—¥æœŸæ¨™é¡Œå€ (å« checkbox) */
        .date-title { font-size: 1em; font-weight: bold; color: #007aff; display: flex; align-items: center; gap: 8px; }
        .date-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #007aff; }

        .staff-row { display: flex; align-items: center; gap: 3px; font-size: 0.85em; color: #555; }
        .staff-input { border: 1px solid #ddd; background: #f9f9f9; padding: 2px 5px; border-radius: 4px; width: 60px; text-align: center; font-weight: bold; color: #333; font-size: 13px; }
        .staff-input:focus { border-color: #007aff; background: white; outline: none; }

        /* --- é¤é»ç¶²æ ¼ (å°æŒ‰éˆ•) --- */
        .meal-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .meal-box { 
            background: #f8f9fa; 
            border-radius: 6px; 
            padding: 5px 2px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 2px; 
            cursor: pointer; 
            border: 1px solid transparent; 
        }
        .meal-box:active { transform: scale(0.95); background: #eef; }
        
        .meal-title { font-size: 11px; color: #666; }
        
        /* ç‹€æ…‹ç‡ˆè™Ÿ */
        .status-dot { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .ok { background: #e6fffa; color: #00b894; border: 1px solid #b2f5ea; } 
        .no { background: #fff5f5; color: #fc8181; border: 1px solid #fed7d7; } 

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 900; }
        .fab-btn { width: 48px; height: 48px; border-radius: 50%; border: none; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .fab-btn:active { transform: scale(0.9); }
        
        .fab-download { background: #34c759; }
        .fab-delete { background: #ff3b30; display: none; } /* é è¨­éš±è—ï¼Œç®¡ç†å“¡æ‰é¡¯ç¤º */
        .fab-reload { background: #007aff; }

        /* å…¨é¸æŒ‰éˆ• (æµ®å‹•åœ¨å·¦ä¸‹) */
        .select-all-btn { position: fixed; bottom: 25px; left: 20px; background: white; color: #333; padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; border: 1px solid #ddd; z-index: 900;}

        /* Modal */
        .modal { display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        .modal img { max-width: 95%; max-height: 85vh; border-radius: 8px; }
        .close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; }
        .modal-caption { position: absolute; bottom: 30px; color: white; text-align: center; width: 100%; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="color:#007aff; font-weight:bold; font-size:1.2em;">è¼‰å…¥ä¸­...</div>
</div>

<div id="imageModal" class="modal" onclick="this.style.display='none'">
    <span class="close-modal">&times;</span>
    <img id="modalImg">
    <div id="caption" class="modal-caption"></div>
</div>

<div class="container">
    <a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

    <div class="info-bar">
        <div>
            <span class="info-label">æœ¬é€±ç…§ç‰‡:</span>
            <span class="info-val" id="week-count">0</span>
        </div>
        <div>
            <span class="info-label">ç©ºé–“:</span>
            <span class="info-val" id="storage-usage">...</span>
            <span class="info-alert" id="storage-days"></span>
        </div>
    </div>

    <div class="week-nav">
        <button class="nav-btn" onclick="changeWeek(-7)">â® ä¸Šé€±</button>
        <div class="date-range">
            <span id="current-range-text">--/-- - --/--</span>
            <small id="current-week-num"></small>
        </div>
        <button class="nav-btn" onclick="changeWeek(7)">ä¸‹é€± â¯</button>
    </div>

    <div id="record-list" class="record-list"></div>
</div>

<button class="select-all-btn" onclick="toggleSelectAll()">â˜‘ å…¨é¸æœ¬é€±</button>

<div class="fab-container">
    <button class="fab-btn fab-reload" onclick="fetchData()" title="é‡æ–°æ•´ç†">â†»</button>
    <button class="fab-btn fab-download" onclick="handleDownloadSelected()" title="ä¸‹è¼‰é¸å–">ğŸ“¥</button>
    <button id="btn-delete" class="fab-btn fab-delete" onclick="handleDeleteSelected()" title="åˆªé™¤é¸å–">ğŸ—‘ï¸</button>
</div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    let supabase = null;
    
    let currentWeekStart = new Date(); 
    let currentRecords = [];
    let weekDates = []; 
    let isAdmin = false;
    let currentUserEmail = "";

    window.onload = function() {
        initDate(); 
        try {
            supabase = createClient(RAW_URL, RAW_KEY);
            initApp();
        } catch(e) {
            alert("åˆå§‹åŒ–éŒ¯èª¤: " + e.message);
        }
    };

    function initDate() {
        const now = new Date();
        const day = now.getDay(); 
        const diff = now.getDate() - day; 
        currentWeekStart = new Date(now.setDate(diff));
        currentWeekStart.setHours(0,0,0,0);
    }

    async function initApp() {
        const { data } = await supabase.auth.getSession();
        if(!data.session) { window.location.href = 'index.html'; return; }
        
        currentUserEmail = data.session.user.email;
        await checkUserRole(); // å…ˆç¢ºèªæ¬Šé™
        await fetchData();
        updateGlobalStats();
    }

    // æ¬Šé™æª¢æŸ¥ï¼šåªæœ‰ Admin å¯ä»¥çœ‹åˆ°åˆªé™¤éˆ•
    async function checkUserRole() {
        try {
            const { data } = await supabase.from('user_roles').select('role').eq('email', currentUserEmail).single();
            isAdmin = (data && data.role === 'admin');
            
            const delBtn = document.getElementById('btn-delete');
            if(isAdmin) {
                delBtn.style.display = 'flex';
            } else {
                delBtn.style.display = 'none'; // å“¡å·¥éš±è—
            }
        } catch(e) {
            console.warn("Role check error", e);
            isAdmin = false;
        }
    }

    window.changeWeek = function(days) {
        currentWeekStart.setDate(currentWeekStart.getDate() + days);
        fetchData();
    }

    window.fetchData = async function() {
        showLoading(true);
        try {
            const startDate = new Date(currentWeekStart);
            const endDate = new Date(currentWeekStart);
            endDate.setDate(startDate.getDate() + 6); 

            const sStr = startDate.toISOString().split('T')[0];
            const eStr = endDate.toISOString().split('T')[0];

            document.getElementById('current-range-text').innerText = 
                `${startDate.getMonth()+1}/${startDate.getDate()} - ${endDate.getMonth()+1}/${endDate.getDate()}`;
            document.getElementById('current-week-num').innerText = `(${startDate.getFullYear()})`;

            const { data: scheduleData } = await supabase.from('duty_roster')
                .select('date, staff_name')
                .gte('date', sStr).lte('date', eStr);

            const { data: recordData } = await supabase.from('meal_records')
                .select('*')
                .gte('record_date', sStr).lte('record_date', eStr);

            currentRecords = recordData || [];
            
            renderWeek(startDate, scheduleData || [], currentRecords);
            
            document.getElementById('week-count').innerText = currentRecords.length;

        } catch(e) {
            console.error(e);
            alert("è®€å–å¤±æ•—");
        } finally {
            showLoading(false);
        }
    }

    function renderWeek(startObj, schedules, records) {
        const container = document.getElementById('record-list');
        container.innerHTML = '';
        weekDates = []; 
        const weekStr = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        for(let i=0; i<7; i++) {
            let d = new Date(startObj);
            d.setDate(d.getDate() + i);
            const dateStr = d.toISOString().split('T')[0];
            weekDates.push(dateStr);

            const isWeekend = (i === 0 || i === 6);
            const dayLabel = `${d.getMonth()+1}/${d.getDate()} (${weekStr[i]})`;
            const staff = schedules.find(s => s.date === dateStr)?.staff_name || '';
            const dayRecs = records.filter(r => r.record_date === dateStr);

            const card = document.createElement('div');
            card.className = `day-card ${isWeekend ? 'weekend' : ''}`;
            
            // ğŸ”¥ åŠ å…¥ Checkbox
            card.innerHTML = `
                <div class="card-header">
                    <div class="date-title">
                        <input type="checkbox" class="date-checkbox" value="${dateStr}">
                        ${dayLabel}
                    </div>
                    <div class="staff-row">
                        å€¼ç­ <input type="text" class="staff-input" value="${staff}" 
                        onchange="updateStaff('${dateStr}', this.value)">
                    </div>
                </div>
                
                <div class="meal-grid">
                    ${renderMealBox(dayRecs, dateStr, 'breakfast', 'patient', 'æ—©-ç—…')}
                    ${renderMealBox(dayRecs, dateStr, 'breakfast', 'nursing', 'æ—©-è­·')}
                    ${renderMealBox(dayRecs, dateStr, 'lunch', 'patient', 'åˆé¤')}
                    ${renderMealBox(dayRecs, dateStr, 'dinner', 'patient', 'æ™šé¤')}
                </div>
            `;
            container.appendChild(card);
        }
    }

    function renderMealBox(dayRecs, dateStr, meal, target, label) {
        const rec = dayRecs.find(r => r.meal_type === meal && r.target_type === target);
        const hasPhoto = !!rec;
        const iconClass = hasPhoto ? 'ok' : 'no';
        const iconText = hasPhoto ? 'âœ”' : 'âœ–';
        const action = hasPhoto ? `onclick="window.viewPhoto('${rec.photo_path}', '${dateStr} ${label}')"` : '';

        return `
            <div class="meal-box" ${action}>
                <div class="status-dot ${iconClass}">${iconText}</div>
                <div class="meal-title">${label}</div>
            </div>
        `;
    }

    async function updateGlobalStats() {
        const { count } = await supabase.from('meal_records').select('*', { count: 'exact', head: true });
        const total = count || 0;
        const usedMB = (total * 0.5).toFixed(1);
        document.getElementById('storage-usage').innerText = `${usedMB} MB`;
        
        // å‰©é¤˜å¤©æ•¸è¨ˆç®—
        const left = Math.floor((500 - total*0.5)/3);
        const alertEl = document.getElementById('storage-days');
        alertEl.innerText = `(å‰©ç´„ ${left} å¤©)`;
    }

    window.updateStaff = async function(date, val) {
        val = val.trim();
        const { data } = await supabase.from('duty_roster').select('*').eq('date', date);
        if(data.length > 0) {
            if(val) await supabase.from('duty_roster').update({staff_name: val}).eq('date', date);
            else await supabase.from('duty_roster').delete().eq('date', date);
        } else if(val) {
            await supabase.from('duty_roster').insert([{date: date, staff_name: val, shift: 'BN'}]);
        }
    }

    // ğŸ”¥ å…¨é¸/å–æ¶ˆå…¨é¸
    let isAllSelected = false;
    window.toggleSelectAll = function() {
        const checkboxes = document.querySelectorAll('.date-checkbox');
        isAllSelected = !isAllSelected;
        checkboxes.forEach(cb => cb.checked = isAllSelected);
        const btn = document.querySelector('.select-all-btn');
        btn.innerText = isAllSelected ? "â˜’ å–æ¶ˆå…¨é¸" : "â˜‘ å…¨é¸æœ¬é€±";
    }

    // ğŸ”¥ ä¸‹è¼‰é¸å–
    window.handleDownloadSelected = async function() {
        const checkboxes = document.querySelectorAll('.date-checkbox:checked');
        if (checkboxes.length === 0) return alert("è«‹å…ˆå‹¾é¸æ—¥æœŸ");

        const selectedDates = Array.from(checkboxes).map(cb => cb.value);
        // éæ¿¾å‡ºé¸å–æ—¥æœŸçš„ç…§ç‰‡
        const targetRecords = currentRecords.filter(r => selectedDates.includes(r.record_date));

        if(targetRecords.length === 0) return alert("é¸å–çš„æ—¥æœŸæ²’æœ‰ç…§ç‰‡");

        showLoading(true);
        const zip = new JSZip();
        
        await Promise.all(targetRecords.map(async r => {
            const { data } = await supabase.storage.from('private_photos').download(r.photo_path);
            if(data) {
                const fname = `${r.record_date}_${translate(r.meal_type)}_${translate(r.target_type)}.jpg`;
                zip.file(fname, data);
            }
        }));
        
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, `ç…§ç‰‡å‚™ä»½_${selectedDates[0]}.zip`);
        showLoading(false);
    }

    // ğŸ”¥ åˆªé™¤é¸å– (å«æ¬Šé™æª¢æŸ¥)
    window.handleDeleteSelected = async function() {
        if (!isAdmin) return alert("æ¬Šé™ä¸è¶³ï¼šåƒ…ç®¡ç†å“¡å¯åˆªé™¤");
        
        const checkboxes = document.querySelectorAll('.date-checkbox:checked');
        if (checkboxes.length === 0) return alert("è«‹å…ˆå‹¾é¸æ—¥æœŸ");

        if(!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤é¸å–æ—¥æœŸçš„ ${checkboxes.length} å¤©è³‡æ–™å—ï¼Ÿ\nç…§ç‰‡å°‡ç„¡æ³•å¾©åŸï¼`)) return;

        showLoading(true);
        try {
            const selectedDates = Array.from(checkboxes).map(cb => cb.value);
            const targetRecords = currentRecords.filter(r => selectedDates.includes(r.record_date));

            // 1. åˆªé™¤ç…§ç‰‡æª”æ¡ˆ
            const paths = targetRecords.map(r => r.photo_path);
            if (paths.length > 0) {
                await supabase.storage.from('private_photos').remove(paths);
            }

            // 2. åˆªé™¤è³‡æ–™åº«ç´€éŒ„
            const ids = targetRecords.map(r => r.id);
            if (ids.length > 0) {
                await supabase.from('meal_records').delete().in('id', ids);
            }

            alert("åˆªé™¤æˆåŠŸ");
            fetchData(); // é‡æ–°æ•´ç†åˆ—è¡¨
            updateGlobalStats(); // æ›´æ–°å®¹é‡

        } catch(e) {
            alert("åˆªé™¤å¤±æ•—: " + e.message);
        } finally {
            showLoading(false);
        }
    }

    window.viewPhoto = async function(path, cap) {
        showLoading(true);
        const { data } = await supabase.storage.from('private_photos').createSignedUrl(path, 60);
        document.getElementById('modalImg').src = data.signedUrl;
        document.getElementById('caption').innerText = cap;
        document.getElementById('imageModal').style.display = 'flex';
        showLoading(false);
    }

    function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
    function translate(e) { const m={'breakfast':'æ—©','lunch':'åˆ','dinner':'æ™š','patient':'ç—…','nursing':'è­·'}; return m[e]||e; }
    
    window.viewPhoto = viewPhoto;
</script>
</body>
</html>
