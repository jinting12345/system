<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ¥çœ‹ç…§ç‰‡ç´€éŒ„</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- åŸºç¤èˆ‡å¡ç‰‡æ¨£å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        
        .btn-back { background-color: #6c757d; text-decoration: none; padding: 8px 15px; border-radius: 6px; color: white; font-size: 14px; font-weight: bold; display: inline-block; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- é€±å°èˆªæ§åˆ¶å™¨ (æ–°åŠŸèƒ½) --- */
        .week-nav { background: white; padding: 10px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .nav-btn { background: #e3f2fd; color: #007aff; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .nav-btn:active { background: #bbdefb; }
        .date-range { text-align: center; font-weight: bold; color: #333; font-size: 0.95em; }
        .date-range small { display: block; color: #666; font-size: 0.8em; margin-top: 2px; }

        /* --- çµ±è¨ˆè³‡è¨Šæ¢ --- */
        .stats-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-card { flex: 1; background: #fff; padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stat-val { font-size: 1.2em; font-weight: bold; color: #007aff; }
        .stat-label { font-size: 0.8em; color: #666; }

        /* --- å¡ç‰‡å¼åˆ—è¡¨ (æ‰‹æ©Ÿå„ªåŒ–) --- */
        .record-list { display: flex; flex-direction: column; gap: 12px; }
        .day-card { background: white; border-radius: 12px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; }
        
        /* é€±æœ«æ¨£å¼ */
        .day-card.weekend { background-color: #fffbf0; border-color: #fcefdc; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .date-title { font-size: 1.1em; font-weight: bold; color: #007aff; display: flex; align-items: center; gap: 8px; }
        
        .staff-row { display: flex; align-items: center; gap: 5px; font-size: 0.9em; color: #555; }
        .staff-input { border: 1px solid #ddd; background: #f9f9f9; padding: 4px 8px; border-radius: 4px; width: 80px; text-align: center; font-weight: bold; color: #333; }
        .staff-input:focus { border-color: #007aff; background: white; outline: none; }

        /* é¤é»ç¶²æ ¼ */
        .meal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .meal-box { background: #f8f9fa; border-radius: 8px; padding: 8px 4px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .meal-box:active { transform: scale(0.98); background: #eef; }
        .meal-title { font-size: 12px; color: #666; font-weight: bold; }
        
        /* ç‹€æ…‹ç‡ˆè™Ÿ */
        .status-dot { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .ok { background: #e6fffa; color: #00b894; border: 1px solid #b2f5ea; } /* ç¶  */
        .no { background: #fff5f5; color: #fc8181; border: 1px solid #fed7d7; } /* ç´… */

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 900; }
        .fab-btn { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .fab-download { background: #34c759; }
        .fab-reload { background: #007aff; }

        /* åœ–ç‰‡ Modal */
        .modal { display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        .modal img { max-width: 95%; max-height: 85vh; border-radius: 8px; }
        .close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; }
        .modal-caption { position: absolute; bottom: 30px; color: white; text-align: center; width: 100%; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="color:#007aff; font-weight:bold; font-size:1.2em;">è¼‰å…¥ä¸­...</div>
</div>

<div id="imageModal" class="modal" onclick="this.style.display='none'">
    <span class="close-modal">&times;</span>
    <img id="modalImg">
    <div id="caption" class="modal-caption"></div>
</div>

<div class="container">
    <a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

    <div class="week-nav">
        <button class="nav-btn" onclick="changeWeek(-7)">â® ä¸Šé€±</button>
        <div class="date-range">
            <span id="current-range-text">è¼‰å…¥ä¸­...</span>
            <small id="current-week-num"></small>
        </div>
        <button class="nav-btn" onclick="changeWeek(7)">ä¸‹é€± â¯</button>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-val" id="week-count">0</div>
            <div class="stat-label">æœ¬é€±ç…§ç‰‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="total-count">0</div>
            <div class="stat-label">ç¸½ç´¯ç©å¼µæ•¸</div>
        </div>
    </div>

    <div id="record-list" class="record-list"></div>
</div>

<div class="fab-container">
    <button class="fab-btn fab-reload" onclick="fetchData()" title="é‡æ–°æ•´ç†">â†»</button>
    <button class="fab-btn fab-download" onclick="handleDownloadWeek()" title="ä¸‹è¼‰æœ¬é€±">ğŸ“¥</button>
</div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    let supabase = null;
    let currentWeekStart = new Date(); // ç•¶å‰é¸åˆ°çš„é€±çš„èµ·å§‹æ—¥ (é€±æ—¥)
    let currentRecords = [];
    let weekDates = []; // å­˜æœ¬é€±çš„7å¤©æ—¥æœŸå­—ä¸²

    window.onload = function() {
        initDate(); // 1. å…ˆæŠŠæ—¥æœŸå°é½Šåˆ°æœ¬é€±æ—¥
        try {
            supabase = createClient(RAW_URL, RAW_KEY);
            initApp();
        } catch(e) {
            alert("åˆå§‹åŒ–éŒ¯èª¤: " + e.message);
        }
    };

    function initDate() {
        // å°‡æ—¥æœŸè¨­å®šç‚ºã€Œæœ¬é€±æ—¥ã€ä½œç‚ºèµ·é»
        const now = new Date();
        const day = now.getDay(); // 0(é€±æ—¥) - 6(é€±å…­)
        const diff = now.getDate() - day; 
        currentWeekStart = new Date(now.setDate(diff));
        currentWeekStart.setHours(0,0,0,0);
    }

    async function initApp() {
        const { data } = await supabase.auth.getSession();
        if(!data.session) { window.location.href = 'index.html'; return; }
        
        await fetchData();
        updateGlobalStats();
    }

    // åˆ‡æ›é€±æ¬¡ (-7 æˆ– +7)
    window.changeWeek = function(days) {
        currentWeekStart.setDate(currentWeekStart.getDate() + days);
        fetchData();
    }

    window.fetchData = async function() {
        showLoading(true);
        try {
            // 1. è¨ˆç®—æœ¬é€±èµ·è¨–æ—¥
            const startDate = new Date(currentWeekStart);
            const endDate = new Date(currentWeekStart);
            endDate.setDate(startDate.getDate() + 6); // åŠ 6å¤©è®Šé€±å…­

            // æ ¼å¼åŒ– YYYY-MM-DD
            const sStr = startDate.toISOString().split('T')[0];
            const eStr = endDate.toISOString().split('T')[0];

            // æ›´æ–° UI é¡¯ç¤ºæ—¥æœŸç¯„åœ
            document.getElementById('current-range-text').innerText = 
                `${startDate.getMonth()+1}/${startDate.getDate()} - ${endDate.getMonth()+1}/${endDate.getDate()}`;
            document.getElementById('current-week-num').innerText = `${startDate.getFullYear()}å¹´`;

            // 2. æŠ“å–é€™7å¤©çš„è³‡æ–™
            const { data: scheduleData } = await supabase.from('duty_roster')
                .select('date, staff_name')
                .gte('date', sStr).lte('date', eStr);

            const { data: recordData } = await supabase.from('meal_records')
                .select('*')
                .gte('record_date', sStr).lte('record_date', eStr);

            currentRecords = recordData || [];
            
            // 3. æ¸²æŸ“ç•«é¢
            renderWeek(startDate, scheduleData || [], currentRecords);
            
            // æ›´æ–°æœ¬é€±çµ±è¨ˆ
            document.getElementById('week-count').innerText = currentRecords.length;

        } catch(e) {
            console.error(e);
            alert("è®€å–å¤±æ•—");
        } finally {
            showLoading(false);
        }
    }

    function renderWeek(startObj, schedules, records) {
        const container = document.getElementById('record-list');
        container.innerHTML = '';
        weekDates = []; // é‡ç½®

        const weekStr = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

        for(let i=0; i<7; i++) {
            // ç”¢ç”Ÿæ¯ä¸€å¤©çš„æ—¥æœŸç‰©ä»¶
            let d = new Date(startObj);
            d.setDate(d.getDate() + i);
            const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
            weekDates.push(dateStr);

            const isWeekend = (i === 0 || i === 6);
            const dayLabel = `${d.getMonth()+1}/${d.getDate()} (${weekStr[i]})`;
            
            // æ‰¾å€¼ç­äººå“¡
            const staff = schedules.find(s => s.date === dateStr)?.staff_name || '';
            
            // æ‰¾ç…§ç‰‡ç´€éŒ„
            const dayRecs = records.filter(r => r.record_date === dateStr);

            // ç”¢ç”Ÿ HTML
            const card = document.createElement('div');
            card.className = `day-card ${isWeekend ? 'weekend' : ''}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="date-title">${dayLabel}</div>
                    <div class="staff-row">
                        å€¼ç­: <input type="text" class="staff-input" value="${staff}" 
                        onchange="updateStaff('${dateStr}', this.value)" placeholder="æœªæ’ç­">
                    </div>
                </div>
                
                <div class="meal-grid">
                    ${renderMealBox(dayRecs, dateStr, 'breakfast', 'patient', 'æ—©-ç—…')}
                    ${renderMealBox(dayRecs, dateStr, 'breakfast', 'nursing', 'æ—©-è­·')}
                    ${renderMealBox(dayRecs, dateStr, 'lunch', 'patient', 'åˆ-ç—…')}
                    ${renderMealBox(dayRecs, dateStr, 'dinner', 'patient', 'æ™š-ç—…')}
                </div>
            `;
            container.appendChild(card);
        }
    }

    function renderMealBox(dayRecs, dateStr, meal, target, label) {
        const rec = dayRecs.find(r => r.meal_type === meal && r.target_type === target);
        const hasPhoto = !!rec;
        const iconClass = hasPhoto ? 'ok' : 'no';
        const iconText = hasPhoto ? 'âœ”' : 'âœ–';
        const action = hasPhoto ? `onclick="window.viewPhoto('${rec.photo_path}', '${dateStr} ${label}')"` : '';

        return `
            <div class="meal-box" ${action}>
                <div class="status-dot ${iconClass}">${iconText}</div>
                <div class="meal-title">${label}</div>
            </div>
        `;
    }

    async function updateGlobalStats() {
        // åªç®—ç¸½æ•¸ï¼Œè®“ä½¿ç”¨è€…æœ‰å€‹åº•
        const { count } = await supabase.from('meal_records').select('*', { count: 'exact', head: true });
        document.getElementById('total-count').innerText = count || 0;
    }

    window.updateStaff = async function(date, val) {
        val = val.trim();
        const { data } = await supabase.from('duty_roster').select('*').eq('date', date);
        if(data.length > 0) {
            if(val) await supabase.from('duty_roster').update({staff_name: val}).eq('date', date);
            else await supabase.from('duty_roster').delete().eq('date', date);
        } else if(val) {
            await supabase.from('duty_roster').insert([{date: date, staff_name: val, shift: 'BN'}]);
        }
    }

    window.handleDownloadWeek = async function() {
        if(currentRecords.length === 0) return alert("æœ¬é€±æ²’æœ‰ç…§ç‰‡å¯ä¸‹è¼‰");
        
        showLoading(true);
        const zip = new JSZip();
        
        await Promise.all(currentRecords.map(async r => {
            const { data } = await supabase.storage.from('private_photos').download(r.photo_path);
            if(data) {
                // æª”åï¼šæ—¥æœŸ_é¤åˆ¥_å°è±¡.jpg
                const fname = `${r.record_date}_${translate(r.meal_type)}_${translate(r.target_type)}.jpg`;
                zip.file(fname, data);
            }
        }));
        
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, `ç…§ç‰‡å‚™ä»½_${weekDates[0]}_to_${weekDates[6]}.zip`);
        showLoading(false);
    }

    window.viewPhoto = async function(path, cap) {
        showLoading(true);
        const { data } = await supabase.storage.from('private_photos').createSignedUrl(path, 60);
        document.getElementById('modalImg').src = data.signedUrl;
        document.getElementById('caption').innerText = cap;
        document.getElementById('imageModal').style.display = 'flex';
        showLoading(false);
    }

    function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
    function translate(e) { const m={'breakfast':'æ—©','lunch':'åˆ','dinner':'æ™š','patient':'ç—…','nursing':'è­·'}; return m[e]||e; }
    
    // æ›è¼‰å…¨åŸŸè®“ HTML onclick ä½¿ç”¨
    window.viewPhoto = viewPhoto;
</script>
</body>
</html>
