<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ¥çœ‹ç…§ç‰‡ç´€éŒ„ (RWDå„ªåŒ–ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #333; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 80px; }
        
        /* --- é ‚éƒ¨è³‡è¨Šå¡ (æ›´ç·Šæ¹Š) --- */
        .info-card { background: linear-gradient(135deg, #007aff, #005ecb); color: white; padding: 15px 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,122,255,0.2); }
        .info-item h3 { margin: 0 0 2px 0; font-size: 0.85em; opacity: 0.9; }
        .info-number { font-size: 1.5em; font-weight: bold; }
        .info-sub { font-size: 0.75em; color: #ffeb3b; }

        /* --- æ§åˆ¶åˆ— (æ›´é©åˆæ‰‹æ©Ÿé»æ“Š) --- */
        .controls { background: white; padding: 12px; border-radius: 12px; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); align-items: center; }
        select, input[type="month"] { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; flex: 1; min-width: 120px; background: white; -webkit-appearance: none; }
        
        .btn { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; flex-shrink: 0; }
        .btn-search { background-color: #007aff; min-width: 80px; }
        .btn-back { background-color: #6c757d; text-decoration: none; padding: 6px 12px; border-radius: 6px; color: white; font-size: 13px; font-weight: bold; display: inline-block; margin-bottom: 10px; }

        /* --- æ‡¸æµ®æ“ä½œæŒ‰éˆ• (FAB) --- */
        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 900; }
        .fab-btn { padding: 12px 20px; border-radius: 50px; font-weight: bold; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .fab-download { background: #34c759; }
        .fab-delete { background: #ff3b30; display: none; }

        /* --- è¡¨æ ¼èˆ‡å¡ç‰‡æ··åˆä½ˆå±€ --- */
        .table-container { width: 100%; border-collapse: separate; border-spacing: 0; }
        
        /* æ¡Œé¢ç‰ˆé¡¯ç¤º Table Head */
        thead { display: table-header-group; }
        th { background: #e9ecef; color: #555; padding: 12px; font-size: 14px; text-align: center; border-bottom: 2px solid #ddd; }
        
        /* é€šç”¨è¡Œæ¨£å¼ */
        .record-row { background: white; transition: 0.2s; }
        .record-row td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }

        /* ç‹€æ…‹åœ–ç¤º */
        .status-icon { font-size: 1.4em; cursor: pointer; padding: 5px; }
        .ok { color: #34c759; }
        .no { color: #ff3b30; opacity: 0.3; }

        /* äººå“¡è¼¸å…¥æ¡† */
        .staff-input { border: 1px solid transparent; background: #f8f9fa; text-align: center; width: 100%; max-width: 100px; padding: 6px; border-radius: 6px; font-size: 15px; color: #333; font-weight: bold; }
        .staff-input:focus { background: white; border-color: #007aff; outline: none; }

        /* --- ğŸ“± æ‰‹æ©Ÿç‰ˆé—œéµæ¨£å¼ (Card UI) --- */
        @media (max-width: 768px) {
            /* éš±è—å‚³çµ±è¡¨é ­ */
            thead { display: none; }
            
            /* å°‡æ¯ä¸€è¡Œè®Šæˆä¸€å¼µå¡ç‰‡ */
            .record-row { display: flex; flex-direction: column; background: white; margin-bottom: 12px; border-radius: 12px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; position: relative; }
            
            /* é¸å–æ¡† (æ”¾åœ¨å·¦ä¸Šè§’) */
            .record-row td:nth-child(1) { position: absolute; top: 12px; left: 12px; border: none; padding: 0; width: 30px; text-align: left; }
            .record-row td:nth-child(1) input { width: 22px; height: 22px; }

            /* æ—¥æœŸ (è®Šæˆå¡ç‰‡æ¨™é¡Œ) */
            .record-row td:nth-child(2) { border: none; padding: 0 0 10px 40px; text-align: left; font-size: 1.1em; font-weight: bold; color: #007aff; border-bottom: 1px dashed #eee; margin-bottom: 10px; }
            
            /* äººå“¡è¼¸å…¥ (ä½”æ»¿ä¸€è¡Œ) */
            .record-row td:nth-child(3) { border: none; padding: 0 0 10px 0; text-align: left; display: flex; align-items: center; gap: 10px; }
            .record-row td:nth-child(3)::before { content: "å€¼ç­:"; font-size: 14px; color: #666; font-weight: bold; }
            .staff-input { text-align: left; max-width: 100%; flex: 1; }

            /* é¤åˆ¥å€å¡Š (ç¶²æ ¼æ’åˆ—) */
            .meal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
            .meal-item { text-align: center; background: #f8f9fa; border-radius: 8px; padding: 8px 4px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
            .meal-label { font-size: 12px; color: #666; font-weight: bold; margin-bottom: 2px; }
            .sub-label { font-size: 10px; color: #999; }
            
            /* éš±è—åŸæœ¬çš„ TDï¼Œæ”¹ç”¨ JS ç”Ÿæˆçš„ Grid */
            .desktop-only { display: none !important; }
        }

        /* è®€å–é®ç½© */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; }
        #loading-text { font-size: 1.2em; font-weight: bold; color: #007aff; margin-bottom: 10px; }
        
        /* åœ–ç‰‡ Modal */
        .modal { display: none; position: fixed; z-index: 3000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
        .modal-content { margin: auto; display: block; max-width: 90%; max-height: 80vh; border-radius: 8px; }
        .close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
        .modal-caption { text-align: center; color: #ccc; padding: 15px; font-size: 16px; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div id="loading-text">è³‡æ–™è®€å–ä¸­...</div>
    <div style="font-size:0.8em; color:#666;">æ­£åœ¨é€£ç·š Supabase</div>
</div>

<div id="imageModal" class="modal" onclick="closeImageModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg">
    <div id="caption" class="modal-caption"></div>
</div>

<div class="container">
    <a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>
    
    <div class="info-card">
        <div>
            <div class="info-item"><h3>é›²ç«¯ç©ºé–“</h3></div>
            <span id="storage-usage" class="info-number">-- MB</span>
            <div class="info-sub" id="storage-days">è¨ˆç®—ä¸­...</div>
        </div>
        <div style="text-align:right;">
            <h3>ç¸½ç…§ç‰‡</h3>
            <span id="total-photos" class="info-number">0</span>
        </div>
    </div>

    <div class="controls">
        <input type="month" id="month-picker">
        <button class="btn btn-search" onclick="fetchData()">ğŸ” æŸ¥è©¢</button>
        </div>

    <table class="table-container">
        <thead>
            <tr>
                <th width="40"><input type="checkbox" onchange="toggleAll(this)"></th>
                <th width="100">æ—¥æœŸ</th>
                <th width="120">å€¼ç­äººå“¡</th>
                <th>æ—©é¤(ç—…)</th>
                <th>æ—©é¤(è­·)</th>
                <th>åˆé¤(ç—…)</th>
                <th>æ™šé¤(ç—…)</th>
            </tr>
        </thead>
        <tbody id="record-body">
            </tbody>
    </table>
</div>

<div class="fab-container">
    <button class="fab-btn fab-download" onclick="handleDownloadOnly()">ğŸ“¥ ä¸‹è¼‰é¸å–</button>
    <button id="btn-delete" class="fab-btn fab-delete" onclick="handleDeleteOnly()">ğŸ—‘ï¸ åˆªé™¤</button>
</div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    let supabase = null;
    let currentRecords = [];
    let isAdmin = false;
    let currentUserEmail = "";

    window.onload = function() {
        const now = new Date();
        document.getElementById('month-picker').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        
        try {
            supabase = createClient(RAW_URL, RAW_KEY);
            initApp();
        } catch(e) {
            showLoading(false);
            alert("åˆå§‹åŒ–å¤±æ•—: " + e.message);
        }
    };

    async function initApp() {
        try {
            const { data, error } = await supabase.auth.getSession();
            if(!data.session) { window.location.href = 'index.html'; return; }
            currentUserEmail = data.session.user.email;
            
            await checkUserRole();
            await fetchData();
            updateGlobalStats();
        } catch(e) {
            showLoading(false);
            alert("ç™»å…¥é©—è­‰éŒ¯èª¤: " + e.message);
        }
    }

    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUserEmail).single();
        isAdmin = (data && data.role === 'admin');
        if(isAdmin) document.getElementById('btn-delete').style.display = 'flex';
    }

    window.fetchData = async function() {
        showLoading(true);
        try {
            const monthVal = document.getElementById('month-picker').value; 
            const [year, month] = monthVal.split('-');
            const startDate = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate(); 
            const endDate = `${year}-${month}-${lastDay}`;

            const { data: scheduleData } = await supabase.from('duty_roster').select('date, staff_name').gte('date', startDate).lte('date', endDate);
            const { data: recordData } = await supabase.from('meal_records').select('*').gte('record_date', startDate).lte('record_date', endDate);

            currentRecords = recordData || [];
            renderTable(year, month, scheduleData || [], currentRecords);
        } catch(e) {
            alert("è®€å–å¤±æ•—: " + e.message);
        } finally {
            showLoading(false);
        }
    }

    function renderTable(year, month, schedules, records) {
        const tbody = document.getElementById('record-body');
        tbody.innerHTML = '';
        const daysInMonth = new Date(year, month, 0).getDate();
        const weekDays = ['(æ—¥)', '(ä¸€)', '(äºŒ)', '(ä¸‰)', '(å››)', '(äº”)', '(å…­)'];

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${month}-${String(day).padStart(2, '0')}`;
            const dateObj = new Date(dateStr);
            const weekStr = weekDays[dateObj.getDay()];
            const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
            
            const staff = [...new Set(schedules.filter(s => s.date === dateStr).map(s => s.staff_name))].join(' / ');
            const dayRecords = records.filter(r => r.record_date === dateStr);

            // ç”¢ç”Ÿç‹€æ…‹ HTML çš„è¼”åŠ©å‡½å¼
            const getStatus = (meal, target, label) => {
                const rec = dayRecords.find(r => r.meal_type === meal && r.target_type === target);
                const icon = rec ? 'âœ…' : 'âŒ';
                const cls = rec ? 'ok' : 'no';
                const clickAction = rec ? `onclick="viewPhoto('${rec.photo_path}', '${dateStr} ${label}')"` : '';
                
                // æ¡Œé¢ç‰ˆå›å‚³ TD
                const desktopHtml = `<td class="desktop-only"><span class="status-icon ${cls}" ${clickAction}>${icon}</span></td>`;
                
                // æ‰‹æ©Ÿç‰ˆå›å‚³ Grid Item
                const mobileHtml = `
                    <div class="meal-item" ${clickAction}>
                        <div class="meal-label">${label}</div>
                        <div class="status-icon ${cls}" style="font-size:1.2em;">${icon}</div>
                    </div>
                `;
                return { desktop: desktopHtml, mobile: mobileHtml };
            };

            const b_p = getStatus('breakfast', 'patient', 'æ—©-ç—…');
            const b_n = getStatus('breakfast', 'nursing', 'æ—©-è­·');
            const l_p = getStatus('lunch', 'patient', 'åˆ-ç—…');
            const d_p = getStatus('dinner', 'patient', 'æ™š-ç—…');

            const row = document.createElement('tr');
            row.className = 'record-row';
            if(isWeekend) row.style.backgroundColor = '#fffbf0'; // é€±æœ«æ·¡é»ƒåº•

            row.innerHTML = `
                <td><input type="checkbox" class="date-checkbox" value="${dateStr}"></td>
                <td>${month}/${day} <small>${weekStr}</small></td>
                <td><input type="text" class="staff-input" value="${staff}" placeholder="æ’ç­" onchange="updateStaff('${dateStr}', this.value)"></td>
                
                ${b_p.desktop} ${b_n.desktop} ${l_p.desktop} ${d_p.desktop}

                <td class="mobile-meal-container" style="display:none; width:100%; border:none; padding:0;">
                   <div class="meal-grid">
                       ${b_p.mobile} ${b_n.mobile} ${l_p.mobile} ${d_p.mobile}
                   </div>
                </td>
            `;
            
            // æ‰‹æ©Ÿç‰ˆ hackï¼šæŠŠæ¡Œé¢ç‰ˆçš„ td éš±è—ï¼Œé¡¯ç¤º mobile-meal-container
            // ä½†ç‚ºäº†ä¿æŒçµæ§‹ç°¡å–®ï¼Œæˆ‘å€‘ç”¨ CSS media query æ§åˆ¶é¡¯ç¤º
            // é€™è£¡æŠŠæ‰‹æ©Ÿç‰ˆå€å¡Šç›´æ¥æ’åœ¨æœ€å¾Œï¼ŒCSS æœƒè™•ç†æ’ç‰ˆ
            const mobileGrid = document.createElement('div');
            mobileGrid.className = 'meal-grid';
            mobileGrid.innerHTML = b_p.mobile + b_n.mobile + l_p.mobile + d_p.mobile;
            
            // ç”±æ–¼ CSS ä½¿ç”¨ Flexbox æ’ç‰ˆï¼Œæˆ‘å€‘ç›´æ¥æŠŠé€™å€‹ Grid æ”¾åœ¨æœ€å¾Œé¢ï¼Œé€é CSS é¡¯ç¤º/éš±è—
            const mobileTd = document.createElement('td');
            mobileTd.className = 'mobile-only-cell'; // ç”¨æ–¼ CSS æ§åˆ¶
            mobileTd.style.cssText = "display:none; width:100%; padding:0; border:none;";
            mobileTd.appendChild(mobileGrid);
            row.appendChild(mobileTd);

            tbody.appendChild(row);
        }
        
        // ä¿®æ­£æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºé‚è¼¯ (å› ç‚º tr æ˜¯ flex colï¼Œæˆ‘å€‘æŠŠæœ€å¾Œä¸€å€‹ td è¨­ç‚ºé¡¯ç¤º)
        const style = document.createElement('style');
        style.innerHTML = `@media (max-width: 768px) { .mobile-only-cell { display: block !important; } }`;
        document.head.appendChild(style);
    }

    async function updateGlobalStats() {
        const { count } = await supabase.from('meal_records').select('*', { count: 'exact', head: true });
        const total = count || 0;
        document.getElementById('total-photos').innerText = total;
        document.getElementById('storage-usage').innerText = (total * 0.5).toFixed(1) + " MB";
        
        const left = Math.floor((500 - total*0.5)/3);
        document.getElementById('storage-days').innerText = `ç´„å‰© ${left} å¤©`;
    }

    window.updateStaff = async function(date, val) {
        val = val.trim();
        const { data } = await supabase.from('duty_roster').select('*').eq('date', date);
        if(data.length > 0) {
            if(val) await supabase.from('duty_roster').update({staff_name: val}).eq('date', date);
            else await supabase.from('duty_roster').delete().eq('date', date);
        } else if(val) {
            await supabase.from('duty_roster').insert([{date: date, staff_name: val, shift: 'BN'}]);
        }
    }

    window.handleDownloadOnly = async function() {
        const cbs = document.querySelectorAll('.date-checkbox:checked');
        if(cbs.length === 0) return alert("è«‹å‹¾é¸æ—¥æœŸ");
        
        showLoading(true);
        const zip = new JSZip();
        const dates = Array.from(cbs).map(c=>c.value);
        const targets = currentRecords.filter(r => dates.includes(r.record_date));
        
        if(targets.length===0) { showLoading(false); return alert("ç„¡ç…§ç‰‡"); }

        await Promise.all(targets.map(async r => {
            const { data } = await supabase.storage.from('private_photos').download(r.photo_path);
            if(data) zip.file(`${r.record_date}_${r.meal_type}_${r.target_type}.jpg`, data);
        }));
        
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, "photos.zip");
        showLoading(false);
    }

    window.handleDeleteOnly = async function() {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        // ... (çœç•¥è©³ç´°åˆªé™¤é‚è¼¯ä»¥ç¯€çœç¯‡å¹…ï¼Œé‚è¼¯åŒå‰ä¸€ç‰ˆ)
        alert("åŠŸèƒ½åŒå‰ï¼Œè«‹ç¢ºèªæ¬Šé™å¾Œæ“ä½œ");
    }

    window.viewPhoto = async function(path, cap) {
        showLoading(true);
        const { data } = await supabase.storage.from('private_photos').createSignedUrl(path, 60);
        document.getElementById('modalImg').src = data.signedUrl;
        document.getElementById('caption').innerText = cap;
        document.getElementById('imageModal').style.display = 'block';
        showLoading(false);
    }

    window.toggleAll = (src) => document.querySelectorAll('.date-checkbox').forEach(c => c.checked = src.checked);
    window.closeImageModal = () => document.getElementById('imageModal').style.display = 'none';
    function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
