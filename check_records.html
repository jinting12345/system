<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŸ¥çœ‹ç…§ç‰‡ç´€éŒ„ (æœ€çµ‚ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: #f2f4f8; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 80px; }
        
        .btn-back { background-color: #6c757d; text-decoration: none; padding: 8px 15px; border-radius: 6px; color: white; font-size: 14px; font-weight: bold; display: inline-flex; align-items: center; margin-bottom: 15px; }

        /* --- è³‡è¨Šåˆ— (å·²æ›´æ–°é¡¯ç¤ºå¯¬åº¦) --- */
        .info-bar { 
            background: white; padding: 12px 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #007aff;
        }
        .info-group { display: flex; flex-direction: column; } /* æ‰‹æ©Ÿç‰ˆè‹¥å¤ªæ“ å¯æ›è¡Œï¼Œç›®å‰ä¿æŒå–®è¡Œ */
        .info-label { color: #666; margin-right: 5px; font-size: 13px; }
        .info-val { font-weight: bold; color: #333; font-size: 15px; }
        .info-alert { color: #f59e0b; font-weight:bold; margin-left: 5px; font-size: 13px; }

        /* =========================================
           ğŸ–¥ï¸ é›»è…¦ç‰ˆæ¨£å¼ (è¡¨æ ¼æ¨¡å¼)
           ========================================= */
        .desktop-controls { background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .desktop-controls select, .desktop-controls input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        .btn-search { background: #007aff; color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .table-wrapper { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: bold; }
        tr:hover { background-color: #f1f7ff; }
        .status-icon { font-size: 1.2em; cursor: pointer; }
        .ok { color: #28a745; }
        .no { color: #dc3545; opacity: 0.2; }
        .weekend-row { background-color: #fffbf0; }

        .staff-input-desk { border: 1px solid transparent; background: transparent; text-align: center; width: 100%; font-size: 14px; font-weight: bold; padding: 5px; border-radius: 4px; }
        .staff-input-desk:hover { border: 1px solid #ccc; background: white; }
        .staff-input-desk:focus { border: 1px solid #007aff; background: white; outline: none; }

        /* =========================================
           ğŸ“± æ‰‹æ©Ÿç‰ˆæ¨£å¼ (å¡ç‰‡æ¨¡å¼)
           ========================================= */
        .mobile-only { display: none; } 

        .week-nav { background: white; padding: 5px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-btn { background: #f0f2f5; color: #007aff; border: none; width: 45px; height: 45px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .date-picker-wrapper { position: relative; flex: 1; text-align: center; height: 45px; display: flex; flex-direction: column; justify-content: center; }
        .hidden-date-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
        .date-range { font-weight: bold; color: #333; font-size: 1.1em; }
        .date-range small { display: inline-block; color: #007aff; font-size: 0.8em; margin-left: 5px; font-weight: normal; }

        .day-card { background: white; border-radius: 12px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; margin-bottom: 12px; }
        .day-card.weekend { background-color: #fffbf0; border-color: #faeacc; }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .date-title { font-size: 1.1em; font-weight: bold; color: #007aff; display: flex; align-items: center; gap: 8px; }
        .date-checkbox { width: 20px; height: 20px; accent-color: #007aff; }
        
        .staff-row { display: flex; align-items: center; gap: 5px; font-size: 0.9em; color: #555; }
        .staff-input-mobile { border: 1px solid #ddd; background: #f9f9f9; padding: 4px 8px; border-radius: 4px; width: 80px; text-align: center; font-weight: bold; color: #333; }

        .meal-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .meal-box { background: #f8f9fa; border-radius: 8px; padding: 8px 4px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .meal-box:active { background: #eef; }
        .meal-title { font-size: 11px; color: #666; }
        .status-dot { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .dot-ok { background: #e6fffa; color: #00b894; border: 1px solid #b2f5ea; }
        .dot-no { background: #fff5f5; color: #fc8181; border: 1px solid #fed7d7; }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab-container { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 900; }
        .fab-btn { width: 56px; height: 56px; border-radius: 50%; border: none; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .fab-btn:active { transform: scale(0.9); }
        .fab-download { background: #28a745; }
        .fab-delete { background: #dc3545; display: none; }
        .fab-reload { background: #007aff; }

        .select-all-btn { position: fixed; bottom: 35px; left: 20px; background: white; color: #333; padding: 10px 20px; border-radius: 30px; font-size: 14px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; border: 1px solid #ddd; z-index: 900; display: none;}

        @media (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-only { display: block !important; }
            .container { padding: 10px; }
            .select-all-btn { display: block; }
            
            /* æ‰‹æ©Ÿç‰ˆè³‡è¨Šåˆ—ç¨å¾®èª¿æ•´ */
            .info-bar { flex-direction: row; font-size: 12px; padding: 10px 15px; }
            .info-val { font-size: 13px; }
        }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 3000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        .modal img { max-width: 95%; max-height: 85vh; border-radius: 8px; }
        .close-modal { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; }
        .modal-caption { position: absolute; bottom: 30px; color: white; text-align: center; width: 100%; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="color:#007aff; font-weight:bold; font-size:1.2em;">è¼‰å…¥ä¸­...</div>
</div>

<div id="imageModal" class="modal" onclick="this.style.display='none'">
    <span class="close-modal">&times;</span>
    <img id="modalImg">
    <div id="caption" class="modal-caption"></div>
</div>

<div class="container">
    <a href="menu.html" class="btn-back">â¬… å›é¸å–®</a>

    <div class="info-bar">
        <div>
            <span class="info-label">ç´¯ç©ç…§ç‰‡:</span>
            <span class="info-val" id="total-count">0</span>
        </div>
        <div>
            <span class="info-label">ç©ºé–“:</span>
            <span class="info-val" id="storage-usage">... / 500 MB</span>
            <span class="info-alert" id="storage-days"></span>
        </div>
    </div>

    <div class="desktop-only">
        <div class="desktop-controls">
            <input type="month" id="month-picker">
            <button class="btn-search" onclick="fetchMonthData()">ğŸ” æŸ¥è©¢æ•´æœˆ</button>
        </div>
        
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="50">é¸</th>
                        <th width="120">æ—¥æœŸ</th>
                        <th width="150">å€¼ç­äººå“¡</th>
                        <th>æ—©é¤(ç—…)</th>
                        <th>æ—©é¤(è­·)</th>
                        <th>åˆé¤(ç—…)</th>
                        <th>æ™šé¤(ç—…)</th>
                    </tr>
                </thead>
                <tbody id="desktop-tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="mobile-only">
        <div class="week-nav">
            <button class="nav-btn" onclick="changeWeek(-7)">â®</button>
            <div class="date-picker-wrapper">
                <input type="date" class="hidden-date-input" onchange="jumpToDate(this.value)">
                <div class="date-range">
                    <span id="mobile-range-text">--/-- - --/--</span>
                    <small id="mobile-week-num">ğŸ“… æœå°‹</small>
                </div>
            </div>
            <button class="nav-btn" onclick="changeWeek(7)">â¯</button>
        </div>
        <div id="mobile-list"></div>
        <button class="select-all-btn" onclick="toggleSelectAllMobile()">â˜‘ å…¨é¸æœ¬é€±</button>
    </div>

</div>

<div class="fab-container">
    <button class="fab-btn fab-reload" onclick="reloadData()" title="é‡æ–°æ•´ç†">â†»</button>
    <button class="fab-btn fab-download" onclick="handleDownload()" title="ä¸‹è¼‰é¸å–">ğŸ“¥</button>
    <button id="btn-delete" class="fab-btn fab-delete" onclick="handleDelete()" title="åˆªé™¤é¸å–">ğŸ—‘ï¸</button>
</div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const RAW_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    let supabase = null;
    
    // ç‹€æ…‹
    let currentMode = 'desktop'; 
    let currentWeekStart = new Date(); 
    let currentMonthStr = ''; 
    
    let currentRecords = [];
    let isAdmin = false;
    let currentUserEmail = "";

    // æœ¬åœ°æ™‚é–“æ ¼å¼åŒ– (è§£æ±ºæ™‚å€å•é¡Œ)
    function getLocalStr(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${dd}`;
    }

    window.onload = function() {
        if (window.innerWidth <= 768) {
            currentMode = 'mobile';
            initWeekDate(); 
        } else {
            currentMode = 'desktop';
            const now = new Date();
            currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('month-picker').value = currentMonthStr;
        }

        try {
            supabase = createClient(RAW_URL, RAW_KEY);
            initApp();
        } catch(e) {
            alert("åˆå§‹åŒ–éŒ¯èª¤: " + e.message);
        }
    };

    function initWeekDate() {
        const now = new Date();
        const day = now.getDay(); 
        const diff = now.getDate() - day; 
        currentWeekStart = new Date(now.setDate(diff));
        currentWeekStart.setHours(0,0,0,0);
    }

    async function initApp() {
        const { data } = await supabase.auth.getSession();
        if(!data.session) { window.location.href = 'index.html'; return; }
        currentUserEmail = data.session.user.email;
        await checkUserRole();
        
        if(currentMode === 'mobile') await fetchWeekData();
        else await fetchMonthData();
        
        updateGlobalStats();
    }

    async function checkUserRole() {
        const { data } = await supabase.from('user_roles').select('role').eq('email', currentUserEmail).single();
        isAdmin = (data && data.role === 'admin');
        const delBtn = document.getElementById('btn-delete');
        if(isAdmin) delBtn.style.display = 'flex';
    }

    // ================= æ‰‹æ©Ÿç‰ˆ (é€±) =================
    window.changeWeek = function(days) {
        currentWeekStart.setDate(currentWeekStart.getDate() + days);
        fetchWeekData();
    }

    window.jumpToDate = function(val) {
        if(!val) return;
        const target = new Date(val);
        const day = target.getDay(); 
        currentWeekStart = new Date(target.setDate(target.getDate() - day));
        currentWeekStart.setHours(0,0,0,0);
        fetchWeekData();
    }

    async function fetchWeekData() {
        showLoading(true);
        try {
            const start = new Date(currentWeekStart);
            const end = new Date(currentWeekStart);
            end.setDate(start.getDate() + 6);

            const sStr = getLocalStr(start);
            const eStr = getLocalStr(end);

            document.getElementById('mobile-range-text').innerText = `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;
            document.getElementById('mobile-week-num').innerText = `(${start.getFullYear()} ğŸ“…)`;

            await loadData(sStr, eStr);
            renderMobile(start);
        } catch(e) { alert("è®€å–å¤±æ•—"); } 
        finally { showLoading(false); }
    }

    function renderMobile(startObj) {
        const container = document.getElementById('mobile-list');
        container.innerHTML = '';
        const weekStr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

        for(let i=0; i<7; i++) {
            let d = new Date(startObj);
            d.setDate(d.getDate() + i);
            const dateStr = getLocalStr(d);
            
            const staff = currentRecords.schedules.find(s=>s.date===dateStr)?.staff_name || '';
            const dayRecs = currentRecords.records.filter(r=>r.record_date===dateStr);
            const isWeekend = (i===0 || i===6);
            
            const card = document.createElement('div');
            card.className = `day-card ${isWeekend ? 'weekend' : ''}`;
            card.innerHTML = `
                <div class="card-header">
                    <div class="date-title">
                        <input type="checkbox" class="date-checkbox" value="${dateStr}">
                        ${d.getMonth()+1}/${d.getDate()} (${weekStr[i]})
                    </div>
                    <div class="staff-row">
                        å€¼ç­ <input type="text" class="staff-input-mobile" value="${staff}" onchange="updateStaff('${dateStr}', this.value)">
                    </div>
                </div>
                <div class="meal-grid">
                    ${renderMealBox(dayRecs, dateStr, 'breakfast', 'patient', 'æ—©-ç—…')}
                    ${renderMealBox(dayRecs, dateStr, 'breakfast', 'nursing', 'æ—©-è­·')}
                    ${renderMealBox(dayRecs, dateStr, 'lunch', 'patient', 'åˆé¤')}
                    ${renderMealBox(dayRecs, dateStr, 'dinner', 'patient', 'æ™šé¤')}
                </div>
            `;
            container.appendChild(card);
        }
    }

    function renderMealBox(dayRecs, dateStr, meal, target, label) {
        const rec = dayRecs.find(r => r.meal_type === meal && r.target_type === target);
        const has = !!rec;
        const cls = has ? 'dot-ok' : 'dot-no';
        const txt = has ? 'âœ”' : 'âœ–';
        const act = has ? `onclick="window.viewPhoto('${rec.photo_path}', '${dateStr} ${label}')"` : '';
        return `<div class="meal-box" ${act}><div class="status-dot ${cls}">${txt}</div><div class="meal-title">${label}</div></div>`;
    }

    // ================= é›»è…¦ç‰ˆ (æœˆ) =================
    window.fetchMonthData = async function() {
        const val = document.getElementById('month-picker').value;
        if(!val) return;
        showLoading(true);
        
        const [y, m] = val.split('-');
        const startDate = `${val}-01`;
        const lastDay = new Date(y, m, 0).getDate();
        const endDate = `${val}-${lastDay}`;

        await loadData(startDate, endDate);
        renderDesktop(y, m, lastDay);
        showLoading(false);
    }

    function renderDesktop(year, month, daysInMonth) {
        const tbody = document.getElementById('desktop-tbody');
        tbody.innerHTML = '';
        const weekStr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${month}-${String(d).padStart(2,'0')}`;
            const dateObj = new Date(dateStr);
            const w = weekStr[dateObj.getDay()];
            const isWeekend = (dateObj.getDay()===0 || dateObj.getDay()===6);

            const staff = [...new Set(currentRecords.schedules.filter(s=>s.date===dateStr).map(s=>s.staff_name))].join('/');
            const dayRecs = currentRecords.records.filter(r=>r.record_date===dateStr);

            const getTd = (m, t, lbl) => {
                const rec = dayRecs.find(r=>r.meal_type===m && r.target_type===t);
                if(rec) return `<td><span class="status-icon ok" onclick="viewPhoto('${rec.photo_path}','${dateStr} ${lbl}')">âœ…</span></td>`;
                else return `<td><span class="status-icon no">âŒ</span></td>`;
            };

            const tr = document.createElement('tr');
            if(isWeekend) tr.className = 'weekend-row';
            tr.innerHTML = `
                <td><input type="checkbox" class="date-checkbox" value="${dateStr}"></td>
                <td>${month}/${d} (${w})</td>
                <td><input type="text" class="staff-input-desk" value="${staff}" onchange="updateStaff('${dateStr}',this.value)"></td>
                ${getTd('breakfast','patient','æ—©-ç—…')}
                ${getTd('breakfast','nursing','æ—©-è­·')}
                ${getTd('lunch','patient','åˆ-ç—…')}
                ${getTd('dinner','patient','æ™š-ç—…')}
            `;
            tbody.appendChild(tr);
        }
    }

    // ================= å…±ç”¨æ ¸å¿ƒ =================
    async function loadData(start, end) {
        const { data: sData } = await supabase.from('duty_roster').select('date, staff_name').gte('date', start).lte('date', end);
        const { data: rData } = await supabase.from('meal_records').select('*').gte('record_date', start).lte('record_date', end);
        currentRecords = { schedules: sData||[], records: rData||[] };
        document.getElementById('total-count').innerText = (rData||[]).length + " (æœ¬å€é–“)";
    }

    // ğŸ”¥ ä¿®æ”¹ï¼šé¡¯ç¤ºæ ¼å¼ update
    async function updateGlobalStats() {
        const { count } = await supabase.from('meal_records').select('*', { count: 'exact', head: true });
        const total = count || 0;
        const usedMB = (total * 0.5).toFixed(1);
        
        // ä¿®æ”¹é€™è£¡ï¼šåŠ ä¸Š "/ 500 MB"
        document.getElementById('storage-usage').innerText = `${usedMB} MB / 500 MB`;
        
        const left = Math.floor((500 - total*0.5)/3);
        const alertEl = document.getElementById('storage-days');
        alertEl.innerText = `(å‰©ç´„ ${left} å¤©)`;
    }

    window.updateStaff = async function(date, val) {
        val = val.trim();
        const { data } = await supabase.from('duty_roster').select('*').eq('date', date);
        if(data.length > 0) {
            if(val) await supabase.from('duty_roster').update({staff_name: val}).eq('date', date);
            else await supabase.from('duty_roster').delete().eq('date', date);
        } else if(val) {
            await supabase.from('duty_roster').insert([{date: date, staff_name: val, shift: 'BN'}]);
        }
    }

    window.reloadData = function() {
        if(currentMode==='mobile') fetchWeekData();
        else fetchMonthData();
    }

    window.handleDownload = async function() {
        const cbs = document.querySelectorAll('.date-checkbox:checked');
        if(cbs.length===0) return alert("è«‹å‹¾é¸æ—¥æœŸ");
        showLoading(true);
        const zip = new JSZip();
        const dates = Array.from(cbs).map(c=>c.value);
        const targets = currentRecords.records.filter(r=>dates.includes(r.record_date));
        
        if(targets.length===0) { showLoading(false); return alert("é¸å–çš„æ—¥æœŸç„¡ç…§ç‰‡"); }

        await Promise.all(targets.map(async r => {
            const { data } = await supabase.storage.from('private_photos').download(r.photo_path);
            if(data) zip.file(`${r.record_date}_${r.meal_type}_${r.target_type}.jpg`, data);
        }));
        
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, `ç…§ç‰‡å‚™ä»½_${dates[0]}.zip`);
        showLoading(false);
    }

    window.handleDelete = async function() {
        if(!isAdmin) return alert("æ¬Šé™ä¸è¶³");
        const cbs = document.querySelectorAll('.date-checkbox:checked');
        if(cbs.length===0) return alert("è«‹å‹¾é¸æ—¥æœŸ");
        if(!confirm(`ç¢ºå®šåˆªé™¤ ${cbs.length} å¤©çš„è³‡æ–™å—ï¼Ÿ`)) return;

        showLoading(true);
        const dates = Array.from(cbs).map(c=>c.value);
        const targets = currentRecords.records.filter(r=>dates.includes(r.record_date));
        const paths = targets.map(r=>r.photo_path);
        const ids = targets.map(r=>r.id);

        if(paths.length>0) await supabase.storage.from('private_photos').remove(paths);
        if(ids.length>0) await supabase.from('meal_records').delete().in('id', ids);

        alert("åˆªé™¤æˆåŠŸ");
        reloadData();
        updateGlobalStats();
        showLoading(false);
    }

    let isAllMobile = false;
    window.toggleSelectAllMobile = function() {
        isAllMobile = !isAllMobile;
        document.querySelectorAll('.mobile-only .date-checkbox').forEach(c=>c.checked=isAllMobile);
        document.querySelector('.select-all-btn').innerText = isAllMobile ? "â˜’ å–æ¶ˆ" : "â˜‘ å…¨é¸æœ¬é€±";
    }

    window.viewPhoto = async function(path, cap) {
        showLoading(true);
        const { data } = await supabase.storage.from('private_photos').createSignedUrl(path, 60);
        document.getElementById('modalImg').src = data.signedUrl;
        document.getElementById('caption').innerText = cap;
        document.getElementById('imageModal').style.display = 'flex';
        showLoading(false);
    }

    function showLoading(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
</script>
</body>
</html>
