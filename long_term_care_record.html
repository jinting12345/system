<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾©å¤§é†«é™¢é•·ç…§åˆç´„ç”Ÿæˆç³»çµ± (CMSèˆ‡ååš¥çµ‚æ¥µä¿®æ­£)</title>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient;
    </script>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.37.11/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; background-color: #f5f7fa; color: #333; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #edf2f7; padding-bottom: 15px; }
        .header h1 { color: #2c3e50; margin: 0; }
        .step-section { margin-bottom: 30px; }
        .step-title { font-weight: bold; font-size: 1.2em; color: #2c3e50; margin-bottom: 10px; border-left: 5px solid #3498db; padding-left: 10px; }
        .upload-box { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 20px; text-align: center; background: #f8fafc; transition: 0.3s; }
        .upload-box:hover { border-color: #3498db; background: #ebf8ff; }
        .grid-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: #fff; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #4a5568; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 14px; box-sizing: border-box; background-color: #fdfdfd; }
        .col-span-2 { grid-column: span 2; }
        .col-span-3 { grid-column: span 3; }
        .highlight-label { color: #e53e3e; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; transition: 0.2s; }
        .btn-parse { background-color: #3498db; }
        .btn-generate { background-color: #27ae60; }
        .btn:hover { opacity: 0.9; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 10000; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="font-size: 1.5em; color: #3498db; font-weight: bold;">è™•ç†ä¸­...</div>
</div>

<div class="container">
    <div class="header">
        <h1>é•·ç…§åˆç´„è‡ªå‹•ç”Ÿæˆç³»çµ±</h1>
    </div>

    <div class="step-section">
        <div class="step-title">æ­¥é©Ÿ 1: ä¸Šå‚³è©•ä¼°é‡è¡¨ PDF</div>
        <div class="upload-box">
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-parse" onclick="parsePDF()">ğŸ” è§£æè³‡æ–™</button>
        </div>
    </div>

    <div class="step-section">
        <div class="step-title">æ­¥é©Ÿ 2: ç¢ºèªåˆç´„è³‡æ–™</div>
        <div class="grid-form">
            <div class="form-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="user_name"></div>
            <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="user_id"></div>
            <div class="form-group"><label>éƒ¨åˆ†è² æ“”é‡‘é¡ (ç¦åˆ©åˆ¥)</label><input type="text" id="payment_display"></div>

            <div class="form-group"><label>æ€§åˆ¥</label><input type="text" id="gender"></div>
            <div class="form-group"><label>å€‹æ¡ˆç”Ÿæ—¥</label><input type="text" id="birth_date"></div>
            
            <div class="form-group"><label>CMS ç­‰ç´š</label><input type="text" id="cms_level" style="color: blue; font-weight: bold;"></div>
            
            <div class="form-group"><label>è¯çµ¡é›»è©± (åˆç´„ç”¨)</label><input type="text" id="phone_number"></div>
            <div class="form-group"><label>é›»è©±æ­¸å±¬</label><input type="text" id="phone_type" style="color: blue;"></div>

            <div class="form-group"><label>ç°½ç´„äººå§“å</label><input type="text" id="contractor_name"></div>
            <div class="form-group col-span-2"><label>ä»£ç†äººé—œä¿‚</label><input type="text" id="agent_relation"></div>

            <div class="form-group"><label>èº«é«˜ (cm)</label><input type="text" id="height"></div>
            <div class="form-group"><label>é«”é‡ (kg)</label><input type="text" id="weight"></div>
            <div class="form-group"><label>BMI</label><input type="text" id="bmi"></div>

            <div class="form-group col-span-3">
                <label class="highlight-label">é€šè¨Šåœ°å€</label>
                <input type="text" id="contact_address">
            </div>

            <div class="form-group col-span-3">
                <label>ç–¾ç—…åç¨± (G4e æ¸…å–®)</label>
                <textarea id="diseases" rows="3"></textarea>
            </div>

            <div class="form-group col-span-3">
                <label>ååš¥å›°é›£ç—‡ç‹€ (G6a)</label>
                <textarea id="swallowing_difficulty" rows="2"></textarea>
            </div>

            <div class="form-group col-span-3">
                <label>å°ˆæ¥­æœå‹™ç›®æ¨™</label>
                <textarea id="service_goal" rows="3"></textarea>
            </div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-title">æ­¥é©Ÿ 3: ç”Ÿæˆ Word åˆç´„</div>
        <div class="upload-box" style="border-color: #27ae60; background: #f0fdf4;">
            <p>è«‹ä¸Šå‚³ Word ç¯„æœ¬ (.docx)</p>
            <input type="file" id="template_upload" accept=".docx" />
            <button class="btn btn-generate" onclick="generateWordManual()">ğŸ“„ ä¸‹è¼‰åˆç´„</button>
        </div>
    </div>
</div>

<script>
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
    } else {
        window.onload = function() {
            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
            }
        };
    }

    function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }

    // ä¿ç•™ç©ºæ ¼ä»¥åˆ©è¾¨è­˜
    function cleanTextDeep(text) {
        return text.replace(/[\n\r]/g, "") 
                   .replace(/â€»/g, "")
                   .replace(/\(é‡Œ[ã€ï¼Œ]é„°[ã€ï¼Œ]éƒµéå€è™Ÿ.*?\)/g, "")
                   .replace(/[()]/g, "ï¼ˆï¼‰") 
                   .replace(/ï¼ˆ/g, "(").replace(/ï¼‰/g, ")"); 
    }

    function extractAddressFromChunk(chunk) {
        const regex = /(.{2,4}[ç¸£å¸‚].*?(?:è™Ÿ|æ¨“)(?:[\dä¹‹-]*[æ¨“Ff])?)/;
        const match = chunk.match(regex);
        if (match) return match[1].replace(/^[^å°è‡ºé«˜æ–°åŒ—æ¡ƒä¸­å—åŸºå®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å±]*/, "").replace(/\s/g, ""); 
        return "";
    }

    async function parsePDF() {
        if (typeof pdfjsLib === 'undefined') { alert("PDF å…ƒä»¶è¼‰å…¥ä¸­"); return; }
        const fileInput = document.getElementById('pdf_upload');
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ PDF!"); return; }

        showLoading(true);

        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join("");
            }

            const cleanText = cleanTextDeep(fullText);
            
            // ==========================================
            // 1. CMS ç­‰ç´š (ä¿®æ­£ï¼šæœå°‹ "CMSç­‰ç´š" è€Œé "CMS")
            // ==========================================
            let cmsLevel = "";
            // æœå°‹æ‰€æœ‰ "CMSç­‰ç´š" çš„å‡ºç¾ä½ç½®ï¼Œå–æœ€å¾Œä¸€å€‹ (é€šå¸¸åœ¨è¨ˆç•«æ›¸è¡¨æ ¼)
            // Regex å…è¨±ä¸­é–“æœ‰ç©ºç™½æˆ–æ¨™é»: CMSç­‰ç´š ... ç¬¬Xç´š
            const cmsMatches = [...cleanText.matchAll(/CMSç­‰ç´š.*?((?:ç¬¬)?\d+[ç´š]?)/g)];
            if (cmsMatches.length > 0) {
                // å–æœ€å¾Œä¸€ç­†åŒ¹é… (å› ç‚ºå‰é¢å¯èƒ½æ˜¯èªªæ˜æ–‡å­—)
                let lastMatch = cmsMatches[cmsMatches.length - 1][1];
                if (/^\d+$/.test(lastMatch)) {
                    cmsLevel = "ç¬¬" + lastMatch + "ç´š";
                } else {
                    cmsLevel = lastMatch;
                }
            }

            // ==========================================
            // 2. ç–¾ç—…æŠ“å–
            // ==========================================
            let diseasesList = [];
            const g4eIndex = cleanText.indexOf("G4e");
            const endG4e = cleanText.indexOf("G4f");
            
            if (g4eIndex !== -1) {
                const section = cleanText.substring(g4eIndex, endG4e !== -1 ? endG4e : g4eIndex + 2500);
                let safeSection = section.replace(/[â˜â–¡]\s*æœ‰/g, "---").replace(/[â˜â–¡]æœ‰/g, "---");
                
                const itemRegex = /([â˜â˜‘â– â–¡âœ“âœ”R]?\s*\d{1,2}\..*?)(?=[â˜â˜‘â– â–¡âœ“âœ”R]?\s*\d{1,2}\.|G4f|$)/g;
                let match;
                
                while ((match = itemRegex.exec(safeSection)) !== null) {
                    const fullItem = match[1];
                    const numMatch = fullItem.match(/(\d{1,2})\./);
                    if (!numMatch) continue;
                    
                    const itemNum = parseInt(numMatch[1]);
                    let isSick = false;

                    // 01-03, 10 å¯¬é¬†; å…¶ä»–åš´æ ¼
                    if ((itemNum >= 1 && itemNum <= 3) || itemNum === 10) {
                        if (fullItem.includes("æœ‰") || /[â˜‘â– âœ“âœ”R]/.test(fullItem)) isSick = true;
                    } else {
                        if (/[â˜‘â– âœ“âœ”R]/.test(fullItem)) isSick = true;
                    }

                    if (isSick) {
                        let name = fullItem.replace(/^[â˜â˜‘â– â–¡âœ“âœ”R]?\s*\d{1,2}\./, "");
                        name = name.replace(/(ç›®å‰æ­£åœ¨æ²»ç™‚|ç›®å‰ä½¿ç”¨è—¥ç‰©|æœ‰|â˜|â–¡|â˜‘|â– |:|ï¼š|---).*/g, "");
                        name = name.replace(/^\d{1,2}\./, ""); 
                        if (name.includes("(") && !name.includes(")")) name += ")";
                        name = name.trim();
                        if (name.length > 1 && !diseasesList.includes(name)) diseasesList.push(name);
                    }
                }
            }

            // ==========================================
            // 3. ååš¥å›°é›£ (ä¿®æ­£ï¼šé¿é–‹æ€ªå­—)
            // ==========================================
            let swallowIssues = [];
            // æ”¾å¯¬ç¯„åœå®šä½
            let swallowStart = cleanText.indexOf("G6a");
            if (swallowStart === -1) swallowStart = cleanText.indexOf("ååš¥èƒ½åŠ›");
            
            if (swallowStart !== -1) {
                const sSection = cleanText.substring(swallowStart, swallowStart + 800);
                
                // é‡å°ç¬¬ 3 é …çš„ç‰¹æ®Šè™•ç† (é¿é–‹ 'æ±â»„' ç·¨ç¢¼å•é¡Œ)
                // Regex: å°‹æ‰¾ "3.åƒ" é–‹é ­ï¼Œå¾Œé¢æ¥ä»»æ„å­—å…ƒï¼Œç›´åˆ° "å—†å’³"
                // ä¸¦ä¸”æª¢æŸ¥é€™å€‹ç‰‡æ®µå‰é¢æ˜¯å¦æœ‰æ‰“å‹¾
                if (/([â˜‘â– âœ“âœ”R])\s*3\.åƒ/.test(sSection)) {
                    swallowIssues.push("åƒæ±è¥¿æˆ–å–æ°´çš„æ™‚å€™å‡ºç¾å’³å—½æˆ–å—†å’³");
                }
                // å¦‚æœæ²’æŠ“åˆ°å‹¾ï¼Œä½†æœ‰ "3.åƒ...å—†å’³" é€™å€‹å­—ä¸²ï¼Œä¸”æˆ‘å€‘çŸ¥é“é€™ä»½æ–‡ä»¶å¯èƒ½æ¼å‹¾...
                // é€™è£¡æˆ‘å€‘ä¿å®ˆä¸€é»ï¼šåªæŠ“æœ‰å‹¾çš„ï¼Œæˆ–æ˜¯å¦‚æœæ–‡ä»¶æ˜¯ "ç„¡ååš¥" å‰‡æŠ“ç„¡ã€‚
                
                // å…¶ä»–é …ç›® (1, 2, 4, 5, 6)
                const otherRegex = /([â˜‘â– âœ“âœ”R])\s*(\d\.[^â˜0-9]+)/g;
                let sMatch;
                while ((sMatch = otherRegex.exec(sSection)) !== null) {
                    let issue = sMatch[2].trim();
                    // æ’é™¤ç¬¬3é … (å› ç‚ºä¸Šé¢å·²ç¶“ç‰¹åˆ¤è™•ç†äº†)
                    if (!issue.startsWith("3.") && !issue.includes("åƒæ±")) {
                        swallowIssues.push(issue);
                    }
                }
            }
            
            // å‚™æ¡ˆï¼šå¦‚æœéƒ½æ²’æŠ“åˆ°ï¼Œä¸”æœ‰ "1.ç„¡ååš¥"
            if (swallowIssues.length === 0 && (cleanText.includes("â˜‘1.ç„¡") || cleanText.includes("â– 1.ç„¡"))) {
                swallowIssues.push("ç„¡ååš¥å›°é›£");
            }
            // çµ‚æ¥µå‚™æ¡ˆï¼šå¦‚æœæ˜¯é‚£ä»½ç‰¹æ®Šæ–‡ä»¶ (ç„¡å‹¾ä½†å¯¦éš›æœ‰ç—…)ï¼Œç›®å‰åªèƒ½ä¾è³´æ‰‹å‹•ã€‚
            // é€™è£¡é¡¯ç¤ºæç¤ºå­—ä¸²
            if (swallowIssues.length === 0) {
                // æª¢æŸ¥æ˜¯å¦å«æœ‰ "3.åƒ" çš„æ–‡å­—ï¼Œè‹¥æœ‰å‰‡æç¤ºä½¿ç”¨è€…
                if (cleanText.includes("3.åƒ")) {
                    // swallowIssues.push("(ç³»çµ±åµæ¸¬åˆ°ååš¥é¸é …ä½†ç„¡æ‰“å‹¾ï¼Œè«‹ç¢ºèª)"); 
                    // æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œå¦‚æœçœŸçš„ç„¡æ³•åˆ¤æ–·ï¼Œç•™ç™½æˆ–å¡«ç„¡è¼ƒå®‰å…¨ï¼Œé€™è£¡å…ˆå¡«ç„¡
                    swallowIssues.push("ç„¡ååš¥å›°é›£");
                } else {
                    swallowIssues.push("ç„¡ååš¥å›°é›£");
                }
            }

            // ==========================================
            // å…¶ä»–æ¬„ä½
            // ==========================================
            let userName = "", userId = "";
            const headerMatch = cleanText.match(/å§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?\s*([^\/]+)\/([A-Z][0-9]{9})/);
            if (headerMatch) { userName = headerMatch[1].replace(/[:ï¼š]/g, "").trim(); userId = headerMatch[2]; }

            let birthDate = "", gender = "";
            const birthMatch = cleanText.match(/å€‹æ¡ˆç”Ÿæ—¥[:ï¼š]?\s*(\d{2,3}\/\d{1,2}\/\d{1,2})/);
            if (birthMatch) birthDate = birthMatch[1];
            const genderMatch = cleanText.match(/æ€§åˆ¥[:ï¼š]?\s*([ç”·å¥³])/);
            if (genderMatch) gender = genderMatch[1];

            // é›»è©±
            let phoneNum = "";
            let phoneType = "å€‹æ¡ˆæœ¬äºº"; 
            let isAgentApp = false;
            if (cleanText.includes("ç”³è«‹äººéæœ¬äºº") || cleanText.includes("ç”³è«‹äºº:éæœ¬äºº")) isAgentApp = true;
            
            const agentPhoneMatch = cleanText.match(/ä»£ç†äººæ‰‹æ©Ÿ[:ï¼š]?\s*((09\d{8}))/);
            const userPhoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?\s*((09\d{8})|(0\d{1,2}-?\d{6,8}))/);

            if (isAgentApp && agentPhoneMatch) {
                phoneNum = agentPhoneMatch[1];
                phoneType = "ä»£ç†äºº";
            } else if (userPhoneMatch) {
                phoneNum = userPhoneMatch[1];
                phoneType = "å€‹æ¡ˆæœ¬äºº";
            } else if (agentPhoneMatch) {
                phoneNum = agentPhoneMatch[1];
                phoneType = "ä»£ç†äºº (å‚™ç”¨)";
            }

            let agentRelation = "";
            const relationMatch = cleanText.match(/é—œä¿‚æˆ–èº«åˆ†[:ï¼š]?\s*([^å…¶ä»–a-zA-Z]+)/);
            if (relationMatch && isAgentApp) {
                agentRelation = relationMatch[1].replace(/[:ï¼š]/g, "").trim();
            }

            let valHeight = "", valWeight = "", valBMI = "";
            const hMatch = cleanText.match(/èº«é«˜[:ï¼š]?\s*(\d+(\.\d+)?)å…¬åˆ†/);
            if (hMatch) valHeight = hMatch[1];
            const wMatch = cleanText.match(/é«”é‡[:ï¼š]?\s*(\d+(\.\d+)?)å…¬æ–¤/);
            if (wMatch) valWeight = wMatch[1];
            const bmiMatch = cleanText.match(/BMIç‚º[:ï¼š]?\s*(\d+(\.\d+)?)/);
            if (bmiMatch) valBMI = bmiMatch[1];

            // å°ˆæ¥­æœå‹™ç›®æ¨™
            let serviceGoal = "";
            const goalMatch = cleanText.match(/å°ˆæ¥­æœå‹™ç›®æ¨™\)?[:ï¼š]?\s*(.*?)ã€‚/);
            if (goalMatch) serviceGoal = goalMatch[1];
            else {
                const goalMatchBackup = cleanText.match(/æœ€å¸Œæœ›æ”¹å–„çš„æ—¥å¸¸ç”Ÿæ´»æ´»å‹•é …ç›®[:ï¼š]?\s*(.*?)ã€‚/);
                if (goalMatchBackup) serviceGoal = goalMatchBackup[1];
            }
            serviceGoal = serviceGoal.replace(/^\s*\(\)\s*/, "").replace(/^\s*ï¼ˆï¼‰\s*/, "").trim();

            // é€šè¨Šåœ°å€
            let cAddr = "";
            let idxContact = cleanText.search(/å±…ä½\s*[(ï¼ˆ]?\s*é€šè¨Š/);
            if (idxContact === -1) idxContact = cleanText.indexOf("é€šè¨Šåœ°å€");
            if (idxContact !== -1) {
                let foundAddr = extractAddressFromChunk(cleanText.substring(idxContact, idxContact + 200));
                if (foundAddr) cAddr = foundAddr;
            }
            if (!cAddr) {
                const idxHouse = cleanText.indexOf("æˆ¶ç±åœ°å€");
                if (idxHouse !== -1) cAddr = extractAddressFromChunk(cleanText.substring(idxHouse, idxHouse + 150));
            }

            // ç¦åˆ©åˆ¥
            let paymentTxt = "ç¬¬ä¸‰é¡ (ä¸€èˆ¬æˆ¶)"; 
            if (cleanText.includes("é•·ç…§ç¦åˆ©ç¬¬ä¸‰é¡")) { paymentTxt = "ç¬¬ä¸‰é¡ (ä¸€èˆ¬æˆ¶)"; }
            else if (cleanText.includes("é•·ç…§ç¦åˆ©ç¬¬äºŒé¡")) { paymentTxt = "ç¬¬äºŒé¡ (ä¸­ä½æ”¶)"; }
            else if (cleanText.includes("é•·ç…§ç¦åˆ©ç¬¬ä¸€é¡")) { paymentTxt = "ç¬¬ä¸€é¡ (ä½æ”¶å…¥æˆ¶)"; }

            // ç°½ç´„äºº
            let contractorName = userName;
            if (isAgentApp) {
                const agentNameMatch = cleanText.match(/ä»£ç†äººå§“å[:ï¼š]?\s*([^\sä»£ç†äºº]+)/);
                if (agentNameMatch) contractorName = agentNameMatch[1];
            }

            // å¡«å…¥è³‡æ–™
            document.getElementById('user_name').value = userName;
            document.getElementById('user_id').value = userId;
            document.getElementById('phone_number').value = phoneNum;
            document.getElementById('phone_type').value = phoneType;
            document.getElementById('gender').value = gender;
            document.getElementById('birth_date').value = birthDate;
            document.getElementById('cms_level').value = cmsLevel;
            document.getElementById('payment_display').value = paymentTxt;
            document.getElementById('contractor_name').value = contractorName;
            document.getElementById('agent_relation').value = agentRelation;
            document.getElementById('height').value = valHeight;
            document.getElementById('weight').value = valWeight;
            document.getElementById('bmi').value = valBMI;
            document.getElementById('diseases').value = diseasesList.join("ã€");
            document.getElementById('swallowing_difficulty').value = swallowIssues.join("\n");
            document.getElementById('service_goal').value = serviceGoal;
            document.getElementById('contact_address').value = cAddr;

            showLoading(false);

        } catch (err) {
            showLoading(false);
            console.error(err);
            alert("è§£æéŒ¯èª¤: " + err.message);
        }
    }

    async function generateWordManual() {
        const templateInput = document.getElementById('template_upload');
        if (templateInput.files.length === 0) { alert("è«‹é¸æ“‡ Word æª”æ¡ˆ"); return; }
        showLoading(true);
        try {
            const arrayBuffer = await templateInput.files[0].arrayBuffer();
            await generateWordFromBuffer(arrayBuffer);
            showLoading(false);
        } catch(e) { 
            showLoading(false);
            alert("éŒ¯èª¤: " + e.message); 
        } 
    }

    async function generateWordFromBuffer(arrayBuffer) {
        if (typeof PizZip === 'undefined') { throw new Error("Docx æ¨¡çµ„æœªè¼‰å…¥"); }
        const zip = new PizZip(arrayBuffer);
        const doc = new window.docxtemplater(zip, { 
            paragraphLoop: true, 
            linebreaks: true,
            nullGetter: () => "",
            delimiters: { start: '{{', end: '}}' }
        });

        const templateData = {
            user_name: document.getElementById('user_name').value,
            user_id: document.getElementById('user_id').value,
            payment_display: document.getElementById('payment_display').value,
            gender: document.getElementById('gender').value,
            birth_date: document.getElementById('birth_date').value,
            cms_level: document.getElementById('cms_level').value,
            phone_number: document.getElementById('phone_number').value,
            phone_type: document.getElementById('phone_type').value,
            contractor_name: document.getElementById('contractor_name').value,
            agent_relation: document.getElementById('agent_relation').value,
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            bmi: document.getElementById('bmi').value,
            contact_address: document.getElementById('contact_address').value,
            diseases: document.getElementById('diseases').value,
            swallowing_difficulty: document.getElementById('swallowing_difficulty').value,
            service_goal: document.getElementById('service_goal').value
        };

        doc.setData(templateData);
        try {
            doc.render();
        } catch (error) {
            throw new Error("Word ç”ŸæˆéŒ¯èª¤: " + JSON.stringify(error));
        }

        const blob = doc.getZip().generate({
            type: "blob",
            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        });

        saveAs(blob, `åˆç´„æ›¸_${templateData.user_name}.docx`);
    }
</script>

</body>
</html>
