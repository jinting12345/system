<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§ç´€éŒ„è‡ªå‹•ç”Ÿæˆç³»çµ± (V2 ä¿®æ­£ç‰ˆ)</title>
    
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
        window.createClient = createClient;
    </script>
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://unpkg.com/docxtemplater@3.37.11/build/docxtemplater.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f5f7fa; color: #333; }
        .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-link { text-decoration: none; color: #666; font-weight: bold; font-size: 1.1em; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: color 0.2s; }
        .back-link:hover { color: #333; }
        .logout-btn { background-color: #dc3545; color: white; border: none; padding: 8px 20px; border-radius: 4px; font-size: 1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        
        .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #edf2f7; padding-bottom: 20px; }
        .header h1 { color: #2c3e50; margin: 0; font-size: 2em; }
        
        .step-section { margin-bottom: 30px; }
        .step-header { display: flex; align-items: center; margin-bottom: 15px; }
        .step-number { background: #3498db; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
        .step-title { font-weight: bold; font-size: 1.2em; color: #2c3e50; }

        .upload-box { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center; background: #f8fafc; transition: 0.3s; }
        .upload-box:hover { border-color: #3498db; background: #ebf8ff; }

        .grid-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: #fff; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #4a5568; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 14px; box-sizing: border-box; background-color: #fdfdfd; }
        .col-span-2 { grid-column: span 2; }
        .col-span-3 { grid-column: span 3; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; margin-top: 15px; }
        .btn-parse { background-color: #3498db; }
        .btn-generate { background-color: #27ae60; }
        .btn:disabled { background-color: #a0aec0; cursor: not-allowed; }

        /* ç™»å…¥è¦–çª— */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }

        /* è®€å–é®ç½© */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 10000; flex-direction: column; }
        #loading-text { font-size: 1.5em; color: #3498db; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div id="loading-text">è™•ç†ä¸­...</div>
    <div style="color:#666">è«‹ç¨å€™</div>
</div>

<div id="login-modal">
    <div class="login-box">
        <h2>ç³»çµ±ç™»å…¥</h2>
        <p>è«‹å…ˆç™»å…¥ä»¥å–å¾—å®‰å…¨ç¯„æœ¬</p>
        <div style="margin-bottom: 15px;">
            <input type="email" id="email" placeholder="Email" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <input type="password" id="password" placeholder="å¯†ç¢¼" style="width: 100%; padding: 8px;">
        </div>
        <button onclick="handleLogin()" class="btn btn-parse">ç™»å…¥</button>
        <p id="login-msg" style="color: red; margin-top: 10px; font-size: 0.9em;"></p>
    </div>
</div>

<div class="container">
    <div class="top-nav">
        <a href="menu.html" class="back-link"><span>â¬…</span> å›é¸å–®</a>
        <button onclick="handleLogout()" class="logout-btn">ç™»å‡º</button>
    </div>

    <div class="header">
        <h1>é•·ç…§ç´€éŒ„ç´™æœ¬ç™»æ‰“ (è‡ªå‹•ç”Ÿæˆ)</h1>
        <p id="user-status" style="font-size: 0.8em; color: #27ae60;"></p>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">1</div>
            <div class="step-title">ä¸Šå‚³è©•ä¼°é‡è¡¨ PDF</div>
        </div>
        <div class="upload-box">
            <input type="file" id="pdf_upload" accept="application/pdf" />
            <button class="btn btn-parse" onclick="parsePDF()">ğŸ” è§£æè³‡æ–™</button>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">2</div>
            <div class="step-title">ç¢ºèªè³‡æ–™ (ä¾›ç´€éŒ„è¡¨ä½¿ç”¨)</div>
        </div>
        <div class="grid-form">
            <div class="form-group"><label>å€‹æ¡ˆå§“å</label><input type="text" id="user_name"></div>
            <div class="form-group"><label>èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="user_id"></div>
            <div class="form-group"><label>æ€§åˆ¥</label><input type="text" id="gender"></div>
            
            <div class="form-group"><label>å€‹æ¡ˆç”Ÿæ—¥</label><input type="text" id="birth_date"></div>
            <div class="form-group"><label>CMS ç­‰ç´š</label><input type="text" id="cms_level"></div>
            <div class="form-group"><label>éƒ¨åˆ†è² æ“”</label><input type="text" id="payment_display"></div>

            <div class="form-group"><label>èº«é«˜ (cm)</label><input type="text" id="height"></div>
            <div class="form-group"><label>é«”é‡ (kg)</label><input type="text" id="weight"></div>
            <div class="form-group"><label>BMI</label><input type="text" id="bmi"></div>

            <div class="form-group"><label>ä¸»è¦è¯çµ¡äºº</label><input type="text" id="contractor_name"></div>
            <div class="form-group"><label>è¯çµ¡é›»è©±</label><input type="text" id="phone_number"></div>
            <div class="form-group"><label>é—œä¿‚</label><input type="text" id="agent_relation"></div>
            <input type="hidden" id="phone_type"> 

            <div class="form-group col-span-3">
                <label>å±…ä½/é€šè¨Šåœ°å€</label>
                <input type="text" id="contact_address">
            </div>

            <div class="form-group col-span-3">
                <label>ç–¾ç—…åˆ—è¡¨</label>
                <textarea id="diseases" rows="3"></textarea>
            </div>

            <div class="form-group col-span-3">
                <label>æœå‹™ç›®æ¨™</label>
                <textarea id="service_goal" rows="2"></textarea>
            </div>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header">
            <div class="step-number">3</div>
            <div class="step-title">ç”Ÿæˆé•·ç…§ç´€éŒ„ Word</div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <label style="flex: 1; cursor: pointer;">
                <input type="radio" name="template_mode" value="auto" checked onchange="switchTemplateMode()">
                <span style="margin-left: 8px; font-weight: bold;">ğŸ”’ è‡ªå‹•æ¨¡å¼ (ä½¿ç”¨ç³»çµ±ç¯„æœ¬)</span>
            </label>
            <label style="flex: 1; cursor: pointer;">
                <input type="radio" name="template_mode" value="manual" onchange="switchTemplateMode()">
                <span style="margin-left: 8px; font-weight: bold;">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³æ¨¡å¼</span>
            </label>
        </div>

        <div id="auto_mode_box" class="upload-box" style="border-color: #27ae60; background: #f0fdf4;">
            <p style="color: #27ae60; font-weight: bold;">âœ… å°‡ä½¿ç”¨ç³»çµ±å…§å»ºçš„ç´€éŒ„ç¯„æœ¬</p>
            <button class="btn btn-generate" onclick="generateRecordAuto()">ğŸ“„ ä¸‹è¼‰ç´€éŒ„è¡¨ (è‡ªå‹•æ¨¡å¼)</button>
        </div>

        <div id="manual_mode_box" class="upload-box" style="display: none; border-color: #3498db; background: #ebf8ff;">
            <p style="color: #3498db; font-weight: bold;">è«‹é¸æ“‡ Word ç´€éŒ„ç¯„æœ¬ (.docx)</p>
            <input type="file" id="manual_template_upload" accept=".docx" />
            <button class="btn btn-generate" style="background-color: #3498db;" onclick="generateRecordManual()">ğŸ“„ ä¸‹è¼‰ç´€éŒ„è¡¨ (æ‰‹å‹•æ¨¡å¼)</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://oipnjnwootorawargsxe.supabase.co';
    const RAW_KEY = 'sb_publishable_3KbpnkaYl5CxJufjrLKlAQ_0-nzCIII';
    const SUPABASE_KEY = RAW_KEY.trim();

    // ğŸŒŸ è¨­å®šæª”å (ä¸å«è·¯å¾‘ï¼Œæˆ‘å€‘æœƒè‡ªå‹•æœå°‹)
    const BUCKET_NAME = 'system_files'; 
    const TARGET_FILE_NAME = 'record_template.docx';

    let supabase = null;

    // åˆå§‹åŒ–
    window.onload = function() {
        showLoading(true, "ç³»çµ±åˆå§‹åŒ–ä¸­...");
        setTimeout(() => {
            try {
                if (window.createClient) {
                    supabase = window.createClient(SUPABASE_URL, SUPABASE_KEY);
                    checkSession();
                } else {
                    throw new Error("Supabase å…ƒä»¶è¼‰å…¥å¤±æ•—");
                }
            } catch (e) {
                showLoading(false);
                alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
            }
            showLoading(false);
        }, 500);
    };

    function showLoading(show, text) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        if(text) document.getElementById('loading-text').innerText = text;
    }

    // ============================================
    // Auth é‚è¼¯
    // ============================================
    async function handleLogin() {
        if (!supabase) return;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const msg = document.getElementById('login-msg');

        if(!email || !password) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        
        msg.innerText = "é©—è­‰ä¸­...";
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
            msg.innerText = "ç™»å…¥å¤±æ•—: " + error.message;
        } else {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('user-status').innerText = `ç›®å‰ä½¿ç”¨è€…: ${data.user.email}`;
        }
    }

    async function handleLogout() {
        if (!supabase) return;
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
            await supabase.auth.signOut();
            location.reload(); 
        }
    }

    async function checkSession() {
        if (!supabase) return;
        const { data } = await supabase.auth.getSession();
        if (data.session) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('user-status').innerText = `ç›®å‰ä½¿ç”¨è€…: ${data.session.user.email}`;
        } else {
            document.getElementById('login-modal').style.display = 'flex';
        }
    }

    // ============================================
    // æ¨¡æ¿ä¸‹è¼‰èˆ‡ç”Ÿæˆé‚è¼¯ (æ ¸å¿ƒä¿®æ­£å€)
    // ============================================
    function switchTemplateMode() {
        const mode = document.querySelector('input[name="template_mode"]:checked').value;
        document.getElementById('auto_mode_box').style.display = mode === 'auto' ? 'block' : 'none';
        document.getElementById('manual_mode_box').style.display = mode === 'manual' ? 'block' : 'none';
    }

    // ğŸŒŸ æ–°å¢ï¼šè‡ªå‹•æœå°‹æ­£ç¢ºçš„è·¯å¾‘
    async function findAndDownloadTemplate() {
        // 1. å˜—è©¦åˆ—å‡º templates è³‡æ–™å¤¾å…§çš„æª”æ¡ˆ
        const { data: listData, error: listError } = await supabase.storage
            .from(BUCKET_NAME)
            .list('templates');

        if (listError) {
            throw new Error(`ç„¡æ³•è®€å–è³‡æ–™å¤¾åˆ—è¡¨: ${listError.message} (è«‹æª¢æŸ¥ Policies)`);
        }

        // 2. åœ¨åˆ—è¡¨ä¸­å°‹æ‰¾ç›®æ¨™æª”æ¡ˆ
        const foundFile = listData.find(f => f.name === TARGET_FILE_NAME);
        
        if (!foundFile) {
            // å¦‚æœåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…æ‰¾ä¸åˆ°æª”æ¡ˆï¼Œé€™é€šå¸¸ä»£è¡¨ã€Œæ¬Šé™ä¸è¶³ã€
            // å› ç‚ºå¦‚æœæ¬Šé™ä¸è¶³ï¼ŒSupabase æœ‰æ™‚æœƒå›å‚³ç©ºåˆ—è¡¨è€Œä¸æ˜¯éŒ¯èª¤
            if (listData.length === 0) {
                 throw new Error(`æ¬Šé™ä¸è¶³ï¼šç³»çµ±åœ¨ templates è³‡æ–™å¤¾å…§çœ‹ä¸åˆ°ä»»ä½•æª”æ¡ˆã€‚\nè«‹è‡³ Supabase > Storage > Policies æª¢æŸ¥æ¬Šé™æ˜¯å¦é–‹æ”¾çµ¦ authenticated usersã€‚`);
            }
            throw new Error(`æ‰¾ä¸åˆ°æª”æ¡ˆï¼š${TARGET_FILE_NAME}\nç›®å‰è³‡æ–™å¤¾å…§åªæœ‰ï¼š${listData.map(f=>f.name).join(", ")}`);
        }

        // 3. æ‰¾åˆ°æª”æ¡ˆäº†ï¼Œä½¿ç”¨æ­£ç¢ºè·¯å¾‘ä¸‹è¼‰
        const correctPath = `templates/${foundFile.name}`;
        console.log("æ‰¾åˆ°æª”æ¡ˆè·¯å¾‘:", correctPath);

        const { data, error } = await supabase.storage
            .from(BUCKET_NAME)
            .download(correctPath);

        if (error) throw error;
        return await data.arrayBuffer();
    }

    async function generateRecordAuto() {
        showLoading(true, "æ­£åœ¨å¾é›²ç«¯æœå°‹æ¨¡æ¿...");
        try {
            const arrayBuffer = await findAndDownloadTemplate();
            
            showLoading(true, "ç”Ÿæˆç´€éŒ„è¡¨ä¸­...");
            await createWord(arrayBuffer, "é•·ç…§ç´€éŒ„_è‡ªå‹•");
            showLoading(false);
        } catch (error) {
            showLoading(false);
            console.error(error);
            alert("âŒ ä¸‹è¼‰å¤±æ•—ï¼\n" + error.message);
        }
    }

    async function generateRecordManual() {
        const fileInput = document.getElementById('manual_template_upload');
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ Word æª”æ¡ˆ"); return; }
        
        showLoading(true, "è™•ç†ä¸­...");
        try {
            const arrayBuffer = await fileInput.files[0].arrayBuffer();
            await createWord(arrayBuffer, "é•·ç…§ç´€éŒ„_æ‰‹å‹•");
            showLoading(false);
        } catch(e) {
            showLoading(false);
            alert("è®€å–æª”æ¡ˆå¤±æ•—: " + e.message);
        }
    }

    // ============================================
    // å…±ç”¨ Word ç”Ÿæˆå‡½æ•¸
    // ============================================
    async function createWord(buffer, prefix) {
        const zip = new PizZip(buffer);
        const doc = new window.docxtemplater(zip, { 
            paragraphLoop: true, 
            linebreaks: true,
            nullGetter: () => ""
        });

        const templateData = {
            user_name: document.getElementById('user_name').value,
            user_id: document.getElementById('user_id').value,
            payment_display: document.getElementById('payment_display').value,
            gender: document.getElementById('gender').value,
            birth_date: document.getElementById('birth_date').value,
            cms_level: document.getElementById('cms_level').value,
            phone_number: document.getElementById('phone_number').value,
            phone_type: document.getElementById('phone_type').value,
            contractor_name: document.getElementById('contractor_name').value,
            agent_relation: document.getElementById('agent_relation').value,
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            bmi: document.getElementById('bmi').value,
            contact_address: document.getElementById('contact_address').value,
            diseases: document.getElementById('diseases').value,
            service_goal: document.getElementById('service_goal').value,
            today: new Date().toLocaleDateString('zh-TW')
        };

        doc.setData(templateData);
        doc.render();

        const blob = doc.getZip().generate({
            type: "blob",
            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        });

        saveAs(blob, `${prefix}_${templateData.user_name}.docx`);
    }

    // ============================================
    // PDF è§£æé‚è¼¯
    // ============================================
    function cleanTextDeep(text) {
        return text.replace(/[\n\r]/g, "") 
                   .replace(/â€»/g, "")
                   .replace(/\(é‡Œ[ã€ï¼Œ]é„°[ã€ï¼Œ]éƒµéå€è™Ÿ.*?\)/g, "")
                   .replace(/[ï¼ˆ]/g, "(").replace(/[ï¼‰]/g, ")");
    }

    function extractAddressFromChunk(chunk) {
        const regex = /(.{2,4}[ç¸£å¸‚].*?(?:è™Ÿ|æ¨“)(?:[\dä¹‹-]*[æ¨“Ff])?)/;
        const match = chunk.match(regex);
        if (match) return match[1].replace(/^[^å°è‡ºé«˜æ–°åŒ—æ¡ƒä¸­å—åŸºå®œèŠ±æ±æ¾é‡‘é€£è‹—å½°é›²å˜‰å±]*/, "").replace(/\s/g, ""); 
        return "";
    }

    async function parsePDF() {
        if (typeof pdfjsLib === 'undefined') { alert("PDF å…ƒä»¶è¼‰å…¥ä¸­"); return; }
        const fileInput = document.getElementById('pdf_upload');
        if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ PDF!"); return; }

        showLoading(true, "è§£æ PDF ä¸­...");

        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;

            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join("");
            }

            fullText = fullText.normalize('NFKC');
            const cleanText = cleanTextDeep(fullText);
            
            // 1. åŸºæœ¬è³‡æ–™
            let userName = "", userId = "";
            const headerMatch = cleanText.match(/å§“å\/èº«åˆ†è­‰å­—è™Ÿ[:ï¼š]?\s*([^\/]+)\/([A-Z][0-9]{9})/);
            if (headerMatch) { userName = headerMatch[1].trim(); userId = headerMatch[2]; }

            let birthDate = "", gender = "";
            const birthMatch = cleanText.match(/å€‹æ¡ˆç”Ÿæ—¥[:ï¼š]?\s*(\d{2,3}\/\d{1,2}\/\d{1,2})/);
            if (birthMatch) birthDate = birthMatch[1];
            const genderMatch = cleanText.match(/æ€§åˆ¥[:ï¼š]?\s*([ç”·å¥³])/);
            if (genderMatch) gender = genderMatch[1];

            // 2. ä»£ç†äººèˆ‡é›»è©±
            let phoneNum = "", phoneType = "å€‹æ¡ˆæœ¬äºº", contractorName = userName, agentRelation = "";
            const agentNameMatch = cleanText.match(/ä»£ç†äººå§“å[:ï¼š]?\s*([^\s:ï¼š,ï¼Œ"\[\]]+)/);
            
            if (agentNameMatch && agentNameMatch[1].length > 1 && agentNameMatch[1] !== "ç„¡") {
                contractorName = agentNameMatch[1].trim();
                phoneType = "ä»£ç†äºº";
                const agentPhoneMatch = cleanText.match(/ä»£ç†äººæ‰‹æ©Ÿ[:ï¼š]?\s*((09\d{8}))/);
                if (agentPhoneMatch) phoneNum = agentPhoneMatch[1];

                const relMatch = cleanText.match(/é—œä¿‚æˆ–èº«åˆ†[:ï¼š]?\s*([^\s:ï¼š0-9,ï¼Œ"\[\]]+)/);
                if (relMatch) {
                    let rel = relMatch[1].trim();
                    if (!rel.includes("è­‰") && !rel.includes("æ‰‹æ©Ÿ")) {
                        if (rel.includes("å…¶ä»–")) rel = rel.split("å…¶ä»–")[0];
                        agentRelation = rel;
                    }
                }
            } else {
                const userPhoneMatch = cleanText.match(/å€‹æ¡ˆé›»è©±.*?\s*((09\d{8})|(0\d{1,2}-?\d{6,8}))/);
                if (userPhoneMatch) phoneNum = userPhoneMatch[1];
            }

            // 3. CMS
            let cmsLevel = "";
            const lastCmsIndex = cleanText.lastIndexOf("CMSç­‰ç´š");
            if (lastCmsIndex !== -1) {
                const chunk = cleanText.substring(lastCmsIndex, lastCmsIndex + 200);
                const match = chunk.match(/ç¬¬\s*(\d+)\s*ç´š/);
                if (match) cmsLevel = "ç¬¬" + match[1] + "ç´š";
            }

            // 4. ç–¾ç—…
            let diseasesList = [];
            const g4eIndex = cleanText.indexOf("G4e");
            const endG4e = cleanText.indexOf("G4f");
            
            if (g4eIndex !== -1) {
                const section = cleanText.substring(g4eIndex, endG4e !== -1 ? endG4e : g4eIndex + 2500);
                let safeSection = section.replace(/[â˜â–¡]\s*æœ‰/g, "---").replace(/[â˜â–¡]æœ‰/g, "---");
                
                const itemRegex = /([â˜â˜‘â– â–¡âœ“âœ”R]?\s*\d{1,2}\..*?)(?=[â˜â˜‘â– â–¡âœ“âœ”R]?\s*\d{1,2}\.|G4f|$)/g;
                let match;
                
                while ((match = itemRegex.exec(safeSection)) !== null) {
                    const fullItem = match[1];
                    const numMatch = fullItem.match(/(\d{1,2})\./);
                    if (!numMatch) continue;
                    const itemNum = parseInt(numMatch[1]);
                    let isSick = false;

                    if ([1, 2, 3, 10].includes(itemNum)) {
                        if (fullItem.includes("æœ‰") || /[â˜‘â– âœ“âœ”R]/.test(fullItem)) isSick = true;
                    } else {
                        if (/[â˜‘â– âœ“âœ”R]/.test(fullItem)) isSick = true;
                    }

                    if (isSick) {
                        let name = fullItem.replace(/^[â˜â˜‘â– â–¡âœ“âœ”R]?\s*\d{1,2}\./, "");
                        name = name.replace(/(ç›®å‰æ­£åœ¨æ²»ç™‚|ç›®å‰ä½¿ç”¨è—¥ç‰©|æœ‰|â˜|â–¡|â˜‘|â– |:|ï¼š|---).*/g, "");
                        name = name.replace(/^\d{1,2}\./, "").trim(); 
                        if (name.includes("(") && !name.includes(")")) name += ")";
                        if (name.length > 1 && !diseasesList.includes(name)) diseasesList.push(name);
                    }
                }
            }

            // 5. é«”ä½èˆ‡å…¶ä»–
            let valHeight = "", valWeight = "", valBMI = "";
            const hMatch = cleanText.match(/èº«é«˜[:ï¼š]?\s*(\d+(\.\d+)?)å…¬åˆ†/);
            if (hMatch) valHeight = hMatch[1];
            const wMatch = cleanText.match(/é«”é‡[:ï¼š]?\s*(\d+(\.\d+)?)å…¬æ–¤/);
            if (wMatch) valWeight = wMatch[1];
            const bmiMatch = cleanText.match(/BMIç‚º[:ï¼š]?\s*(\d+(\.\d+)?)/);
            if (bmiMatch) valBMI = bmiMatch[1];

            let serviceGoal = "";
            const goalMatch = cleanText.match(/å°ˆæ¥­æœå‹™ç›®æ¨™\)?[:ï¼š]?\s*(.*?)ã€‚/);
            if (goalMatch) serviceGoal = goalMatch[1];
            else {
                const goalMatchBackup = cleanText.match(/æœ€å¸Œæœ›æ”¹å–„çš„æ—¥å¸¸ç”Ÿæ´»æ´»å‹•é …ç›®[:ï¼š]?\s*(.*?)ã€‚/);
                if (goalMatchBackup) serviceGoal = goalMatchBackup[1];
            }
            serviceGoal = serviceGoal.replace(/^\s*\(\)\s*/, "").replace(/^\s*ï¼ˆï¼‰\s*/, "").trim();

            let paymentTxt = "ç¬¬ä¸‰é¡ (ä¸€èˆ¬æˆ¶)"; 
            if (cleanText.includes("é•·ç…§ç¦åˆ©ç¬¬ä¸‰é¡")) { paymentTxt = "ç¬¬ä¸‰é¡"; }
            else if (cleanText.includes("é•·ç…§ç¦åˆ©ç¬¬äºŒé¡")) { paymentTxt = "ç¬¬äºŒé¡"; }
            else if (cleanText.includes("é•·ç…§ç¦åˆ©ç¬¬ä¸€é¡")) { paymentTxt = "ç¬¬ä¸€é¡"; }

            let cAddr = "";
            let idxContact = cleanText.search(/å±…ä½\s*[(ï¼ˆ]?\s*é€šè¨Š/);
            if (idxContact === -1) idxContact = cleanText.indexOf("é€šè¨Šåœ°å€");
            if (idxContact !== -1) {
                let foundAddr = extractAddressFromChunk(cleanText.substring(idxContact, idxContact + 300));
                if (foundAddr) cAddr = foundAddr;
            }
            if (!cAddr) {
                const idxHouse = cleanText.indexOf("æˆ¶ç±åœ°å€");
                if (idxHouse !== -1) cAddr = extractAddressFromChunk(cleanText.substring(idxHouse, idxHouse + 200));
            }

            // å¡«å…¥ UI
            document.getElementById('user_name').value = userName;
            document.getElementById('user_id').value = userId;
            document.getElementById('phone_number').value = phoneNum;
            document.getElementById('phone_type').value = phoneType;
            document.getElementById('gender').value = gender;
            document.getElementById('birth_date').value = birthDate;
            document.getElementById('cms_level').value = cmsLevel;
            document.getElementById('payment_display').value = paymentTxt;
            document.getElementById('contractor_name').value = contractorName;
            document.getElementById('agent_relation').value = agentRelation;
            document.getElementById('height').value = valHeight;
            document.getElementById('weight').value = valWeight;
            document.getElementById('bmi').value = valBMI;
            document.getElementById('diseases').value = diseasesList.join("ã€");
            document.getElementById('service_goal').value = serviceGoal;
            document.getElementById('contact_address').value = cAddr;

            showLoading(false);

        } catch (err) {
            showLoading(false);
            console.error(err);
            alert("è§£æéŒ¯èª¤: " + err.message);
        }
    }
</script>

</body>
</html>
